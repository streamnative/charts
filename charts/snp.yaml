---
# Source: sn-platform/templates/detector/pulsar-detector-pdb.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: policy/v1beta1
kind: PodDisruptionBudget
metadata:
  name: "release-name-sn-platform-pulsar-detector"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: pulsar-detector
spec:
  selector:
    matchLabels:
      app: sn-platform
      release: release-name
      component: pulsar-detector
  maxUnavailable: 1
---
# Source: sn-platform/templates/bookkeeper/bookkeeper-service-account.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: release-name-sn-platform-bookie-acct
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: bookie
  annotations:
---
# Source: sn-platform/templates/broker/broker-service-account.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: release-name-sn-platform-broker-acct
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: broker
  annotations:
---
# Source: sn-platform/templates/detector/pulsar-detector-service-account.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: release-name-sn-platform-pulsar-detector-acct
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: pulsar-detector
  annotations:
---
# Source: sn-platform/templates/prometheus/pulsar-operators-rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: release-name-sn-platform-pulsar-operator
  namespace: snp
---
# Source: sn-platform/templates/proxy/proxy-service-account.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: release-name-sn-platform-proxy-acct
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: proxy
  annotations:
---
# Source: sn-platform/templates/streamnative-console/streamnative-console-service-account.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: release-name-sn-platform-streamnative-console-acct
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: streamnative-console
  annotations:
---
# Source: sn-platform/templates/toolset/toolset-serviceaccount.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: release-name-sn-platform-toolset-acct
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: toolset
---
# Source: sn-platform/templates/vault/vault-service-account.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
kind: ServiceAccount
apiVersion: v1
metadata:
  name: release-name-sn-platform-vault-acct
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
---
# Source: sn-platform/templates/zookeeper/zookeeper-backup-serviceaccount.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: release-name-sn-platform-backup-acct
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: backup
  annotations:
---
# Source: sn-platform/templates/zookeeper/zookeeper-restore-serviceaccount.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: release-name-sn-platform-restore-acct
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: restore
  annotations:
---
# Source: sn-platform/templates/zookeeper/zookeeper-service-account.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: release-name-sn-platform-zookeeper-acct
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: zookeeper
  annotations:
---
# Source: sn-platform/templates/grafana/grafana-admin-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: Secret
metadata:
  name: "release-name-sn-platform-grafana-secret"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: grafana
type: Opaque
stringData:
  GRAFANA_ADMIN_PASSWORD: pulsar
  GRAFANA_ADMIN_USER: pulsar
---
# Source: sn-platform/templates/vault/vault-public-key-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: Secret
data:
  publicKey: ""
metadata:
  name: release-name-sn-platform-vault-public-key
  namespace: snp
type: Opaque
---
# Source: sn-platform/templates/alert-manager/alertmanager-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ConfigMap
metadata:
  name: "release-name-sn-platform-alert-manager"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: alert-manager
data:
  # For more configuration about the alert manager, please refer to https://prometheus.io/docs/alerting/configuration/
  alertmanager.yml: |
    global:
      resolve_timeout: 1m
    receivers:
    - name: pagerduty-notifications
      pagerduty_configs:
      - send_resolved: true
        service_key: '[PAGER DUTRY SERVICE KEY]'
    route:
      group_interval: 1m
      receiver: pagerduty-notifications
      repeat_interval: 10m
---
# Source: sn-platform/templates/broker/broker-configmap-functionmesh.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: release-name-builtin-connectors
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: vault
data:
  connectors.yaml: "#\n# Licensed to the Apache Software Foundation (ASF) under one\n#
    or more contributor license agreements.  See the NOTICE file\n# distributed with
    this work for additional information\n# regarding copyright ownership.  The ASF
    licenses this file\n# to you under the Apache License, Version 2.0 (the\n# \"License\");
    you may not use this file except in compliance\n# with the License.  You may obtain
    a copy of the License at\n#\n#   http://www.apache.org/licenses/LICENSE-2.0\n#\n#
    Unless required by applicable law or agreed to in writing,\n# software distributed
    under the License is distributed on an\n# \"AS IS\" BASIS, WITHOUT WARRANTIES OR
    CONDITIONS OF ANY\n# KIND, either express or implied.  See the License for the\n#
    specific language governing permissions and limitations\n# under the License.\n#\n-
    id: pulsar-io-data-generator\n  name: data-generator\n  description: Test data generator
    connector\n  sourceClass: org.apache.pulsar.io.datagenerator.DataGeneratorSource\n
    \ sourceConfigClass: org.apache.pulsar.io.datagenerator.DataGeneratorSourceConfig\n
    \ sinkClass: org.apache.pulsar.io.datagenerator.DataGeneratorPrintSink\n  imageRepository:
    streamnative/pulsar-io-data-generator\n  version: 2.9.2.17\n  imageTag: 2.9.2.17\n
    \ typeClassName: org.apache.pulsar.io.datagenerator.Person\n- id: pulsar-io-kinesis\n
    \ name: kinesis\n  description: Kinesis connectors\n  sinkClass: org.apache.pulsar.io.kinesis.KinesisSink\n
    \ sourceClass: org.apache.pulsar.io.kinesis.KinesisSource\n  sourceConfigClass:
    org.apache.pulsar.io.kinesis.KinesisSourceConfig\n  sinkConfigClass: org.apache.pulsar.io.kinesis.KinesisSinkConfig\n
    \ imageRepository: streamnative/pulsar-io-kinesis\n  version: 2.9.2.17\n  imageTag:
    2.9.2.17\n- id: pulsar-io-sqs\n  name: sqs\n  description: SQS connectors\n  imageRepository:
    streamnative/pulsar-io-sqs\n  sourceClass: org.apache.pulsar.ecosystem.io.sqs.SQSSource\n
    \ sourceConfigClass: org.apache.pulsar.ecosystem.io.sqs.SQSConnectorConfig\n  sinkClass:
    org.apache.pulsar.ecosystem.io.sqs.SQSSink\n  sinkConfigClass: org.apache.pulsar.ecosystem.io.sqs.SQSConnectorConfig\n
    \ version: 2.9.2.17\n  imageTag: 2.9.2.17\n  sinkTypeClassName: org.apache.pulsar.client.api.schema.GenericRecord\n
    \ sourceTypeClassName: java.lang.String\n- id: pulsar-io-cloud-storage\n  name:
    cloud-storage\n  description: Cloud storage Sink\n  sinkClass: org.apache.pulsar.io.jcloud.sink.CloudStorageGenericRecordSink\n
    \ sinkConfigClass: org.apache.pulsar.io.jcloud.sink.CloudStorageSinkConfig\n  imageRepository:
    streamnative/pulsar-io-cloud-storage\n  version: 2.9.2.17\n  imageTag: 2.9.2.17\n
    \ typeClassName: org.apache.pulsar.client.api.schema.GenericRecord\n- id: pulsar-io-amqp1_0\n
    \ name: amqp1_0\n  description: AMQP1_0 connectors\n  sourceClass: org.apache.pulsar.ecosystem.io.amqp.AmqpSource\n
    \ sinkClass: org.apache.pulsar.ecosystem.io.amqp.AmqpSink\n  sinkConfigClass: org.apache.pulsar.ecosystem.io.amqp.AmqpSinkConfig\n
    \ sourceConfigClass: org.apache.pulsar.ecosystem.io.amqp.AmqpSourceConfig\n  imageRepository:
    streamnative/pulsar-io-amqp-1-0\n  version: 2.8.2.4\n  imageTag: 2.8.2.4\n  typeClassName:
    java.nio.ByteBuffer\n  defaultSchemaType: org.apache.pulsar.client.impl.schema.ByteBufferSchema\n-
    id: pulsar-io-debezium-mysql\n  name: debezium-mysql\n  description: Debezium MySql
    Source\n  sourceClass: org.apache.pulsar.io.debezium.mysql.DebeziumMysqlSource\n
    \ imageRepository: streamnative/pulsar-io-debezium-mysql\n  version: 2.9.2.17\n
    \ imageTag: 2.9.2.17\n  typeClassName: org.apache.pulsar.common.schema.KeyValue\n-
    id: pulsar-io-debezium-postgres\n  name: debezium-postgres  \n  description: Debezium
    Postgres Source  \n  sourceClass: org.apache.pulsar.io.debezium.postgres.DebeziumPostgresSource\n
    \ imageRepository: streamnative/pulsar-io-debezium-postgres\n  version: 2.9.2.17\n
    \ imageTag: 2.9.2.17\n  typeClassName: org.apache.pulsar.common.schema.KeyValue\n-
    id: pulsar-io-debezium-mongodb\n  name: debezium-mongodb  \n  description: Debezium
    MongoDb Source  \n  sourceClass: org.apache.pulsar.io.debezium.mongodb.DebeziumMongoDbSource
    \ \n  imageRepository: streamnative/pulsar-io-debezium-mongodb\n  version: 2.9.2.17\n
    \ imageTag: 2.9.2.17\n  typeClassName: org.apache.pulsar.common.schema.KeyValue\n-
    id: pulsar-io-kafka\n  name: kafka\n  description: Kafka Source\n  sourceClass:
    org.apache.pulsar.io.kafka.KafkaBytesSource\n  imageRepository: streamnative/pulsar-io-kafka\n
    \ version: 2.9.2.17\n  imageTag: 2.9.2.17\n  sourceConfigClass: org.apache.pulsar.io.kafka.KafkaSourceConfig\n
    \ sourceTypeClassName: java.nio.ByteBuffer\n- id: pulsar-io-elastic-search\n  name:
    elasticsearch\n  description: Elasticsearch Sink\n  sinkClass: org.apache.pulsar.io.elasticsearch.ElasticSearchSink\n
    \ sinkConfigClass: org.apache.pulsar.io.elasticsearch.ElasticSearchConfig\n  imageRepository:
    streamnative/pulsar-io-elastic-search\n  version: 2.10.0.3\n  imageTag: 2.10.0.3\n
    \ typeClassName: org.apache.pulsar.client.api.schema.GenericObject\n- id: pulsar-io-aws-lambda\n
    \ name: aws-lambda\n  description: AWS Lambda Sink\n  sinkClass: org.apache.pulsar.ecosystem.io.aws.lambda.AWSLambdaBytesSink\n
    \ sinkConfigClass: org.apache.pulsar.ecosystem.io.aws.lambda.AWSLambdaConnectorConfig\n
    \ imageRepository: streamnative/pulsar-io-aws-lambda\n  version: 2.9.2.17\n  imageTag:
    2.9.2.17\n"
---
# Source: sn-platform/templates/broker/function-worker-configfile-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
## function config map
apiVersion: v1
kind: ConfigMap
metadata:
  name: "release-name-sn-platform-functions-worker-configfile"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: functions-worker
data:
  functions_worker.yml: |
    # Function package management
    workerPort: 8080
    numFunctionPackageReplicas: 3
    pulsarFunctionsCluster: release-name-sn-platform
    functionRuntimeFactoryConfigs:
      jobNamespace: snp
      pulsarDockerImageName: "streamnative/sn-platform:2.9.2.20"
      pulsarRootDir: /pulsar
      pulsarAdminUrl: http://release-name-sn-platform-proxy.snp.svc.cluster.local:8080
      pulsarServiceUrl: pulsar://release-name-sn-platform-broker.snp.svc.cluster.local:6650
      changeConfigMap: "release-name-sn-platform-functions-worker-config"
      changeConfigMapNamespace: snp
      submittingInsidePod: true
      installUserCodeDependencies: true
    # runtime customizer
    assignmentWriteMaxRetries: 60
    clusterCoordinationTopicName: coordinate
    connectorsDirectory: ./connectors
    downloadDirectory: download/pulsar_functions
    failureCheckFreqMs: 30000
    functionAssignmentTopicName: assignments
    functionMetadataTopicName: metadata
    functionRuntimeFactoryClassName: org.apache.pulsar.functions.runtime.kubernetes.KubernetesRuntimeFactory
    functionsDirectory: ./functions
    initialBrokerReconnectMaxRetries: 60
    instanceLivenessCheckFreqMs: 30000
    narExtractionDirectory: ""
    numHttpServerThreads: 8
    pulsarFunctionsNamespace: public/functions
    rescheduleTimeoutMs: 60000
    schedulerClassName: org.apache.pulsar.functions.worker.scheduler.RoundRobinScheduler
    topicCompactionFrequencySec: 1800
---
# Source: sn-platform/templates/broker/function-worker-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
## function config map
apiVersion: v1
kind: ConfigMap
metadata:
  name: "release-name-sn-platform-functions-worker-config"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: functions-worker
data:
  pulsarDockerImageName: "streamnative/sn-platform:2.9.2.20"
---
# Source: sn-platform/templates/grafana/grafana-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ConfigMap
metadata:
  name: "release-name-sn-platform-grafana"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: grafana
data:
  grafana.ini: |
    [analytics]
    check_for_updates = true
    [auth.azuread]
    allow_sign_up = true
    allowed_domains = 
    allowed_groups = 
    auth_url = 
    client_id = 
    client_secret = 
    enabled = false
    name = Azure AD
    role_attribute_strict = true
    scopes = openid email profile
    token_url = 
    [grafana_com]
    url = https://grafana.com
    [log]
    mode = console
    [log.file]
    format = text
    level = info
    [paths]
    data = /var/lib/grafana/pulsar/data
    plugins = /var/lib/grafana/pulsar/plugins
    provisioning = /var/lib/grafana/pulsar_provisioning
    [security]
    admin_password = {{ GRAFANA_ADMIN_PASSWORD }}
    admin_user = {{ GRAFANA_ADMIN_USER }}
    [server]
    domain = {{ GRAFANA_DOMAIN }}
    root_url = {{ GRAFANA_ROOT_URL }}
    serve_from_sub_path = {{ GRAFANA_SERVE_FROM_SUB_PATH }}
---
# Source: sn-platform/templates/prometheus/prometheus-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ConfigMap
metadata:
  name: "release-name-sn-platform-prometheus"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: prometheus
data:
  # Include prometheus configuration file, setup to monitor all the
  # Kubernetes pods with the "scrape=true" annotation.
  prometheus.yml: |
    global:
      scrape_interval: 15s
    rule_files:
      - 'rules.yml'
    alerting:
      alertmanagers:
      - static_configs:
        - targets: ['release-name-sn-platform-alert-manager:9093']
        path_prefix: /
    scrape_configs:
    - job_name: 'prometheus'
      static_configs:
      - targets:
        - '127.0.0.1:9090'
      metrics_path: /metrics
    - job_name: 'kubernetes-pods'
      bearer_token_file: /pulsar/tokens/client/token
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_label_component]
        action: replace
        target_label: job
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name
      metric_relabel_configs:
    - job_name: 'kubernetes-nodes'
      scheme: https
      kubernetes_sd_configs:
        - role: node

      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

      relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
        - target_label: __address__
          replacement: kubernetes.default.svc:443
        - source_labels: [__meta_kubernetes_node_name]
          regex: (.+)
          target_label: __metrics_path__
          replacement: /api/v1/nodes/${1}/proxy/metrics
    - job_name: 'kubernetes-cadvisor'
      scheme: https
      kubernetes_sd_configs:
        - role: node

      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

      relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
        - target_label: __address__
          replacement: kubernetes.default.svc:443
        - source_labels: [__meta_kubernetes_node_name]
          regex: (.+)
          target_label: __metrics_path__
          replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor
  rules.yml: |
    groups: null
---
# Source: sn-platform/templates/streamnative-console/streamnative-console-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ConfigMap
metadata:
  name: "release-name-sn-platform-streamnative-console-init-instance"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: streamnative-console
data:
  init_instance.py: |-
    import requests
    import json
    import os
    host = os.getenv("STREAMNATIVE_CONSOLE_BACKEND_URL")
    loginPath = "/cloud-manager/login"
    username = os.getenv("VAULT_SUPER_USER_NAME")
    password = os.getenv("VAULT_SUPER_USER_PASSWORD")
    if not username or not password:
        username = os.getenv("SUPER_USER_NAME")
        password = os.getenv("SUPER_USER_PASSWORD")
    loginData = {
        "username": username,
        "password": password,
        "type":"pulsar-vault-userpass"
    }
    headers = {
        "Content-Type": "application/json"
    }
    loginResponse = requests.post(url = host + loginPath, data=json.dumps(loginData), headers=headers)
    token = loginResponse.headers['token']
    headers = {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
    }
  
    instanceData = {"name": os.getenv("INSTANCE_NAME"), "broker": os.getenv("WEB_SERVICE_URL")}
    serviceData = {}
    if (os.getenv("KOP_SERVICE_URL")):
        serviceData["kopServiceUrl"] = os.getenv("KOP_SERVICE_URL")
    if (os.getenv("FLINK_SERVICE_URL")):
        serviceData["flinkServiceUrl"] = os.getenv("FLINK_SERVICE_URL")
    instanceData["service"] = json.dumps(serviceData)
  
    instancePath = "/cloud-manager/v1/instances"
    instanceResponse = requests.post(url = host + instancePath, data = json.dumps(instanceData), headers=headers)
    if (instanceResponse.ok and 'Add environment success' in instanceResponse.text):
        print("Add environment success")
    else:
        print("Add environment failed " + instanceResponse.text)
        exit(-1)
---
# Source: sn-platform/templates/toolset/toolset-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ConfigMap
metadata:
  name: "release-name-sn-platform-toolset"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: toolset
data:
  BOOKIE_LOG_APPENDER: "RollingFile"
  zkServers: "release-name-sn-platform-zookeeper:2181"
  zkLedgersRootPath: "/ledgers"
  # enable bookkeeper http server
  httpServerEnabled: "true"
  httpServerPort: "8000"
  # config the stats provider
  statsProviderClass: org.apache.bookkeeper.stats.prometheus.PrometheusMetricsProvider
  # use hostname as the bookie id
  useHostNameAsBookieID: "true"
  # talk to broker
  webServiceUrl: "http://release-name-sn-platform-broker:8080/"
  brokerServiceUrl: "pulsar://release-name-sn-platform-broker:6650/"
  # Authentication Settings
  authParams: "file:///pulsar/tokens/client/token"
  authPlugin: "org.apache.pulsar.client.impl.auth.AuthenticationToken"
  PULSAR_MEM: |
    -Xms64M -Xmx128M -XX:MaxDirectMemorySize=128M
  # Include log configuration file, If you want to configure the log level and other configuration
  # items, you can modify the configmap, and eventually it will overwrite the log4j2.yaml file under conf
  log4j2.yaml: |
    #
    # Licensed to the Apache Software Foundation (ASF) under one
    # or more contributor license agreements.  See the NOTICE file
    # distributed with this work for additional information
    # regarding copyright ownership.  The ASF licenses this file
    # to you under the Apache License, Version 2.0 (the
    # "License"); you may not use this file except in compliance
    # with the License.  You may obtain a copy of the License at
    #
    #   http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing,
    # software distributed under the License is distributed on an
    # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    # KIND, either express or implied.  See the License for the
    # specific language governing permissions and limitations
    # under the License.
    #
  
  
    Configuration:
      status: INFO
      monitorInterval: 30
      name: pulsar
      packages: io.prometheus.client.log4j2
  
      Properties:
        Property:
          - name: "pulsar.log.dir"
            value: "logs"
          - name: "pulsar.log.file"
            value: "pulsar.log"
          - name: "pulsar.log.appender"
            value: "RoutingAppender"
          - name: "pulsar.log.root.level"
            value: "info"
          - name: "pulsar.log.level"
            value: "info"
          - name: "pulsar.routing.appender.default"
            value: "Console"
  
      # Example: logger-filter script
      Scripts:
        ScriptFile:
          name: filter.js
          language: JavaScript
          path: ./conf/log4j2-scripts/filter.js
          charset: UTF-8
  
      Appenders:
  
        # Console
        Console:
          name: Console
          target: SYSTEM_OUT
          PatternLayout:
            Pattern: "%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"
  
        # Rolling file appender configuration
        RollingFile:
          name: RollingFile
          fileName: "${sys:pulsar.log.dir}/${sys:pulsar.log.file}"
          filePattern: "${sys:pulsar.log.dir}/${sys:pulsar.log.file}-%d{MM-dd-yyyy}-%i.log.gz"
          immediateFlush: false
          PatternLayout:
            Pattern: "%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"
          Policies:
            TimeBasedTriggeringPolicy:
              interval: 1
              modulate: true
            SizeBasedTriggeringPolicy:
              size: 1 GB
          # Delete file older than 30days
          DefaultRolloverStrategy:
              Delete:
                basePath: ${sys:pulsar.log.dir}
                maxDepth: 2
                IfFileName:
                  glob: "*/${sys:pulsar.log.file}*log.gz"
                IfLastModified:
                  age: 30d
  
        Prometheus:
          name: Prometheus
  
        # Routing
        Routing:
          name: RoutingAppender
          Routes:
            pattern: "$${ctx:function}"
            Route:
              -
                Routing:
                  name: InstanceRoutingAppender
                  Routes:
                    pattern: "$${ctx:instance}"
                    Route:
                      -
                        RollingFile:
                          name: "Rolling-${ctx:function}"
                          fileName : "${sys:pulsar.log.dir}/functions/${ctx:function}/${ctx:functionname}-${ctx:instance}.log"
                          filePattern : "${sys:pulsar.log.dir}/functions/${sys:pulsar.log.file}-${ctx:instance}-%d{MM-dd-yyyy}-%i.log.gz"
                          PatternLayout:
                            Pattern: "%d{ABSOLUTE} %level{length=5} [%thread] [instance: %X{instance}] %logger{1} - %msg%n"
                          Policies:
                            TimeBasedTriggeringPolicy:
                              interval: 1
                              modulate: true
                            SizeBasedTriggeringPolicy:
                              size: "20MB"
                            # Trigger every day at midnight that also scan
                            # roll-over strategy that deletes older file
                            CronTriggeringPolicy:
                              schedule: "0 0 0 * * ?"
                          # Delete file older than 30days
                          DefaultRolloverStrategy:
                              Delete:
                                basePath: ${sys:pulsar.log.dir}
                                maxDepth: 2
                                IfFileName:
                                  glob: "*/${sys:pulsar.log.file}*log.gz"
                                IfLastModified:
                                  age: 30d
                      - ref: "${sys:pulsar.routing.appender.default}"
                        key: "${ctx:function}"
              - ref: "${sys:pulsar.routing.appender.default}"
                key: "${ctx:function}"
  
      Loggers:
  
        # Default root logger configuration
        Root:
          level: "${sys:pulsar.log.root.level}"
          additivity: true
          AppenderRef:
            - ref: "${sys:pulsar.log.appender}"
              level: "${sys:pulsar.log.level}"
            - ref: Prometheus
              level: info
  
        Logger:
          - name: org.apache.bookkeeper.bookie.BookieShell
            level: info
            additivity: false
            AppenderRef:
              - ref: Console
  
          - name: verbose
            level: info
            additivity: false
            AppenderRef:
              - ref: Console
  
        # Logger to inject filter script
    #     - name: org.apache.bookkeeper.mledger.impl.ManagedLedgerImpl
    #       level: debug
    #       additivity: false
    #       AppenderRef:
    #         ref: "${sys:pulsar.log.appender}"
    #         ScriptFilter:
    #           onMatch: ACCEPT
    #           onMisMatch: DENY
    #           ScriptRef:
    #             ref: filter.js
  kafka.properties: |
  # pulsarctl configs
  pulsarctl.config: |
    auth-info:
      default:
        locationoforigin: /root/.config/pulsar/config
        tls_allow_insecure_connection: false
        token: ""
        tokenFile: "/pulsar/tokens/client/token"
        issuer_endpoint: ""
        client_id: ""
        audience: ""
        key_file: ""
    contexts:
      default:
        admin-service-url: "http://release-name-sn-platform-broker:8080"
        bookie-service-url: "http://release-name-sn-platform-bookie:8000"
    current-context: default
---
# Source: sn-platform/templates/vault/vault-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ConfigMap
metadata:
  name: "release-name-sn-platform-vault-create-pulsar-tokens"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: vault
data:
  create_pulsar_tokens.sh: |
    #!/usr/bin/env bash
    #
    # Licensed to the Apache Software Foundation (ASF) under one
    # or more contributor license agreements.  See the NOTICE file
    # distributed with this work for additional information
    # regarding copyright ownership.  The ASF licenses this file
    # to you under the Apache License, Version 2.0 (the
    # "License"); you may not use this file except in compliance
    # with the License.  You may obtain a copy of the License at
    #
    #   http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing,
    # software distributed under the License is distributed on an
    # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    # KIND, either express or implied.  See the License for the
    # specific language governing permissions and limitations
    # under the License.
    #
  
    BASEDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
    echo $BASEDIR
  
    usage() {
        cat <<EOF
    This script is used to create pulsar tokens before deploying a helm chart.
    Options:
           -h,--help                        prints the usage message
           -n,--namespace                   the k8s namespace to install the pulsar helm chart
           -k,--release                     the pulsar helm release name
           -v,--vault-addr                  the vault server address
           -r,--root-token                  the vault root token
           -s,--pulsar-superusers           the superusers of pulsar cluster. a comma separated list of super users.
           -ros,--pulsar-ro-superusers      the readonly superusers of pulsar cluster. a comma separated list of super users.
    Usage:
        $0 --namespace pulsar --release pulsar-release --pulsar-superusers admin,broker-admin,proxy-admin,super
    EOF
    }
  
  
    while [[ $# -gt 0 ]]
    do
    key="$1"
  
    case $key in
        -n|--namespace)
        namespace="$2"
        shift
        shift
        ;;
        -k|--release)
        release="$2"
        shift
        shift
        ;;
        -v|--vault-addr)
        vault_addr="$2"
        shift
        shift
        ;;
        -r|--root-token)
        vault_root_token="$2"
        shift
        shift
        ;;
        -s|--pulsar-superusers)
        pulsar_superusers="$2"
        shift
        shift
        ;;
        -ros|--pulsar-ro-superusers)
        pulsar_ro_superusers="$2"
        shift
        shift
        ;;
        -h|--help)
        usage
        exit 0
        ;;
        *)
        echo "unknown option: $key"
        usage
        exit 1
        ;;
    esac
    done
  
    namespace=${namespace:-default}
    release=${release:-pulsar-dev}
    pulsar_superusers=${pulsar_superusers:-"super,proxy-admin,broker-admin"}
    pulsar_ro_superusers=${pulsar_ro_superusers:-"admin"}
    vault_addr=${vault_addr:-"http://127.0.0.1:8200"}
  
    export VAULT_ADDR=${vault_addr}
  
    vault login ${vault_root_token}
  
    echo "Enable secrets engine ..."
    vault secrets enable -path=secret --version=2 kv
    echo "Enable userpass ..."
    vault auth enable userpass
  
    vault policy write super ${BASEDIR}/superuser.hcl
    vault policy write pulsar-superuser-ro ${BASEDIR}/ro-superuser.hcl
  
    vault auth tune -max-lease-ttl=31536000 token
    vault auth tune -default-lease-ttl=31536000 token
  
    function createSuperUser() {
        local user=$1
        local superToken=$(vault token create --policy super --ttl 0 --display-name ${user} --metadata=username=${user} --metadata=isSuper=true | grep token | grep -v _ | awk '{ print $2 }')
  
        vault kv put secret/pulsar/token-${user} role="${user}" isSuper=true
        kubectl delete secret -n ${namespace} \
            ${release}-token-${user}
        kubectl create secret generic -n ${namespace} \
            ${release}-token-${user} \
            --from-literal="TOKEN=${superToken}" \
            --from-literal="TYPE=vault"
    }
  
    function createSuperUserRO() {
        local user=$1
        local superToken=$(vault token create --policy pulsar-superuser-ro --ttl 0 --display-name ${user} --metadata=username=${user} --metadata=isSuper=true | grep token | grep -v _ | awk '{ print $2 }')
  
        vault kv put secret/pulsar/token-${user} role="${user}" isSuper=true
        kubectl delete secret -n ${namespace} \
            ${release}-token-${user}
        kubectl create secret generic -n ${namespace} \
            ${release}-token-${user} \
            --from-literal="TOKEN=${superToken}" \
            --from-literal="TYPE=vault"
    }
  
    echo "generate the tokens for the super-users: ${pulsar_superusers}"
  
    IFS=', ' read -r -A superusers <<< "$pulsar_superusers"
    for user in "${superusers[@]}"
    do
        echo "generate the token for $user"
        createSuperUser $user
    done
  
    echo "generate the tokens for the readonly super-users: ${pulsar_ro_superusers}"
  
    IFS=', ' read -r -A ro_superusers <<< "$pulsar_ro_superusers"
    for user in "${ro_superusers[@]}"
    do
        echo "generate the token for $user"
        createSuperUserRO $user
    done
  
    echo "The jwt tokens for superusers are generated and stored as below:"
    for user in "${superusers[@]}"
    do
        echo "    - '${user}':secret('${release}-token-${user}')"
    done
    echo
  
    echo "The jwt tokens for readonly superusers are generated and stored as below:"
    for user in "${ro_superusers[@]}"
    do
        echo "    - '${user}':secret('${release}-token-${user}')"
    done
    echo
  ro-superuser.hcl: |
    # Manage auth methods broadly across Vault
    path "auth/token/*" {
      capabilities = ["read"]
    }
  
    path "auth/userpass/*" {
      capabilities = ["read"]
    }
  
    # List, create, update, and delete key/value secrets
    path "secret/data/pulsar/*" {
      capabilities = ["read"]
    }
  
    path "secret/metadata/pulsar/*" {
      capabilities = ["read"]
    }
  superuser.hcl: |
    # Manage auth methods broadly across Vault
    path "auth/token/*" {
      capabilities = ["create", "read", "update", "delete"]
    }
  
    path "auth/userpass/*" {
      capabilities = ["create", "read", "update", "delete"]
    }
  
    # List, create, update, and delete key/value secrets
    path "secret/data/pulsar/*" {
      capabilities = ["create", "read", "update", "delete"]
    }
  
    path "secret/metadata/pulsar/*" {
      capabilities = ["create", "read", "update", "delete"]
    }
---
# Source: sn-platform/templates/vault/vault-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: "release-name-sn-platform-vault-init-streamnative-console"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: vault
data:
  ldap-user.hcl: |-
    path "auth/userpass/users/{{identity.entity.aliases.auth_userpass_2302556c.name}}" {
      capabilities = ["read", "update"]
    }
  
    path "identity/*" {
      capabilities = ["update"]
    }
  
    # Manage identity entity alias
    path "identity/entity-alias/id/{{identity.entity.aliases.auth_userpass_2302556c.id}}" {
      capabilities = ["create", "read", "update", "delete"]
    }
  
  
    path "identity/oidc/token/*" {
      capabilities = ["read", "update"]
    }
  service-account-template.json: |-
    {
      "rolename": {{identity.entity.aliases.MOUNT_ACCESSOR.metadata.role_name}},
      "id": {{identity.entity.aliases.MOUNT_ACCESSOR.id}},
      "type": "service-account"
    }
  service-account.hcl: |-
    path "auth/approle/role/{{identity.entity.aliases.MOUNT_ACCESSOR.name}}" {
      capabilities = ["read", "update"]
    }
  
    path "identity/*" {
      capabilities = ["read", "create", "update"]
    }
  
    # Manage identity entity alias
    path "identity/entity-alias/id/{{identity.entity.aliases.MOUNT_ACCESSOR.id}}" {
      capabilities = ["create", "read", "update", "delete"]
    }
  
  
    path "identity/oidc/token/*" {
      capabilities = ["read", "update"]
    }
  startup.sh: |-
    #!/usr/bin/env sh
    #
    # Licensed under the Apache License, Version 2.0 (the "License");
    # you may not use this file except in compliance with the License.
    # You may obtain a copy of the License at
    #
    #     http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing, software
    # distributed under the License is distributed on an "AS IS" BASIS,
    # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    # See the License for the specific language governing permissions and
    # limitations under the License.
    #
  
    if [ -n "$VAULT_SUPER_USER_NAME" ];then
        export VAULT_SUPER_USER_NAME=$VAULT_SUPER_USER_NAME
    else
        export VAULT_SUPER_USER_NAME=admin
    fi
    if [ -n "$VAULT_SUPER_USER_PASSWORD" ]; then
        export VAULT_SUPER_USER_PASSWORD=$VAULT_SUPER_USER_PASSWORD
    else
        export VAULT_SUPER_USER_PASSWORD=$(cat /dev/urandom | base64 | tr -dc '0-9a-zA-Z' | head -c12)
    fi
  
    export VAULT_APPROLE_SUPER_NAME=apachepulsar
    # generate console password
    #export VAULT_ADDR="http://127.0.0.1:8200"
  
    BASEDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
    echo $BASEDIR
    TMP_DIR="/tmp"
  
  
    vault login $ROOT_TOKEN
    vault auth enable userpass
    vault auth enable approle
    userMountAccessor=$(vault auth list | grep auth_userpass | awk '{print $3}')
    echo $userMountAccessor
    serviceAccountMountAccessor=$(vault auth list | grep auth_approle | awk '{print $3}')
    echo $serviceAccountMountAccessor
    sed "s#MOUNT_ACCESSOR#$userMountAccessor#g" $BASEDIR/user-template.json > $TMP_DIR/user-template.json
    sed "s#MOUNT_ACCESSOR#$userMountAccessor#g" $BASEDIR/user.hcl > $TMP_DIR/user.hcl
    sed "s#MOUNT_ACCESSOR#$userMountAccessor#g" $BASEDIR/super-user.hcl > $TMP_DIR/super-user.hcl
    sed "s#MOUNT_ACCESSOR#$userMountAccessor#g" $BASEDIR/super-user-template.json > $TMP_DIR/super-user-template.json
    sed "s#MOUNT_ACCESSOR#$serviceAccountMountAccessor#g" $BASEDIR/service-account-template.json > $TMP_DIR/service-account-template.json
    sed "s#MOUNT_ACCESSOR#$serviceAccountMountAccessor#g" $BASEDIR/service-account.hcl > $TMP_DIR/service-account.hcl
    sed "s#MOUNT_ACCESSOR#$serviceAccountMountAccessor#g" $BASEDIR/super-service-account.hcl > $TMP_DIR/super-service-account.hcl
    sed "s#MOUNT_ACCESSOR#$serviceAccountMountAccessor#g" $BASEDIR/super-service-account-template.json > $TMP_DIR/super-service-account-template.json
  
  
    vault policy write service-account $TMP_DIR/service-account.hcl
    vault write identity/entity name="service-account" policies="service-account"
    canonicalId=$(vault read identity/entity/name/service-account | grep -v _id | grep id | awk '{print $2}')
    vault write identity/entity-alias name="service-account"  mount_accessor=$serviceAccountMountAccessor canonical_id=$canonicalId metadata=name='service-account'
    vault write identity/oidc/key/service-account name=service-account rotation_period=24h verification_ttl=24h
    vault write identity/oidc/role/service-account key=service-account ttl=$VAULT_TTL template=@$TMP_DIR/service-account-template.json
    serviceAccountClientId=$(vault read identity/oidc/role/service-account | grep client_id |  awk '{print $2}')
    vault write identity/oidc/key/service-account name=service-account rotation_period=24h verification_ttl=24h allowed_client_ids=$serviceAccountClientId
  
    superApproleName=$VAULT_APPROLE_SUPER_NAME
    vault policy write super-service-account $TMP_DIR/super-service-account.hcl
    vault write identity/entity name="super-service-account" policies="super-service-account"
    vault write identity/entity name=$superApproleName policies="super-service-account" metadata=system=true
    canonicalId=$(vault read identity/entity/name/super-service-account | grep -v _id | grep id | awk '{print $2}')
    vault write identity/entity-alias name="super-service-account"  mount_accessor=$serviceAccountMountAccessor canonical_id=$canonicalId metadata=name='super-service-account'
    vault write identity/oidc/key/super-service-account name=super-service-account rotation_period=24h verification_ttl=24h
    vault write identity/oidc/role/super-service-account key=super-service-account ttl=$VAULT_TTL template=@$TMP_DIR/super-service-account-template.json
    superServiceAccountClientId=$(vault read identity/oidc/role/super-service-account | grep client_id |  awk '{print $2}')
    vault write identity/oidc/key/super-service-account name=super-service-account rotation_period=24h verification_ttl=24h allowed_client_ids=$superServiceAccountClientId
  
  
    vault write auth/approle/role/$superApproleName policies=super-service-account
  
    # set a short ttl for approle to avoid vault oom caused by frequent lease generation
    vault auth tune -default-lease-ttl=5m approle/
  
    superUser=$VAULT_SUPER_USER_NAME
    superPassword=$VAULT_SUPER_USER_PASSWORD
    vault policy write super-user $TMP_DIR/super-user.hcl
    vault write auth/userpass/users/$superUser password="$superPassword" policies="super-user"
    vault write identity/entity name="super-user" policies="super-user"
    vault write identity/entity name=$superUser policies="super-user" metadata=system=true
    vault write identity/oidc/key/super-user name=super-user rotation_period=24h verification_ttl=24h
    vault write identity/oidc/role/super-user key=super-user ttl=$VAULT_TTL template=@$TMP_DIR/super-user-template.json
    superUserClientId=$(vault read identity/oidc/role/super-user | grep client_id |  awk '{print $2}')
    vault write identity/oidc/key/super-user name=super-user rotation_period=24h verification_ttl=24h allowed_client_ids=$superUserClientId
  
    vault policy write user $TMP_DIR/user.hcl
    vault write identity/entity name="user" policies="user"
    vault write identity/oidc/key/user name=user rotation_period=24h verification_ttl=24h
    vault write identity/oidc/role/user key=user ttl=$VAULT_TTL template=@$TMP_DIR/user-template.json
    userClientId=$(vault read identity/oidc/role/user | grep client_id |  awk '{print $2}')
    vault write identity/oidc/key/user name=user rotation_period=24h verification_ttl=24h allowed_client_ids=$userClientId
    loginInfo=$(vault login -method=userpass username=$superUser password=$superPassword)
    superToken=$(echo "$loginInfo" | grep  -v '_' | grep 'token  ' | awk '{print $2}')
    export VAULT_SUPER_USER_TOKEN=$superToken
    export VAULT_USERPASS_MOUNT_ACCESSOR=$userMountAccessor
    export VAULT_APPROLE_MOUNT_ACCESSOR=$serviceAccountMountAccessor
    export VAULT_APPROLE_ROLE_ID=$(vault read auth/approle/role/$superApproleName/role-id | grep role_id | awk '{print $2}')
    export VAULT_APPROLE_SECRET_ID=$(vault write -f auth/approle/role/$superApproleName/secret-id | grep -v secret_id_ | grep secret_id | awk '{print $2}')
    approleLoginInfo=$(vault write auth/approle/login role_id=$VAULT_APPROLE_ROLE_ID secret_id=$VAULT_APPROLE_SECRET_ID)
    export VAULT_APPROLE_SUPER_TOKEN=$(echo "$approleLoginInfo" | grep 'token ' | awk '{print $2}')
  
  
    echo "RESULT is as below: "
    echo "VAULT_USERPASS_MOUNT_ACCESSOR: "$VAULT_USERPASS_MOUNT_ACCESSOR
    echo "VAULT_SUPER_USER_NAME: "$VAULT_SUPER_USER_NAME
    echo "VAULT_SUPER_USER_PASSWORD: "$VAULT_SUPER_USER_PASSWORD
    echo "VAULT_SUPER_USER_TOKEN: "$VAULT_SUPER_USER_TOKEN
    echo "VAULT_APPROLE_MOUNT_ACCESSOR: "$VAULT_APPROLE_MOUNT_ACCESSOR
    echo "VAULT_APPROLE_ROLE_ID: "$VAULT_APPROLE_ROLE_ID
    echo "VAULT_APPROLE_SECRET_ID: "$VAULT_APPROLE_SECRET_ID
    echo "VAULT_APPROLE_SUPER_NAME: "$VAULT_APPROLE_SUPER_NAME
    echo "VAULT_APPROLE_SUPER_TOKEN: "$VAULT_APPROLE_SUPER_TOKEN
    echo "oidc info ====="
    echo "oidc client ids: serviceAccount,superServiceAccount,user,superUser "
    echo $serviceAccountClientId,$superServiceAccountClientId,$userClientId,$superUserClientId
  
  
    echo "" > /tmp/pm_env
    echo "PULSAR_PREFIX_OIDCTokenAudienceID="$serviceAccountClientId,$superServiceAccountClientId,$userClientId,$superUserClientId >> /tmp/pm_env
    echo "VAULT_HOST="$VAULT_ADDR >> /tmp/pm_env
    echo "VAULT_USERPASS_MOUNT_ACCESSOR="$VAULT_USERPASS_MOUNT_ACCESSOR >> /tmp/pm_env
    echo "VAULT_SUPER_USER_NAME="$VAULT_SUPER_USER_NAME >> /tmp/pm_env
    echo "VAULT_SUPER_USER_PASSWORD="$VAULT_SUPER_USER_PASSWORD >> /tmp/pm_env
    echo "VAULT_SUPER_USER_TOKEN="$VAULT_SUPER_USER_TOKEN >> /tmp/pm_env
    echo "VAULT_APPROLE_MOUNT_ACCESSOR="$VAULT_APPROLE_MOUNT_ACCESSOR >> /tmp/pm_env
    echo "VAULT_APPROLE_ROLE_ID="$VAULT_APPROLE_ROLE_ID >> /tmp/pm_env
    echo "VAULT_APPROLE_SECRET_ID="$VAULT_APPROLE_SECRET_ID >> /tmp/pm_env
    echo "VAULT_APPROLE_SUPER_NAME="$VAULT_APPROLE_SUPER_NAME >> /tmp/pm_env
    echo "VAULT_APPROLE_SUPER_TOKEN="$VAULT_SUPER_USER_TOKEN >> /tmp/pm_env
  
    #echo "brokerClientAuthenticationParameters={\"role\":\"super-service-account\",\"roleId\":\""$VAULT_APPROLE_ROLE_ID"\",\"secretId\":\""$VAULT_APPROLE_SECRET_ID"\",\"vaultHost\": \""$VAULT_ADDR"\"}"\" >> /tmp/pm_env
  
    # for busybox base64 image, we need to remove \n in the result
    export VAULT_PULSAR_TOKEN=$(echo "$VAULT_APPROLE_ROLE_ID:$VAULT_APPROLE_SECRET_ID"|base64|tr -d \\n)
    echo "brokerClientAuthenticationParameters=$VAULT_PULSAR_TOKEN" >> /tmp/pm_env
  
  
    echo "create secret for above secrets!"
    cat /tmp/pm_env
  
    kubectl delete secret $VAULT_SECRET_KEY_NAME -n $NAMESPACE --ignore-not-found=true
    kubectl create secret generic $VAULT_SECRET_KEY_NAME --from-env-file=/tmp/pm_env -n $NAMESPACE
  
    echo "create secret for console password! -> $CONSOLE_SECRET_KEY_NAME"
    kubectl delete secret $CONSOLE_SECRET_KEY_NAME -n $NAMESPACE --ignore-not-found=true
    kubectl create secret generic $CONSOLE_SECRET_KEY_NAME -n $NAMESPACE --from-literal=password=$VAULT_SUPER_USER_PASSWORD
  
    echo "create secret for toolset token -> $TOOLSET_TOKEN_SECRET_NAME"
    kubectl delete secret $TOOLSET_TOKEN_SECRET_NAME -n $NAMESPACE --ignore-not-found=true
    kubectl create secret generic $TOOLSET_TOKEN_SECRET_NAME -n $NAMESPACE --from-literal=TOKEN=$VAULT_PULSAR_TOKEN
  super-service-account-template.json: |-
    {
      "rolename": {{identity.entity.aliases.MOUNT_ACCESSOR.metadata.role_name}},
      "id": {{identity.entity.aliases.MOUNT_ACCESSOR.id}},
      "type": "service-account",
      "scope": "admin"
    }
  super-service-account.hcl: |
    path "auth/userpass/users/*" {
      capabilities = ["read", "update", "list", "create", "sudo", "delete"]
    }
  
    path "auth/approle/role/*" {
      capabilities = ["read", "update", "list", "create", "sudo", "delete"]
    }
  
    path "identity/*" {
      capabilities = ["read", "create", "update", "list"]
    }
  
    # Manage identity entity alias
    path "identity/entity-alias/id/{{identity.entity.aliases.MOUNT_ACCESSOR.id}}" {
      capabilities = ["create", "read", "update", "delete"]
    }
  
  
    path "identity/oidc/token/*" {
      capabilities = ["read", "update"]
    }
  super-user-template.json: |-
    {
      "username": {{identity.entity.aliases.MOUNT_ACCESSOR.name}},
      "id": {{identity.entity.aliases.MOUNT_ACCESSOR.id}},
      "type": "user",
      "scope": "admin"
    }
  super-user.hcl: |
    path "auth/userpass/users/*" {
      capabilities = ["read", "update", "list", "create", "sudo", "delete"]
    }
  
    path "auth/approle/role/*" {
      capabilities = ["read", "update", "list", "create", "sudo", "delete"]
    }
  
    path "identity/*" {
      capabilities = ["read", "create", "update", "list"]
    }
  
    # Manage identity entity alias
    path "identity/entity-alias/id/{{identity.entity.aliases.MOUNT_ACCESSOR.id}}" {
      capabilities = ["create", "read", "update", "delete"]
    }
  
  
    path "identity/oidc/token/*" {
      capabilities = ["read", "update"]
    }
  user-template.json: |-
    {
      "username": {{identity.entity.aliases.MOUNT_ACCESSOR.name}},
      "id": {{identity.entity.aliases.MOUNT_ACCESSOR.id}},
       "type": "user"
    }
  user.hcl: |-
    path "auth/userpass/users/{{identity.entity.aliases.MOUNT_ACCESSOR.name}}" {
      capabilities = ["read", "update"]
    }
  
    path "identity/*" {
      capabilities = ["read", "create", "update"]
    }
  
    # Manage identity entity alias
    path "identity/entity-alias/id/{{identity.entity.aliases.MOUNT_ACCESSOR.id}}" {
      capabilities = ["create", "read", "update", "delete"]
    }
  
  
    path "identity/oidc/token/*" {
      capabilities = ["read", "update"]
    }
  vault-jwt-init.sh: |-
    defaultRole=streamnative
    boundAudiences="00000002-0000-0000-c000-000000000000"
    userClaim="appid"
    groupsClaim="appid"
    policies="super-user"
    jwksUrl="https://sts.windows.net/06a8a086-ae6e-45b5-a22e-ad90de23013e/discovery/keys"
    vault auth enable jwt
    vault write auth/jwt/config \
        jwks_url=$jwksUrl \
        default_role=$defaultRole
    vault write auth/jwt/role/$defaultRole \
        role_type="jwt" \
        name=$defaultRole \
        bound_audiences=$boundAudiences \
        user_claim=$userClaim \
        groups_claim=$groupsClaim \
        clock_skew_leeway=60 \
        expiration_leeway=150 \
        not_before_leeway=150 \
        policies=$policies \
        ttl=1h
  vault-ldap-init.sh: |
    URL="ldap://elegant_varahamihira:389"
    USER_DN="ou=people,dc=planetexpress,dc=com"
    GROUP_DN="ou=people,dc=planetexpress,dc=com"
    GROUP_ATTR="cn"
    UPN_DOMAIN=""
    BIND_DN="cn=admin,dc=planetexpress,dc=com"
    BIND_PASS="GoodNewsEveryone"
    vault auth enable ldap
    vault write auth/ldap/config url=$URL userdn=$USER_DN groupdn=$GROUP_DN groupattr=$GROUP_ATTR upndomain=$UPN_DOMAIN insecure_tls=true userattr=uid starttls=false binddn=$BIND_DN bindpass=$BIND_PASS
    vault write auth/ldap/groups/streamnative policies=user
    vault auth enable approle
    userMountAccessor=$(vault auth list | grep auth_ldap | awk '{print $3}')
    serviceAccountMountAccessor=$(vault auth list | grep auth_approle | awk '{print $3}')
    sed -i "s#MOUNT_ACCESSOR#$userMountAccessor#g" /vault-ldap/user-template.json /vault-ldap/user.hcl /vault-ldap/super-user-template.json
    sed -i "s#MOUNT_ACCESSOR#$serviceAccountMountAccessor#g" /vault-ldap/service-account-template.json /vault-ldap/service-account.hcl
    sed -i "s#MOUNT_ACCESSOR#$serviceAccountMountAccessor#g" /vault-ldap/super-service-account-template.json
  
    vault policy write user /vault-ldap/user.hcl
    vault write identity/entity name="user" policies="user"
    vault write identity/oidc/key/user name=user rotation_period=24h verification_ttl=24h
    vault write identity/oidc/role/user key=user ttl=12h template=@/vault-ldap/user-template.json
    userClientId=$(vault read identity/oidc/role/user | grep client_id |  awk '{print $2}')
    vault write identity/oidc/key/user name=user rotation_period=24h verification_ttl=24h allowed_client_ids=$userClientId
  
    vault policy write super-user /vault-ldap/user.hcl
    vault write identity/entity name="super-user" policies="super-user"
    vault write identity/oidc/key/super-user name=super-user rotation_period=24h verification_ttl=24h
    vault write identity/oidc/role/super-user key=super-user ttl=12h template=@/vault-ldap/super-user-template.json
    superUserClientId=$(vault read identity/oidc/role/super-user | grep client_id |  awk '{print $2}')
    vault write identity/oidc/key/super-user name=super-user rotation_period=24h verification_ttl=24h allowed_client_ids=$superUserClientId
  
    vault policy write service-account /vault-ldap/service-account.hcl
    vault write identity/entity name="service-account" policies="service-account"
    canonicalId=$(vault read identity/entity/name/service-account | grep -v _id | grep id | awk '{print $2}')
    vault write identity/entity-alias name="service-account"  mount_accessor=$serviceAccountMountAccessor canonical_id=$canonicalId metadata=name='service-account'
    vault write identity/oidc/key/service-account name=service-account rotation_period=24h verification_ttl=24h
    vault write identity/oidc/role/service-account key=service-account ttl=12h template=@/vault-ldap/service-account-template.json
    serviceAccountClientId=$(vault read identity/oidc/role/service-account | grep client_id |  awk '{print $2}')
    vault write identity/oidc/key/service-account name=service-account rotation_period=24h verification_ttl=24h allowed_client_ids=$serviceAccountClientId
  
    vault policy write super-service-account /vault-ldap/service-account.hcl
    vault write identity/entity name="super-service-account" policies="super-service-account"
    canonicalId=$(vault read identity/entity/name/super-service-account | grep -v _id | grep id | awk '{print $2}')
    vault write identity/entity-alias name="super-service-account"  mount_accessor=$serviceAccountMountAccessor canonical_id=$canonicalId metadata=name='super-service-account'
    vault write identity/oidc/key/super-service-account name=super-service-account rotation_period=24h verification_ttl=24h
    vault write identity/oidc/role/super-service-account key=super-service-account ttl=12h template=@/vault-ldap/super-service-account-template.json
    superServiceAccountClientId=$(vault read identity/oidc/role/super-service-account | grep client_id |  awk '{print $2}')
    vault write identity/oidc/key/super-service-account name=super-service-account rotation_period=24h verification_ttl=24h allowed_client_ids=$superServiceAccountClientId
    vault write auth/approle/role/apachepulsar policies=super-service-account
---
# Source: sn-platform/templates/zookeeper/gen-zk-conf.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

apiVersion: v1
kind: ConfigMap
metadata:
  name: "release-name-sn-platform-genzkconf-configmap"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
  annotations:
data:
  gen-zk-conf.sh: |
    #!/bin/bash
    
    # Apply env variables to config file and start the regular command
    
    CONF_FILE=$1
    IDX=$2
    PEER_TYPE=$3
    
    if [ $? != 0 ]; then
        echo "Error: Failed to apply changes to config file"
        exit 1
    fi
    
    DOMAIN=`hostname -d`

    if [ -n "${ZOOKEEPER_DOMAIN}" ]; then
        ZOOKEEPER_DOMAIN="${ZOOKEEPER_DOMAIN}.$(cut -d '.' -f 2- <<<${DOMAIN})"
    else
        ZOOKEEPER_DOMAIN=$DOMAIN
    fi
    
    # Generate list of servers and detect the current server ID,
    # based on the hostname
    ((IDX++))
    for SERVER in $(echo $ZOOKEEPER_SERVERS | tr "," "\n")
    do
        echo "server.$IDX=$SERVER.$ZOOKEEPER_DOMAIN:2888:3888:${PEER_TYPE};2181" >> $CONF_FILE
    
        if [ "$HOSTNAME" == "$SERVER" ]; then
            MY_ID=$IDX
            echo "Current server id $MY_ID"
        fi
    
    	((IDX++))
    done

    if [ -n "${OBSERVER_SERVER}" ]; then
        echo "server.$IDX=${OBSERVER_SERVER}.$DOMAIN:2181:2888:observer" >> $CONF_FILE
        MY_ID=$IDX
    fi

    # For ZooKeeper container we need to initialize the ZK id
    if [ ! -z "$MY_ID" ]; then
        # Get ZK data dir
        DATA_DIR=`grep '^dataDir=' $CONF_FILE | awk -F= '{print $2}'`
        if [ ! -e $DATA_DIR/myid ]; then
            echo "Creating $DATA_DIR/myid with id = $MY_ID"
            mkdir -p $DATA_DIR
            echo $MY_ID > $DATA_DIR/myid
        fi
    fi
---
# Source: sn-platform/templates/prometheus/prometheus-pvc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "release-name-sn-platform-prometheus-data"
  namespace: snp
spec:
  resources:
    requests:
      storage: 10Gi
  accessModes: [ "ReadWriteOnce" ]
---
# Source: sn-platform/templates/streamnative-console/streamnative-console-pvc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "release-name-sn-platform-streamnative-console-data"
  namespace: snp
spec:
  resources:
    requests:
      storage: 10Gi
  accessModes: [ "ReadWriteOnce" ]
---
# Source: sn-platform/templates/bookkeeper/bookkeeper-cluster-role-binding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: "release-name-sn-platform-bookie-clusterrole"
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
rules:
- apiGroups: [""]
  resources:
  - persistentvolumeclaims
  - persistentvolumes
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources:
    - pods
  verbs:
    - list
    - get
---
# Source: sn-platform/templates/broker/broker-cluster-role-binding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: "release-name-sn-platform-broker-clusterrole"
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
rules:
- apiGroups: [""]
  resources:
  - configmap
  - configmaps
  verbs: ["get", "list", "watch"]
- apiGroups: ["", "extensions", "apps"]
  resources:
    - pods
    - services
    - deployments
    - secrets
    - statefulsets
  verbs:
    - list
    - watch
    - get
    - update
    - create
    - delete
    - patch
---
# Source: sn-platform/templates/prometheus/pulsar-operators-rbac.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: "release-name-sn-platform-pulsar-operator"
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
rules:
- apiGroups: [""]
  resources:
  - nodes
  - nodes/proxy
  - services
  - endpoints
  - pods
  verbs: ["get", "list", "watch"]
- nonResourceURLs: ["/metrics"]
  verbs: ["get"]
- apiGroups: [""]
  resources:
    - namespaces
    - persistentvolumes
    - persistentvolumeclaims
  verbs:
    - list
    - watch
    - get
    - create
- apiGroups: ["", "extensions", "apps"]
  resources:
    - pods
    - deployments
    - ingresses
    - secrets
    - statefulsets
  verbs:
    - list
    - watch
    - get
    - update
    - create
    - delete
    - patch
- apiGroups: [""]
  resources:
    - replicasets
  verbs:
    - list
    - watch
    - get
- apiGroups: [""]
  resources:
    - events
  verbs:
    - list
    - watch
    - get
- apiGroups:
    - "rbac.authorization.k8s.io"
  resources:
    - clusterrolebindings
    - clusterroles
  verbs:
    - "*"
---
# Source: sn-platform/templates/bookkeeper/bookkeeper-cluster-role-binding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: "release-name-sn-platform-bookie-clusterrolebinding"
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: "release-name-sn-platform-bookie-clusterrole"
subjects:
- kind: ServiceAccount
  name: release-name-sn-platform-bookie-acct
  namespace: snp
---
# Source: sn-platform/templates/broker/broker-cluster-role-binding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: "release-name-sn-platform-broker-clusterrolebinding"
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: "release-name-sn-platform-broker-clusterrole"
subjects:
- kind: ServiceAccount
  name: release-name-sn-platform-broker-acct
  namespace: snp
---
# Source: sn-platform/templates/prometheus/pulsar-operators-rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: "release-name-sn-platform-pulsar-operator-cluster-role-binding"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: "release-name-sn-platform-pulsar-operator"
subjects:
- kind: ServiceAccount
  name: release-name-sn-platform-pulsar-operator
  namespace: snp
---
# Source: sn-platform/templates/vault/vault-service-account.yaml
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-sn-platform-vault-acct-role
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["*"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "update", "patch"]
---
# Source: sn-platform/templates/vault/vault-service-account.yaml
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: release-name-sn-platform-vault-acct-rolebinding
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
roleRef:
  kind: Role
  name: release-name-sn-platform-vault-acct-role
  apiGroup: rbac.authorization.k8s.io
subjects:
  - kind: ServiceAccount
    name: release-name-sn-platform-vault-acct
    namespace: snp
---
# Source: sn-platform/templates/alert-manager/alertmanager-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: Service
metadata:
  name: "release-name-sn-platform-alert-manager"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: alert-manager
  annotations:
            {}
spec:
  ports:
    - name: server
      port: 9093
  selector:
    app: sn-platform
    release: release-name
    component: alert-manager
---
# Source: sn-platform/templates/detector/pulsar-detector-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: Service
metadata:
  name: "release-name-sn-platform-pulsar-detector"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: pulsar-detector
spec:
  ports:
    - name: server
      port: 9000
      protocol: TCP
  selector:
    app: sn-platform
    release: release-name
    component: pulsar-detector
---
# Source: sn-platform/templates/grafana/grafana-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: Service
metadata:
  name: release-name-sn-platform-grafana
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: grafana
  annotations:
spec:
  clusterIP: None
  ports:
    - name: server
      port: 3000
      protocol: TCP
  selector:
    app: sn-platform
    release: release-name
    component: grafana
---
# Source: sn-platform/templates/prometheus/prometheus-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: Service
metadata:
  name: "release-name-sn-platform-prometheus"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: prometheus
  annotations:
    {}
spec:
  clusterIP: None
  ports:
    - name: server
      port: 9090
  selector:
    app: sn-platform
    release: release-name
    component: prometheus
---
# Source: sn-platform/templates/streamnative-console/streamnative-console-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: Service
metadata:
  name: "release-name-sn-platform-streamnative-console"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: streamnative-console
  annotations:
    {}
spec:
  clusterIP: None
  ports:
    - name: frontend
      port: 9527
      protocol: TCP
      targetPort: 9527
    - name: backend
      port: 7750
      protocol: TCP
      targetPort: 7750
  selector:
    app: sn-platform
    release: release-name
    component: streamnative-console
---
# Source: sn-platform/templates/toolset/toolset-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: Service
metadata:
  name: "release-name-sn-platform-toolset"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: toolset
spec:
  clusterIP: None
  selector:
    app: sn-platform
    release: release-name
    component: toolset
---
# Source: sn-platform/templates/node-exporter/node-exporter.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: "release-name-sn-platform-node-exporter"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: node-exporter
    kubernetes.io/cluster-service: "true"
    addonmanager.kubernetes.io/mode: Reconcile
spec:
  selector:
    matchLabels:
      app: sn-platform
      release: release-name
      component: node-exporter
  updateStrategy:
    type: OnDelete
  template:
    metadata:
      labels:
        app: sn-platform
        release: release-name
        cluster: release-name-sn-platform
        component: node-exporter
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9100"
           
    spec:
      containers:
        - name: prometheus-node-exporter
          image: "prom/node-exporter:v1.3.1"
          imagePullPolicy: IfNotPresent
          args:
            - --path.procfs=/host/proc
            - --path.sysfs=/host/sys
          ports:
          volumeMounts:
            - name: proc
              mountPath: /host/proc
              readOnly:  true
            - name: sys
              mountPath: /host/sys
              readOnly: true
      hostNetwork: true
      hostPID: true
      volumes:
        - name: proc
          hostPath:
            path: /proc
        - name: sys
          hostPath:
            path: /sys
---
# Source: sn-platform/templates/alert-manager/alertmanager-deployment.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "release-name-sn-platform-alert-manager"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: alert-manager
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sn-platform
      release: release-name
      component: alert-manager
  template:
    metadata:
      labels:
        app: sn-platform
        release: release-name
        cluster: release-name-sn-platform
        component: alert-manager
      annotations:
    spec:
      terminationGracePeriodSeconds: 0
      containers:
      - name: release-name-sn-platform-alert-manager-configmap-reload
        image: "jimmidyson/configmap-reload:v0.3.0"
        imagePullPolicy: "IfNotPresent"
        args:
          - --volume-dir=/etc/config
          - --webhook-url=http://127.0.0.1:9093/-/reload
        resources:
            {}
        volumeMounts:
          - name: config-volume
            mountPath: /etc/config
            readOnly: true
      - name: "release-name-sn-platform-alert-manager"
        image: "prom/alertmanager:v0.24.0"
        imagePullPolicy: IfNotPresent
        resources:
          requests:
            cpu: 0.1
            memory: 250Mi
        env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: status.podIP
        args:
          - --config.file=/etc/config/alertmanager.yml
          - --cluster.advertise-address=$(POD_IP):6783
          - --storage.path=/alertmanager
        ports:
        - name: server
          containerPort: 9093
        readinessProbe:
          httpGet:
            path: /-/ready
            port: 9093
          initialDelaySeconds: 30
          periodSeconds: 10
          failureThreshold: 10
        volumeMounts:
        - name: config-volume
          mountPath: /etc/config
      volumes:
      - name: config-volume
        configMap:
          name: "release-name-sn-platform-alert-manager"
---
# Source: sn-platform/templates/detector/pulsar-detector-deployment.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "release-name-sn-platform-pulsar-detector"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: pulsar-detector
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sn-platform
      release: release-name
      component: pulsar-detector
  template:
    metadata:
      labels:
        app: sn-platform
        release: release-name
        cluster: release-name-sn-platform
        component: pulsar-detector
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9000"
        
    spec:
      serviceAccountName: release-name-sn-platform-pulsar-detector-acct
      terminationGracePeriodSeconds: 30
      initContainers:
      # This init container will wait for zookeeper to be ready before
      # deploying the bookies
      - name: wait-zookeeper-ready
        image: "streamnative/sn-platform:2.9.2.20"
        imagePullPolicy: IfNotPresent
        command: ["sh", "-c"]
        args:
          - >-
            until bin/pulsar zookeeper-shell -server release-name-sn-platform-zookeeper:2181 get /admin/clusters/release-name-sn-platform; do
              sleep 3;
            done;
        resources:
          limits: {}
          requests:
            cpu: "0.1"
            memory: 256Mi
      # This init container will wait for at least one broker to be ready before
      # deploying the pulsar-detector
      - name: wait-broker-ready
        image: "streamnative/sn-platform:2.9.2.20"
        imagePullPolicy: IfNotPresent
        command: ["sh", "-c"]
        args:
          - >-
            set -e;
            brokerServiceNumber="$(nslookup -timeout=10 release-name-sn-platform-broker | grep Name | wc -l)";
            until [ ${brokerServiceNumber} -ge 1 ]; do
              echo "pulsar cluster release-name-sn-platform isn't initialized yet ... check in 10 seconds ...";
              sleep 10;
              brokerServiceNumber="$(nslookup -timeout=10 release-name-sn-platform-broker | grep Name | wc -l)";
            done;
        resources:
          limits: {}
          requests:
            cpu: "0.1"
            memory: 256Mi
      containers:
      - name: "release-name-sn-platform-pulsar-detector"
        image: "streamnative/sn-platform:2.9.2.20"
        imagePullPolicy: IfNotPresent
        command: ["sh", "-c"]
        args:
        - >
          bin/pulsar-detector -service-url pulsar://release-name-sn-platform-broker.snp.svc.cluster.local:6650 -webservice-url http://release-name-sn-platform-broker.snp.svc.cluster.local:8080 -auth-plugin token -auth-params "{\"token\":\"$brokerClientAuthenticationParameters\"}";
        ports:
        # prometheus needs to access /metrics endpoint
        - name: server
          containerPort: 9000
        env:
        - name: brokerClientAuthenticationParameters
          valueFrom:
              secretKeyRef:
                name: release-name-sn-platform-vault-secret-env-injection
                key: brokerClientAuthenticationParameters
---
# Source: sn-platform/templates/grafana/grafana-statefulset.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: "release-name-sn-platform-grafana"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: grafana
spec:
  serviceName: "release-name-sn-platform-grafana"
  replicas: 1
  selector:
    matchLabels:
      app: sn-platform
      release: release-name
      component: grafana
  updateStrategy:
    type: RollingUpdate
  podManagementPolicy: OrderedReady
  template:
    metadata:
      labels:
        app: sn-platform
        release: release-name
        cluster: release-name-sn-platform
        component: grafana
      annotations:
        checksum/config: a02f93e1297d7dfe883faaf0345d6b103bffb25b6c0475f059bbe221671886bd
    spec:
      terminationGracePeriodSeconds: 0
      securityContext:
        fsGroup: 472
        runAsGroup: 472
        runAsNonRoot: true
        runAsUser: 472
      containers:
      - name: "release-name-sn-platform-grafana"
        image: "streamnative/apache-pulsar-grafana-dashboard-k8s:0.0.17"
        imagePullPolicy: IfNotPresent
        resources:
          requests:
            cpu: 0.1
            memory: 250Mi
        ports:
        - name: server
          containerPort: 3000
        env:
        # for supporting apachepulsar/pulsar-grafana
        - name: PROMETHEUS_URL
          value: http://release-name-sn-platform-prometheus:9090/
        # for supporting streamnative/apache-pulsar-grafana-dashboard
        - name: PULSAR_PROMETHEUS_URL
          value: http://release-name-sn-platform-prometheus:9090/
        - name: PULSAR_CLUSTER
          value: release-name-sn-platform
        - name: GF_LOKI_URL
          value: http://release-name-loki.default.svc.cluster.local:3100/
        - name: GF_LOKI_DATASOURCE_NAME
          value: release-name-loki
        - name: GRAFANA_ADMIN_USER
          valueFrom:
            secretKeyRef:
              name: "release-name-sn-platform-grafana-secret"
              key: GRAFANA_ADMIN_USER
        - name: GRAFANA_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: "release-name-sn-platform-grafana-secret"
              key: GRAFANA_ADMIN_PASSWORD
        - name: GRAFANA_CFG_FILE
          value: /pulsar/conf/grafana.ini
        - name: GF_PATHS_DATA
          value: /var/lib/grafana/pulsar/data
        - name: GF_PATHS_PLUGINS
          value: /var/lib/grafana/pulsar/plugin
        - name: GF_PATHS_PROVISIONING
          value: /var/lib/grafana/pulsar_provisioning
        - name: GRAFANA_DOMAIN
          value: admin.release-name.test.pulsar.example.local
        - name: GRAFANA_ROOT_URL
          value: /grafana/
        - name: GRAFANA_SERVE_FROM_SUB_PATH
          value: "true"
        volumeMounts:
        - name: "cfg"
          mountPath: "/pulsar/conf/grafana.ini"
          subPath: grafana.ini
        - name: "release-name-sn-platform-grafana-data"
          mountPath: /var/lib/grafana/pulsar
      volumes:
      - name: "cfg"
        configMap:
          name: "release-name-sn-platform-grafana"
  volumeClaimTemplates:
  - metadata:
      name: "release-name-sn-platform-grafana-data"
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 10Gi
---
# Source: sn-platform/templates/prometheus/prometheus-statefulset.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: "release-name-sn-platform-prometheus"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: prometheus
spec:
  serviceName: "release-name-sn-platform-prometheus"
  replicas: 1
  selector:
    matchLabels:
      app: sn-platform
      release: release-name
      component: prometheus
  updateStrategy:
    type: RollingUpdate
  podManagementPolicy: Parallel
  template:
    metadata:
      labels:
        app: sn-platform
        release: release-name
        cluster: release-name-sn-platform
        component: prometheus
      annotations:
    spec:
      serviceAccount: release-name-sn-platform-pulsar-operator
      terminationGracePeriodSeconds: 0
      securityContext:
        fsGroup: 65534
        runAsGroup: 65534
        runAsNonRoot: true
        runAsUser: 65534
      affinity:        
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: "app"
                      operator: In
                      values:
                        - "sn-platform"
                    - key: "release"
                      operator: In
                      values:
                        - release-name
                    - key: "component"
                      operator: In
                      values:
                        - prometheus
                topologyKey: "kubernetes.io/hostname"
              
            
        
      containers:
      - name: release-name-sn-platform-prometheus-configmap-reload
        image: "jimmidyson/configmap-reload:v0.3.0"
        imagePullPolicy: "IfNotPresent"
        args:
          - --volume-dir=/etc/config
          - --webhook-url=http://127.0.0.1:9090/-/reload
        resources:
          {}
        volumeMounts:
          - name: config-volume
            mountPath: /etc/config
            readOnly: true
      - name: "release-name-sn-platform-prometheus"
        image: "prom/prometheus:v2.36.1"
        imagePullPolicy: IfNotPresent
        resources:
          requests:
            cpu: 0.1
            memory: 256Mi
        args:
          - --config.file=/etc/config/prometheus.yml
          - --storage.tsdb.retention.time=15d
          - --storage.tsdb.path=/prometheus
          - --web.console.libraries=/etc/prometheus/console_libraries
          - --web.console.templates=/etc/prometheus/consoles
          - --web.enable-lifecycle
  
          
          - --storage.tsdb.wal-compression
        ports:
        - name: server
          containerPort: 9090
        readinessProbe:
          httpGet:
            path: /-/ready
            port: 9090
          initialDelaySeconds: 30
          periodSeconds: 10
          failureThreshold: 10
        livenessProbe:
          httpGet:
            path: /-/healthy
            port: 9090
          initialDelaySeconds: 30
          periodSeconds: 10
          failureThreshold: 10
        volumeMounts:
        - name: config-volume
          mountPath: /etc/config
        - name: "release-name-sn-platform-prometheus-data"
          mountPath: /prometheus
        
        - mountPath: "/pulsar/tokens"
          name: client-token
          readOnly: true
      volumes:
      - name: config-volume
        configMap:
          name: "release-name-sn-platform-prometheus"
      - name: "release-name-sn-platform-prometheus-data"
        persistentVolumeClaim:
          claimName: "release-name-sn-platform-prometheus-data"
      
      - name: client-token
        secret:
          secretName: "release-name-token-admin"
          items:
            - key: TOKEN
              path: client/token
---
# Source: sn-platform/templates/streamnative-console/streamnative-console-statefulset.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: "release-name-sn-platform-streamnative-console"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: streamnative-console
spec:
  serviceName: "release-name-sn-platform-streamnative-console"
  replicas: 1
  selector:
    matchLabels:
      app: sn-platform
      release: release-name
      component: streamnative-console
  updateStrategy:
    type: RollingUpdate
  podManagementPolicy: Parallel
  template:
    metadata:
      labels:
        app: sn-platform
        release: release-name
        cluster: release-name-sn-platform
        component: streamnative-console
      annotations:
    spec:
      terminationGracePeriodSeconds: 0
      initContainers:
      # This init container will wait for broker to be ready before
      # deploying the pulsar manager
      - name: wait-broker-ready
        image: "streamnative/sn-platform:2.9.2.20"
        imagePullPolicy: IfNotPresent
        command: ["sh", "-c"]
        args:
          - >
            set -e; while [ "$(curl -s -o /dev/null -w '%{http_code}' http://release-name-sn-platform-broker:8080/status.html)" -ne "200" ]; do echo "pulsar cluster isn't initialized yet..."; sleep 5; done;
            echo "broker cluster is ready";
        resources:
          limits: {}
          requests:
            cpu: 0.1
            memory: 250Mi
      containers:
        - name: "release-name-sn-platform-streamnative-console"
          image: "streamnative/sn-platform-console:v1.13.0"
          imagePullPolicy: IfNotPresent
          resources:
            limits: {}
            requests:
              cpu: 0.1
              memory: 250Mi
          readinessProbe:
            tcpSocket:
              port: 7750
            initialDelaySeconds: 10
            periodSeconds: 30
            failureThreshold: 10
          livenessProbe:
            tcpSocket:
              port: 7750
            initialDelaySeconds: 10
            periodSeconds: 30
            failureThreshold: 10
          env:
          - name: SPRING_CONFIGURATION_FILE
            value: /pulsar-manager/pulsar-manager/application.properties
          - name: DEFAULT_ORGANIZATION
            value: streamnative
          - name: DEFAULT_NAME
            value: 
          - name: INSTANCE_NAME
            value: pulsar
          - name: CONNECTOR_ENABLED
            value: "true"
          - name: WEB_SERVICE_URL
            value: http://release-name-sn-platform-broker.snp.svc.cluster.local:8080
          - name: KOP_SERVICE_URL
            value: :9093
          envFrom:
          - secretRef:
              name: release-name-sn-platform-vault-secret-env-injection
          ports:
          - name: frontend
            containerPort: 9527
          - name: backend
            containerPort: 7750

          volumeMounts:
          - name: streamnative-console-data
            mountPath: /data
      volumes:
      - name: streamnative-console-data
        persistentVolumeClaim:
          claimName: "release-name-sn-platform-streamnative-console-data"
      serviceAccountName: release-name-sn-platform-streamnative-console-acct
---
# Source: sn-platform/templates/toolset/toolset-statefulset.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: "release-name-sn-platform-toolset"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: toolset
spec:
  serviceName: "release-name-sn-platform-toolset"
  replicas: 1
  updateStrategy:
    type: RollingUpdate
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app: sn-platform
      release: release-name
      component: toolset
  template:
    metadata:
      labels:
        app: sn-platform
        release: release-name
        cluster: release-name-sn-platform
        component: toolset
      annotations:
        checksum/config: 23e7deb985866a3c3dcb197f9c07de7327bb65fd9a3ad54a404d9b8634d1ab19
    spec:
      terminationGracePeriodSeconds: 0
      containers:
      - name: "pulsar"
        
        image: "streamnative/sn-platform:2.9.2.20"
        imagePullPolicy: IfNotPresent
        resources:
          requests:
            cpu: 0.1
            memory: 256Mi
        command: ["sh", "-c"]
        args:
        - >
          bin/apply-config-from-env.py conf/client.conf;
          bin/apply-config-from-env.py conf/bookkeeper.conf;
          
          echo "Configuring pulsarctl context ...";
          mkdir -p /root/.config/pulsar;
          cp /pulsar/conf/pulsarctl.config /root/.config/pulsar/config;
          echo "Successfully configured pulsarctl context.";
          sleep 10000000000
        envFrom:
        - configMapRef:
            name: "release-name-sn-platform-toolset"
        env:
        volumeMounts:
        
        
        - mountPath: "/pulsar/tokens"
          name: client-token
          readOnly: true
        - name: "release-name-sn-platform-toolset-log4j2"
          mountPath: "/pulsar/conf/log4j2.yaml"
          subPath: log4j2.yaml
        - name: "release-name-sn-platform-toolset-pulsarctl"
          mountPath: "/pulsar/conf/pulsarctl.config"
          subPath: pulsarctl.config
      volumes:
      
      
      - name: client-token
        secret:
          secretName: "release-name-token-admin"
          items:
            - key: TOKEN
              path: client/token
      - name: "release-name-sn-platform-toolset-log4j2"
        configMap:
          name: "release-name-sn-platform-toolset"
      
      - name: "release-name-sn-platform-toolset-pulsarctl"
        configMap:
          name: "release-name-sn-platform-toolset"
      serviceAccountName: release-name-sn-platform-toolset-acct
---
# Source: sn-platform/templates/streamnative-console/streamnative-console-initialize.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: batch/v1
kind: Job
metadata:
  name: "release-name-sn-platform-streamnative-console-init"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: streamnative-console
spec:
  template:
    metadata:
      labels:
        app: sn-platform
        release: release-name
        cluster: release-name-sn-platform
    spec:
      initContainers:
        # This init container will wait for broker to be ready before
        # deploying the pulsar manager init job
        - name: wait-broker-ready
          image: "streamnative/sn-platform:2.9.2.20"
          imagePullPolicy: IfNotPresent
          command: ["sh", "-c"]
          args:
            - >
              set -e; while [ "$(curl -s -o /dev/null -w '%{http_code}' http://release-name-sn-platform-broker:8080/status.html)" -ne "200" ]; do echo "pulsar cluster isn't initialized yet..."; sleep 5; done;
              echo "broker cluster is ready";
          resources:
            limits: {}
            requests:
              cpu: 0.1
              memory: 250Mi
      containers:
      - name: "release-name-sn-platform-streamnative-console-init"
        image: "streamnative/sn-platform-console:v1.13.0"
        imagePullPolicy: IfNotPresent
        env:
        - name: SPRING_CONFIGURATION_FILE
          value: /pulsar-manager/pulsar-manager/application.properties
        - name: DEFAULT_ORGANIZATION
          value: streamnative
        - name: INSTANCE_NAME
          value: pulsar
        - name: WEB_SERVICE_URL
          value: http://release-name-sn-platform-broker.snp.svc.cluster.local:8080
        - name: KOP_SERVICE_URL
          value: release-name-sn-platform-broker.snp.svc.cluster.local:9092
        - name: STREAMNATIVE_CONSOLE_BACKEND_URL
          value: http://release-name-sn-platform-streamnative-console:7750
        envFrom:
        - secretRef:
            name: release-name-sn-platform-vault-secret-env-injection
        volumeMounts:
        - name: "release-name-sn-platform-streamnative-console-init-instance"
          mountPath: "/root/init_instance/"
        command: ["sh", "-c"]
        args:
          - >
            python3 /root/init_instance/init_instance.py 2>/dev/null;
            until [ $? -eq 0 ]; do
              echo "streamnative console is not ready now! wait another 10s~";
              sleep 10;
              python3 /root/init_instance/init_instance.py 2>/dev/null;
            done;
            echo "StreamNative Console is ready to use~";
            curl -sf -XPOST http://127.0.0.1:15020/quitquitquit || true;
      restartPolicy: Never
      serviceAccountName: release-name-sn-platform-streamnative-console-acct
      volumes:
        - name: "release-name-sn-platform-streamnative-console-init-instance"
          configMap:
            name: "release-name-sn-platform-streamnative-console-init-instance"
---
# Source: sn-platform/templates/vault/vault-initialize-public-key.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: batch/v1
kind: Job
metadata:
  name: "release-name-sn-platform-vault-init-public-key"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: "bookie-init"
spec:
  template:
    metadata:
      labels:
        app: sn-platform
        release: release-name
        cluster: release-name-sn-platform    
        app.nomura.com/cmdb-instance-id: vault-operator
        app.nomura.com/environment: vault-operator
        app.nomura.com/sdlc-component: vault-operator
      annotations:    
        prometheus.io/port: "9091"
    spec:
      serviceAccountName: release-name-sn-platform-vault-acct
      containers:
      - name: "release-name-sn-platform-vault-init"
        image: "streamnative/pulsar_vault_init:v1.0.5"
        imagePullPolicy: IfNotPresent
        command: ["sh", "-c"]
        args:
          - >
           tokenLen=$(kubectl get secret release-name-sn-platform-vault-unseal-keys -o jsonpath='{.data.vault-root}'|wc -m);
           until [ ${tokenLen} -gt 1 ]; do
             echo "current token is empty ! wait another 10s~"
             sleep 10;
             tokenLen=$(kubectl get secret release-name-sn-platform-vault-unseal-keys -o jsonpath='{.data.vault-root}'|wc -m);
           done;
           echo "vault root token is ready";
           rootToken=$(kubectl get secret release-name-sn-platform-vault-unseal-keys -o jsonpath='{.data.vault-root}'|base64 -d);
           echo $rootToken;
           echo $rootToken > /root/rootToken;
           export ROOT_TOKEN=$rootToken;
           vault login $ROOT_TOKEN;
           until [ $? -eq 0 ]; do
              echo "vault is not ready now, wait another 5s~";
              sleep 5;
              vault login $ROOT_TOKEN;
           done;
           echo "vault is ready~";
           echo "Start init public key to secret";
           publicKey=$(wget -qO- http://release-name-sn-platform-vault:8200/v1/identity/oidc/.well-known/keys | base64 | tr -d \\n);
           kubectl patch secret release-name-sn-platform-vault-public-key --type='json' -p='[{"op":"replace","path":"/data/publicKey","value":"'$publicKey'"}]' -n snp;
           echo -ne "POST /quitquitquit HTTP/1.1\r\nHost: 127.0.0.1:15020\r\nUser-Agent: curl/7.68.0\r\nAccept: */*\r\n\r\n"|nc 127.0.0.1:15020 || true;
        env:
        - name: VAULT_ADDR
          value: http://release-name-sn-platform-vault:8200
      restartPolicy: Never
---
# Source: sn-platform/templates/vault/vault-initialize.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: batch/v1
kind: Job
metadata:
  name: "release-name-sn-platform-vault-init"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: "vault-init"
spec:
  template:
    metadata:
      labels:
        app: sn-platform
        release: release-name
        cluster: release-name-sn-platform    
        app.nomura.com/cmdb-instance-id: vault-operator
        app.nomura.com/environment: vault-operator
        app.nomura.com/sdlc-component: vault-operator
      annotations:    
        prometheus.io/port: "9091"
    spec:
      serviceAccountName: release-name-sn-platform-vault-acct
      containers:
      - name: "release-name-sn-platform-vault-init"
        image: "streamnative/pulsar_vault_init:v1.0.5"
        imagePullPolicy: IfNotPresent
        command: ["sh", "-c"]
        args:
          - >
           tokenLen=$(kubectl get secret release-name-sn-platform-vault-unseal-keys -o jsonpath='{.data.vault-root}'|wc -m);
           until [ ${tokenLen} -gt 1 ]; do
             echo "current token is empty ! wait another 10s~"
             sleep 10;
             tokenLen=$(kubectl get secret release-name-sn-platform-vault-unseal-keys -o jsonpath='{.data.vault-root}'|wc -m);
           done;
           echo "vault root token is ready";
           rootToken=$(kubectl get secret release-name-sn-platform-vault-unseal-keys -o jsonpath='{.data.vault-root}'|base64 -d);
           echo $rootToken;
           echo $rootToken > /root/rootToken;
           export ROOT_TOKEN=$rootToken;
           vault login $ROOT_TOKEN;
           until [ $? -eq 0 ]; do
              echo "vault is not ready now, wait another 5s~";
              sleep 5;
              vault login $ROOT_TOKEN;
           done;
           echo "vault is ready~";

           cd /root/pulsar/create_pulsar_tokens && /usr/local/bin/zsh create_pulsar_tokens.sh -n snp -k release-name -v http://release-name-sn-platform-vault:8200 -r $ROOT_TOKEN && cd /root/pulsar/init_vault_streamnative_console && /usr/local/bin/zsh startup.sh;
           echo -ne "POST /quitquitquit HTTP/1.1\r\nHost: 127.0.0.1:15020\r\nUser-Agent: curl/7.68.0\r\nAccept: */*\r\n\r\n"|nc 127.0.0.1:15020 || true;
        env:
        - name: NAMESPACE
          value: snp
        - name: VAULT_SECRET_KEY_NAME
          value: release-name-sn-platform-vault-secret-env-injection
        - name: CONSOLE_SECRET_KEY_NAME
          value: release-name-sn-platform-vault-console-admin-passwd
        - name: TOOLSET_TOKEN_SECRET_NAME
          value: "release-name-token-admin"
        - name: VAULT_ADDR
          value: http://release-name-sn-platform-vault:8200
        - name: VAULT_TTL
          value: 12h
        volumeMounts:
        - name: "release-name-sn-platform-vault-create-pulsar-tokens"
          mountPath: "/root//pulsar/create_pulsar_tokens/"
        - name: "release-name-sn-platform-vault-init-streamnative-console"
          mountPath: "/root//pulsar/init_vault_streamnative_console/"
      volumes:
      - name: "release-name-sn-platform-vault-create-pulsar-tokens"
        configMap:
          name: "release-name-sn-platform-vault-create-pulsar-tokens"
      - name: "release-name-sn-platform-vault-init-streamnative-console"
        configMap:
          name: "release-name-sn-platform-vault-init-streamnative-console"
      restartPolicy: Never
---
# Source: sn-platform/templates/control-center/control-center-ingress.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: "release-name-sn-platform-control-center-ingress"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
  annotations:
    ingress.kubernetes.io/ssl-redirect: "false"
    kubernetes.io/ingress.class: nginx
spec:
  rules:
    - http:
        paths:
          - path: /grafana
            pathType: ImplementationSpecific
            backend:
              service:
                name: "release-name-sn-platform-grafana"
                port:
                  number: 3000
          - path: /
            pathType: ImplementationSpecific
            backend:
              service:
                name: "release-name-sn-platform-streamnative-console"
                port: 
                  number: 9527
---
# Source: sn-platform/templates/bookkeeper/bookkeeper-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/bookkeeper/bookkeeper-role-binding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/bookkeeper/bookkeeper-storageclass.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/broker/broker-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/broker/broker-configmap-functionmesh.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/broker/broker-role-binding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/broker/broker-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/control-center/control-center-gateway.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/control-center/control-center-virtualservice.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/control-center/ingress-controller-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/control-center/ingress-controller-deployment.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/control-center/ingress-controller-rbac.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/control-center/ingress-controller-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/custom-metric-server/custom-metric-server-init.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/custom-metric-server/custom-metric-server-prometheus.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/custom-metric-server/custom-metric-server.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/detector/pulsar-detector-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/entities/connection.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
# deploy entities only when `components.entities` is true
---
# Source: sn-platform/templates/entities/namespaces.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
# deploy entities only when `components.entities` is true
---
# Source: sn-platform/templates/entities/permissions.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
# deploy entities only when `components.entities` is true
---
# Source: sn-platform/templates/entities/tenants.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
# deploy entities only when `components.entities` is true
---
# Source: sn-platform/templates/entities/topics.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
# deploy entities only when `components.entities` is true
---
# Source: sn-platform/templates/external-dns/external-dns-rbac.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/external-dns/external-dns.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/extra.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/function-worker/function-worker-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/function-worker/function-worker-cluster-role-binding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/function-worker/function-worker-role-binding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/function-worker/function-worker-service-account.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/function-worker/function-worker-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/function-worker/function-worker-statefulset.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/grafana/grafana-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/grafana/grafana-azuread-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/grafana/grafana-deployment.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/grafana/grafana-storageclass.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/grafana/loki-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/istio/default-peerauthentication.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/namespace.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/openshift/scc-role.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/openshift/scc-rolebinding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/openshift/scc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/presto/presto-authrozationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/presto/presto-coordinator-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/presto/presto-coordinator-statefulset.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/presto/presto-destinationrule.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/presto/presto-gateway.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/presto/presto-service-ingress.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/presto/presto-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/presto/presto-serviceentry.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/presto/presto-virtualservice.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/presto/presto-worker-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/presto/presto-worker-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/presto/presto-worker-statefulset.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/prometheus/prometheus-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/prometheus/prometheus-storageclass.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/proxy/proxy-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/pulsar-coordinator/pulsar-coordinator.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/streamnative-console/streamnative-console-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/streamnative-console/streamnative-console-azure-oauth2-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/streamnative-console/streamnative-console-google-oauth2-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/streamnative-console/streamnative-console-okta-oauth2-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/streamnative-console/streamnative-console-storageclass.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/tls/istio/tls-cert-internal-issuer.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/tls/istio/tls-cert-public-issuer.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/tls/istio/tls-certs.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/tls/keytool.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

# script to process key/cert to keystore and truststore
---
# Source: sn-platform/templates/tls/tls-cert-internal-issuer.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/tls/tls-cert-public-issuer.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/tls/tls-certs-internal.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/tls/tls-certs-public.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/vault/vault-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/zookeeper/zookeeper-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/zookeeper/zookeeper-backup-clusterrolebinding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/zookeeper/zookeeper-backup-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

# deploy zookeeper only when `zookeeper.customTools.backup.enable` is true
---
# Source: sn-platform/templates/zookeeper/zookeeper-backup-rolebinding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/zookeeper/zookeeper-backup-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

# deploy zookeeper only when `zookeeper.customTools.backup.enable` is true
---
# Source: sn-platform/templates/zookeeper/zookeeper-backup-statefulset.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

# deploy zookeeper only when `zookeeper.customTools.backup.enable` is true
---
# Source: sn-platform/templates/zookeeper/zookeeper-restore-clusterrolebinding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/zookeeper/zookeeper-restore-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

# deploy zookeeper only when `zookeeper.customTools.restore.enable` is true
---
# Source: sn-platform/templates/zookeeper/zookeeper-restore-rolebinding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform/templates/zookeeper/zookeeper-storageclass.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

# deploy zookeeper only when `components.zookeeper` is true

# define the storage class for data directory
---
# Source: sn-platform/templates/zookeeper/zookeeper-storageclass.yaml
# define the storage class for dataLog directory
---
# Source: sn-platform/templates/bookkeeper/bookkeeper-cluster.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
# deploy BookKeeperCluster only when `components.bookkeeper and operator.enabled` is true
apiVersion: bookkeeper.streamnative.io/v1alpha1
kind: BookKeeperCluster
metadata:
  name: "release-name-sn-platform-bookie"
  namespace: snp
  annotations:
    "cloud.streamnative.io/enable-config-prefix": "false"
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: bookie
spec:
  zkServers: "release-name-sn-platform-zookeeper:2181"
  replicas: 3
  image: "streamnative/sn-platform:2.9.2.20"
  imagePullPolicy: IfNotPresent
  pod:
    serviceAccountName: release-name-sn-platform-bookie-acct
    labels:
      app: sn-platform
      release: release-name
      cluster: release-name-sn-platform
      component: bookie
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8000"
      
    affinity:      
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: "app"
                    operator: In
                    values:
                      - "sn-platform"
                  - key: "release"
                    operator: In
                    values:
                      - release-name
                  - key: "component"
                    operator: In
                    values:
                      - bookie
              topologyKey: "kubernetes.io/hostname"
            
          
      
    resources:
      requests:
        cpu: "0.2"
        memory: 512Mi
    terminationGracePeriodSeconds: 30
    jvmOptions:
      memoryOptions:
      - |
        -Xms128m -Xmx256m -XX:MaxDirectMemorySize=256m
      gcOptions:
      - |
        -XX:+UseG1GC -XX:MaxGCPauseMillis=10 -XX:+ParallelRefProcEnabled -XX:+UnlockExperimentalVMOptions -XX:+AggressiveOpts -XX:+DoEscapeAnalysis -XX:ParallelGCThreads=4 -XX:ConcGCThreads=4 -XX:G1NewSizePercent=50 -XX:+DisableExplicitGC -XX:-ResizePLAB -XX:+ExitOnOutOfMemoryError -XX:+PerfDisableSharedMem -verbosegc -Xlog:gc:/var/log/bookie-gc.log
  storage:
    journal:
      numVolumes: 1
      numDirsPerVolume: 1
      volumeClaimTemplate:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 10Gi
        
    ledger:
      numVolumes: 1
      numDirsPerVolume: 1
      volumeClaimTemplate:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 50Gi
        
    reclaimPolicy: Delete
  config:
    custom:
      zkLedgersRootPath: "/ledgers"
      # enable bookkeeper http server
      httpServerEnabled: "true"
      httpServerPort: "8000"
      # config the stats provider
      statsProviderClass: org.apache.bookkeeper.stats.prometheus.PrometheusMetricsProvider
      # use hostname as the bookie id
      useHostNameAsBookieID: "true"
      # disable auto recovery on bookies since we will start AutoRecovery in separated pods
      autoRecoveryDaemonEnabled: "false"
      # Do not retain journal files as it increase the disk utilization
      journalMaxBackups: "0"
      
      log4j2.yaml: |
        #
        # Licensed to the Apache Software Foundation (ASF) under one
        # or more contributor license agreements.  See the NOTICE file
        # distributed with this work for additional information
        # regarding copyright ownership.  The ASF licenses this file
        # to you under the Apache License, Version 2.0 (the
        # "License"); you may not use this file except in compliance
        # with the License.  You may obtain a copy of the License at
        #
        #   http://www.apache.org/licenses/LICENSE-2.0
        #
        # Unless required by applicable law or agreed to in writing,
        # software distributed under the License is distributed on an
        # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        # KIND, either express or implied.  See the License for the
        # specific language governing permissions and limitations
        # under the License.
        #
      
      
        Configuration:
          status: INFO
          monitorInterval: 30
          name: pulsar
          packages: io.prometheus.client.log4j2
      
          Properties:
            Property:
              - name: "pulsar.log.dir"
                value: "logs"
              - name: "pulsar.log.file"
                value: "pulsar.log"
              - name: "pulsar.log.appender"
                value: "RoutingAppender"
              - name: "pulsar.log.root.level"
                value: "info"
              - name: "pulsar.log.level"
                value: "info"
              - name: "pulsar.routing.appender.default"
                value: "Console"
      
          # Example: logger-filter script
          Scripts:
            ScriptFile:
              name: filter.js
              language: JavaScript
              path: ./conf/log4j2-scripts/filter.js
              charset: UTF-8
      
          Appenders:
      
            # Console
            Console:
              name: Console
              target: SYSTEM_OUT
              PatternLayout:
                Pattern: "%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"
      
            # Rolling file appender configuration
            RollingFile:
              name: RollingFile
              fileName: "${sys:pulsar.log.dir}/${sys:pulsar.log.file}"
              filePattern: "${sys:pulsar.log.dir}/${sys:pulsar.log.file}-%d{MM-dd-yyyy}-%i.log.gz"
              immediateFlush: false
              PatternLayout:
                Pattern: "%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"
              Policies:
                TimeBasedTriggeringPolicy:
                  interval: 1
                  modulate: true
                SizeBasedTriggeringPolicy:
                  size: 1 GB
              # Delete file older than 30days
              DefaultRolloverStrategy:
                  Delete:
                    basePath: ${sys:pulsar.log.dir}
                    maxDepth: 2
                    IfFileName:
                      glob: "*/${sys:pulsar.log.file}*log.gz"
                    IfLastModified:
                      age: 30d
      
            Prometheus:
              name: Prometheus
      
            # Routing
            Routing:
              name: RoutingAppender
              Routes:
                pattern: "$${ctx:function}"
                Route:
                  -
                    Routing:
                      name: InstanceRoutingAppender
                      Routes:
                        pattern: "$${ctx:instance}"
                        Route:
                          -
                            RollingFile:
                              name: "Rolling-${ctx:function}"
                              fileName : "${sys:pulsar.log.dir}/functions/${ctx:function}/${ctx:functionname}-${ctx:instance}.log"
                              filePattern : "${sys:pulsar.log.dir}/functions/${sys:pulsar.log.file}-${ctx:instance}-%d{MM-dd-yyyy}-%i.log.gz"
                              PatternLayout:
                                Pattern: "%d{ABSOLUTE} %level{length=5} [%thread] [instance: %X{instance}] %logger{1} - %msg%n"
                              Policies:
                                TimeBasedTriggeringPolicy:
                                  interval: 1
                                  modulate: true
                                SizeBasedTriggeringPolicy:
                                  size: "20MB"
                                # Trigger every day at midnight that also scan
                                # roll-over strategy that deletes older file
                                CronTriggeringPolicy:
                                  schedule: "0 0 0 * * ?"
                              # Delete file older than 30days
                              DefaultRolloverStrategy:
                                  Delete:
                                    basePath: ${sys:pulsar.log.dir}
                                    maxDepth: 2
                                    IfFileName:
                                      glob: "*/${sys:pulsar.log.file}*log.gz"
                                    IfLastModified:
                                      age: 30d
                          - ref: "${sys:pulsar.routing.appender.default}"
                            key: "${ctx:function}"
                  - ref: "${sys:pulsar.routing.appender.default}"
                    key: "${ctx:function}"
      
          Loggers:
      
            # Default root logger configuration
            Root:
              level: "${sys:pulsar.log.root.level}"
              additivity: true
              AppenderRef:
                - ref: "${sys:pulsar.log.appender}"
                  level: "${sys:pulsar.log.level}"
                - ref: Prometheus
                  level: info
      
            Logger:
              - name: org.apache.bookkeeper.bookie.BookieShell
                level: info
                additivity: false
                AppenderRef:
                  - ref: Console
      
              - name: verbose
                level: info
                additivity: false
                AppenderRef:
                  - ref: Console
      
            # Logger to inject filter script
        #     - name: org.apache.bookkeeper.mledger.impl.ManagedLedgerImpl
        #       level: debug
        #       additivity: false
        #       AppenderRef:
        #         ref: "${sys:pulsar.log.appender}"
        #         ScriptFilter:
        #           onMatch: ACCEPT
        #           onMisMatch: DENY
        #           ScriptRef:
        #             ref: filter.js
  autoRecovery:
    replicas: 1
    pod:
      labels:
        app: sn-platform
        release: release-name
        cluster: release-name-sn-platform
        component: recovery
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
        
      terminationGracePeriodSeconds: 30
      affinity:        
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: "app"
                      operator: In
                      values:
                        - "sn-platform"
                    - key: "release"
                      operator: In
                      values:
                        - release-name
                    - key: "component"
                      operator: In
                      values:
                        - recovery
                topologyKey: "kubernetes.io/hostname"
              
            
        
      resources:
        requests:
          cpu: "0.05"
          memory: 64Mi
      serviceAccountName: release-name-sn-platform-bookie-acct
      jvmOptions:
        memoryOptions:
        - -Xms64m -Xmx64m
    conf:
      zkServers: "release-name-sn-platform-zookeeper:2181"
      zkLedgersRootPath: "/ledgers"
      # enable bookkeeper http server
      httpServerEnabled: "true"
      httpServerPort: "8000"
      # config the stats provider
      statsProviderClass: org.apache.bookkeeper.stats.prometheus.PrometheusMetricsProvider
      # use hostname as the bookie id
      useHostNameAsBookieID: "true"
      log4j2.yaml: |
        #
        # Licensed to the Apache Software Foundation (ASF) under one
        # or more contributor license agreements.  See the NOTICE file
        # distributed with this work for additional information
        # regarding copyright ownership.  The ASF licenses this file
        # to you under the Apache License, Version 2.0 (the
        # "License"); you may not use this file except in compliance
        # with the License.  You may obtain a copy of the License at
        #
        #   http://www.apache.org/licenses/LICENSE-2.0
        #
        # Unless required by applicable law or agreed to in writing,
        # software distributed under the License is distributed on an
        # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        # KIND, either express or implied.  See the License for the
        # specific language governing permissions and limitations
        # under the License.
        #
      
      
        Configuration:
          status: INFO
          monitorInterval: 30
          name: pulsar
          packages: io.prometheus.client.log4j2
      
          Properties:
            Property:
              - name: "pulsar.log.dir"
                value: "logs"
              - name: "pulsar.log.file"
                value: "pulsar.log"
              - name: "pulsar.log.appender"
                value: "RoutingAppender"
              - name: "pulsar.log.root.level"
                value: "info"
              - name: "pulsar.log.level"
                value: "info"
              - name: "pulsar.routing.appender.default"
                value: "Console"
      
          # Example: logger-filter script
          Scripts:
            ScriptFile:
              name: filter.js
              language: JavaScript
              path: ./conf/log4j2-scripts/filter.js
              charset: UTF-8
      
          Appenders:
      
            # Console
            Console:
              name: Console
              target: SYSTEM_OUT
              PatternLayout:
                Pattern: "%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"
      
            # Rolling file appender configuration
            RollingFile:
              name: RollingFile
              fileName: "${sys:pulsar.log.dir}/${sys:pulsar.log.file}"
              filePattern: "${sys:pulsar.log.dir}/${sys:pulsar.log.file}-%d{MM-dd-yyyy}-%i.log.gz"
              immediateFlush: false
              PatternLayout:
                Pattern: "%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"
              Policies:
                TimeBasedTriggeringPolicy:
                  interval: 1
                  modulate: true
                SizeBasedTriggeringPolicy:
                  size: 1 GB
              # Delete file older than 30days
              DefaultRolloverStrategy:
                  Delete:
                    basePath: ${sys:pulsar.log.dir}
                    maxDepth: 2
                    IfFileName:
                      glob: "*/${sys:pulsar.log.file}*log.gz"
                    IfLastModified:
                      age: 30d
      
            Prometheus:
              name: Prometheus
      
            # Routing
            Routing:
              name: RoutingAppender
              Routes:
                pattern: "$${ctx:function}"
                Route:
                  -
                    Routing:
                      name: InstanceRoutingAppender
                      Routes:
                        pattern: "$${ctx:instance}"
                        Route:
                          -
                            RollingFile:
                              name: "Rolling-${ctx:function}"
                              fileName : "${sys:pulsar.log.dir}/functions/${ctx:function}/${ctx:functionname}-${ctx:instance}.log"
                              filePattern : "${sys:pulsar.log.dir}/functions/${sys:pulsar.log.file}-${ctx:instance}-%d{MM-dd-yyyy}-%i.log.gz"
                              PatternLayout:
                                Pattern: "%d{ABSOLUTE} %level{length=5} [%thread] [instance: %X{instance}] %logger{1} - %msg%n"
                              Policies:
                                TimeBasedTriggeringPolicy:
                                  interval: 1
                                  modulate: true
                                SizeBasedTriggeringPolicy:
                                  size: "20MB"
                                # Trigger every day at midnight that also scan
                                # roll-over strategy that deletes older file
                                CronTriggeringPolicy:
                                  schedule: "0 0 0 * * ?"
                              # Delete file older than 30days
                              DefaultRolloverStrategy:
                                  Delete:
                                    basePath: ${sys:pulsar.log.dir}
                                    maxDepth: 2
                                    IfFileName:
                                      glob: "*/${sys:pulsar.log.file}*log.gz"
                                    IfLastModified:
                                      age: 30d
                          - ref: "${sys:pulsar.routing.appender.default}"
                            key: "${ctx:function}"
                  - ref: "${sys:pulsar.routing.appender.default}"
                    key: "${ctx:function}"
      
          Loggers:
      
            # Default root logger configuration
            Root:
              level: "${sys:pulsar.log.root.level}"
              additivity: true
              AppenderRef:
                - ref: "${sys:pulsar.log.appender}"
                  level: "${sys:pulsar.log.level}"
                - ref: Prometheus
                  level: info
      
            Logger:
              - name: org.apache.bookkeeper.bookie.BookieShell
                level: info
                additivity: false
                AppenderRef:
                  - ref: Console
      
              - name: verbose
                level: info
                additivity: false
                AppenderRef:
                  - ref: Console
      
            # Logger to inject filter script
        #     - name: org.apache.bookkeeper.mledger.impl.ManagedLedgerImpl
        #       level: debug
        #       additivity: false
        #       AppenderRef:
        #         ref: "${sys:pulsar.log.appender}"
        #         ScriptFilter:
        #           onMatch: ACCEPT
        #           onMisMatch: DENY
        #           ScriptRef:
        #             ref: filter.js
  apiObjects:
    clientService: {}
    headlessService:
      metadata:
        name: "release-name-sn-platform-bookie"
    autoRecoveryHeadlessService:
      metadata:
        name: "release-name-sn-platform-recovery"
    bookieStatefulSet:
      metadata:
        name: "release-name-sn-platform-bookie"
      updatePolicy:
        - all
    autoRecoveryStatefulSet:
      metadata:
        name: "release-name-sn-platform-recovery"
      updatePolicy:
        - all
    configMap:
      metadata:
        name: "release-name-sn-platform-bookie"
    autoRecoveryConfigMap:
      metadata:
        name: "release-name-sn-platform-recovery"
    pdb:
      metadata:
        name: "release-name-sn-platform-bookie"
---
# Source: sn-platform/templates/broker/broker-cluster.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
# deploy PulsarBroker only when `components.broker and operator.enabled` is true
apiVersion: pulsar.streamnative.io/v1alpha1
kind: PulsarBroker
metadata:
  # no need to add component to name here as operator will add
  name: "release-name-sn-platform"
  namespace: snp
  annotations:
    "cloud.streamnative.io/enable-config-prefix": "false"
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: broker
spec:
  zkServers: "release-name-sn-platform-zookeeper:2181"
  replicas: 1
  image: "streamnative/sn-platform:2.9.2.20"
  imagePullPolicy: IfNotPresent
  pod:
    serviceAccountName: release-name-sn-platform-broker-acct
    labels:
      app: sn-platform
      release: release-name
      cluster: release-name-sn-platform
      component: broker
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8080"
      prometheus.io/path: "/metrics/"
      
    affinity:      
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: "app"
                    operator: In
                    values:
                      - "sn-platform"
                  - key: "release"
                    operator: In
                    values:
                      - release-name
                  - key: "component"
                    operator: In
                    values:
                      - broker
              topologyKey: "kubernetes.io/hostname"
            
          
      
    vars:
    - name: PULSAR_PREFIX_OIDCTokenAudienceID
      valueFrom:
          secretKeyRef:
            name: release-name-sn-platform-vault-secret-env-injection
            key: PULSAR_PREFIX_OIDCTokenAudienceID
    - name: brokerClientAuthenticationParameters
      valueFrom:
          secretKeyRef:
            name: release-name-sn-platform-vault-secret-env-injection
            key: brokerClientAuthenticationParameters
    # not support envFrom currently
    #envFrom:
    #- secretRef:
    #    name: release-name-sn-platform-vault-secret-env-injection
    resources:
      limits: {}
      requests:
        cpu: "0.2"
        memory: 512Mi
    terminationGracePeriodSeconds: 30
    jvmOptions:
      memoryOptions:
      - |
        -Xms128m -Xmx256m -XX:MaxDirectMemorySize=256m
      gcOptions:
      - |
        -XX:+UseG1GC -XX:MaxGCPauseMillis=10 -Dio.netty.leakDetectionLevel=disabled -Dio.netty.recycler.linkCapacity=1024 -XX:+ParallelRefProcEnabled -XX:+UnlockExperimentalVMOptions -XX:+AggressiveOpts -XX:+DoEscapeAnalysis -XX:ParallelGCThreads=4 -XX:ConcGCThreads=4 -XX:G1NewSizePercent=50 -XX:+DisableExplicitGC -XX:-ResizePLAB -XX:+ExitOnOutOfMemoryError -XX:+PerfDisableSharedMem
  config:
    function:
      enabled: true
      mesh:
        builtinConnectorsRef:
          name: release-name-builtin-connectors
        functionEnabled: true
        sinkEnabled: true
        sourceEnabled: true
        uploadEnabled: true
      type: FunctionMesh
    usePodIPAsAdvertisedAddress: false
    protocolHandlers:
      kop:
        enabled: true
    custom:
      PULSAR_PREFIX_additionalServletDirectory: "./brokerAdditionalServlet"
      managedLedgerDefaultAckQuorum: "2"
      managedLedgerDefaultEnsembleSize: "3"
      managedLedgerDefaultWriteQuorum: "3"
      authenticationEnabled: "true"
      authenticateOriginalAuthData: "true"
      authenticationProviders: "io.streamnative.pulsar.broker.authentication.AuthenticationProviderOIDCToken"
      brokerClientAuthenticationPlugin: "org.apache.pulsar.client.impl.auth.AuthenticationToken"
      PULSAR_PREFIX_vaultHost: http://release-name-sn-platform-vault:8200
      PULSAR_PREFIX_OIDCPublicKeyPath: "http://release-name-sn-platform-vault:8200/v1/identity/oidc/.well-known/keys"
      superUserRoles: "admin"
      authorizationEnabled: "true"
      authorizationProvider: "org.apache.pulsar.broker.authorization.PulsarAuthorizationProvider"
      PULSAR_PREFIX_kafkaTransactionCoordinatorEnabled: "true"
      ## Offloading settings
  initJobPod:
    initContainers:
      - name: cleanup
        image: "streamnative/pulsar-metadata-tool:2.9.2.20"
        command:
          - bash
          - '-c'
        args:
          - "bin/pulsar-metadata-tool cleanup"
        env:
          - name: METADATA_TOOL_CONF
            value: "/pulsar-metadata-tool/conf/pulsar-metadata-tool/pulsar-metadata-tool.properties"
        volumeMounts:
          - name: cleanup-config
            mountPath: /pulsar-metadata-tool/conf/pulsar-metadata-tool
    volumes:
      - name: cleanup-config
        configMap:
          name: "release-name-sn-platform-restore"
    resources:
          limits: {}
          requests:
            cpu: "0.2"
            memory: 512Mi
---
# Source: sn-platform/templates/proxy/proxy-cluster.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
# deploy PulsarProxy only when `components.proxy and operator.enabled` is true
apiVersion: pulsar.streamnative.io/v1alpha1
kind: PulsarProxy
metadata:
  # no need to append component name to pod name here as operator will add
  name: "release-name-sn-platform"
  namespace: snp
  annotations:
    "cloud.streamnative.io/enable-config-prefix": "false"
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: proxy
spec:
  brokerAddress: release-name-sn-platform-broker
  replicas: 1
  image: "streamnative/sn-platform:2.9.2.20"
  imagePullPolicy: IfNotPresent
  pod:
    serviceAccountName: release-name-sn-platform-proxy-acct
    labels:
      app: sn-platform
      release: release-name
      cluster: release-name-sn-platform
      component: proxy
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8080"
    affinity:      
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: "app"
                    operator: In
                    values:
                      - "sn-platform"
                  - key: "release"
                    operator: In
                    values:
                      - release-name
                  - key: "component"
                    operator: In
                    values:
                      - proxy
              topologyKey: "kubernetes.io/hostname"
            
          
      
    vars:
    - name: PULSAR_PREFIX_OIDCTokenAudienceID
      valueFrom:
          secretKeyRef:
            name: release-name-sn-platform-vault-secret-env-injection
            key: PULSAR_PREFIX_OIDCTokenAudienceID
    - name: brokerClientAuthenticationParameters
      valueFrom:
          secretKeyRef:
            name: release-name-sn-platform-vault-secret-env-injection
            key: brokerClientAuthenticationParameters
    - name: PROXY_TOKEN
      valueFrom:
          secretKeyRef:
            name: release-name-sn-platform-vault-secret-env-injection
            key: brokerClientAuthenticationParameters
    #envFrom:
    #- secretRef:
    #    name: release-name-sn-platform-vault-secret-env-injection
    resources:
      requests:
        cpu: "0.2"
        memory: 128Mi
    terminationGracePeriodSeconds: 30
    jvmOptions:
      memoryOptions:
      - |
        -Xms64m -Xmx64m -XX:MaxDirectMemorySize=64m
      gcOptions:
      - |
        -XX:+UseG1GC -XX:MaxGCPauseMillis=10 -Dio.netty.leakDetectionLevel=disabled -Dio.netty.recycler.linkCapacity=1024 -XX:+ParallelRefProcEnabled -XX:+UnlockExperimentalVMOptions -XX:+AggressiveOpts -XX:+DoEscapeAnalysis -XX:ParallelGCThreads=4 -XX:ConcGCThreads=4 -XX:G1NewSizePercent=50 -XX:+DisableExplicitGC -XX:-ResizePLAB -XX:+ExitOnOutOfMemoryError -XX:+PerfDisableSharedMem
  config:
    usePodIPAsAdvertisedAddress: false
    tls:
      enabled: false
    custom:
      authenticationEnabled: "true"
      authenticationProviders: "io.streamnative.pulsar.broker.authentication.AuthenticationProviderOIDCToken"
      brokerClientAuthenticationPlugin: "org.apache.pulsar.client.impl.auth.AuthenticationToken"
      PULSAR_PREFIX_vaultHost: http://release-name-sn-platform-vault:8200
      PULSAR_PREFIX_OIDCPublicKeyPath: "http://release-name-sn-platform-vault:8200/v1/identity/oidc/.well-known/keys"
      superUserRoles: "admin"
      authorizationEnabled: "false"
      forwardAuthorizationCredentials: "true"
      authorizationProvider: "org.apache.pulsar.broker.authorization.PulsarAuthorizationProvider"
  dnsNames:
    []
  issuerRef:
    name: ""
  
  apiObjects:
    externalService:
      {}
---
# Source: sn-platform/templates/vault/vault-statefulset.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: "vault.banzaicloud.com/v1alpha1"
kind: "Vault"
metadata:
  name: "release-name-sn-platform-vault"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: vault
spec:
  size: 3
  image: "vault:1.10.4"
  bankVaultsImage: "ghcr.io/banzaicloud/bank-vaults:1.15.2"
  serviceAccount: release-name-sn-platform-vault-acct
  serviceType: ClusterIP
  statsdDisabled: true
  vaultLabels:
    component: "vault"
    app: sn-platform
    release: release-name
    cluster: release-name-sn-platform    
    app.nomura.com/cmdb-instance-id: vault-operator
    app.nomura.com/environment: vault-operator
    app.nomura.com/sdlc-component: vault-operator
  vaultAnnotations:    
    prometheus.io/port: "9091"
    
    
  volumeClaimTemplates:
  - metadata:
      name: "release-name-sn-platform-vault-vault-volume"
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 10Gi
      
  volumeMounts:
    - name: "release-name-sn-platform-vault-vault-volume"
      mountPath: /vault/file
  unsealConfig:
    kubernetes:
      secretNamespace: snp
  istioEnabled: false
  # A YAML representation of a final vault config file.
  # See https://www.vaultproject.io/docs/configuration/ for more information.
  config:
  
    api_addr: http://${.Env.POD_NAME}:8200
    bankVaults:
      probe:
        livenessProbe: {}
        readinessProbe: {}
        startupProbe: {}
    cluster_addr: http://${.Env.POD_NAME}:8201
    listener:
      tcp:
        address: 0.0.0.0:8200
        telemetry:
          unauthenticated_metrics_access: true
        tls_disable: true
    storage:
      raft:
        path: /vault/file
    telemetry:
      statsd_address: ""
    ui: true
  resources:
    vault:
      limits:
        cpu: 200m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi
---
# Source: sn-platform/templates/zookeeper/zookeeper-cluster.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
# deploy zookeeper only when `components.zookeeper` is true
apiVersion: zookeeper.streamnative.io/v1alpha1
kind: ZooKeeperCluster
metadata:
  name: "release-name-sn-platform-zookeeper"
  namespace: snp
  annotations:
    "cloud.streamnative.io/ignore-leader-check": "true"
    "cloud.streamnative.io/cluster-force-update": "true"
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
    component: zookeeper
spec:
  replicas: 3
  image: "streamnative/sn-platform:2.9.2.20"
  pod:
    serviceAccountName: release-name-sn-platform-zookeeper-acct
    labels:
      app: sn-platform
      release: release-name
      cluster: release-name-sn-platform
      component: zookeeper
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8000"
      
    affinity:      
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: "app"
                    operator: In
                    values:
                      - "sn-platform"
                  - key: "release"
                    operator: In
                    values:
                      - release-name
                  - key: "component"
                    operator: In
                    values:
                      - zookeeper
              topologyKey: "kubernetes.io/hostname"
            
          
      
    resources:
      limits: {}
      requests:
        cpu: "0.1"
        memory: 256Mi
    terminationGracePeriodSeconds: 30
    jvmOptions:
      memoryOptions:
      - |
        -Xms64m -Xmx128m
      gcOptions:
      - |
        -XX:+UseG1GC -XX:MaxGCPauseMillis=10 -Dcom.sun.management.jmxremote -Djute.maxbuffer=10485760 -XX:+ParallelRefProcEnabled -XX:+UnlockExperimentalVMOptions -XX:+AggressiveOpts -XX:+DoEscapeAnalysis -XX:+DisableExplicitGC -XX:+PerfDisableSharedMem -Dzookeeper.forceSync=no
  persistence:
    data:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 50Gi
      
    dataLog:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: "0"
      
    reclaimPolicy: Delete
  config:
    serverCnxnFactory: org.apache.zookeeper.server.NettyServerCnxnFactory
    # copy from configmap
    custom:
      # enable zookeeper tls
      PULSAR_PREFIX_peerType: participant
      # Include log configuration file, If you want to configure the log level and other configuration
      # items, you can modify the configmap, and eventually it will overwrite the log4j2.yaml file under conf
      log4j2.yaml: |
        #
        # Licensed to the Apache Software Foundation (ASF) under one
        # or more contributor license agreements.  See the NOTICE file
        # distributed with this work for additional information
        # regarding copyright ownership.  The ASF licenses this file
        # to you under the Apache License, Version 2.0 (the
        # "License"); you may not use this file except in compliance
        # with the License.  You may obtain a copy of the License at
        #
        #   http://www.apache.org/licenses/LICENSE-2.0
        #
        # Unless required by applicable law or agreed to in writing,
        # software distributed under the License is distributed on an
        # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        # KIND, either express or implied.  See the License for the
        # specific language governing permissions and limitations
        # under the License.
        #
      
      
        Configuration:
          status: INFO
          monitorInterval: 30
          name: pulsar
          packages: io.prometheus.client.log4j2
      
          Properties:
            Property:
              - name: "pulsar.log.dir"
                value: "logs"
              - name: "pulsar.log.file"
                value: "pulsar.log"
              - name: "pulsar.log.appender"
                value: "RoutingAppender"
              - name: "pulsar.log.root.level"
                value: "info"
              - name: "pulsar.log.level"
                value: "info"
              - name: "pulsar.routing.appender.default"
                value: "Console"
      
          # Example: logger-filter script
          Scripts:
            ScriptFile:
              name: filter.js
              language: JavaScript
              path: ./conf/log4j2-scripts/filter.js
              charset: UTF-8
      
          Appenders:
      
            # Console
            Console:
              name: Console
              target: SYSTEM_OUT
              PatternLayout:
                Pattern: "%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"
      
            # Rolling file appender configuration
            RollingFile:
              name: RollingFile
              fileName: "${sys:pulsar.log.dir}/${sys:pulsar.log.file}"
              filePattern: "${sys:pulsar.log.dir}/${sys:pulsar.log.file}-%d{MM-dd-yyyy}-%i.log.gz"
              immediateFlush: false
              PatternLayout:
                Pattern: "%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"
              Policies:
                TimeBasedTriggeringPolicy:
                  interval: 1
                  modulate: true
                SizeBasedTriggeringPolicy:
                  size: 1 GB
              # Delete file older than 30days
              DefaultRolloverStrategy:
                  Delete:
                    basePath: ${sys:pulsar.log.dir}
                    maxDepth: 2
                    IfFileName:
                      glob: "*/${sys:pulsar.log.file}*log.gz"
                    IfLastModified:
                      age: 30d
      
            Prometheus:
              name: Prometheus
      
            # Routing
            Routing:
              name: RoutingAppender
              Routes:
                pattern: "$${ctx:function}"
                Route:
                  -
                    Routing:
                      name: InstanceRoutingAppender
                      Routes:
                        pattern: "$${ctx:instance}"
                        Route:
                          -
                            RollingFile:
                              name: "Rolling-${ctx:function}"
                              fileName : "${sys:pulsar.log.dir}/functions/${ctx:function}/${ctx:functionname}-${ctx:instance}.log"
                              filePattern : "${sys:pulsar.log.dir}/functions/${sys:pulsar.log.file}-${ctx:instance}-%d{MM-dd-yyyy}-%i.log.gz"
                              PatternLayout:
                                Pattern: "%d{ABSOLUTE} %level{length=5} [%thread] [instance: %X{instance}] %logger{1} - %msg%n"
                              Policies:
                                TimeBasedTriggeringPolicy:
                                  interval: 1
                                  modulate: true
                                SizeBasedTriggeringPolicy:
                                  size: "20MB"
                                # Trigger every day at midnight that also scan
                                # roll-over strategy that deletes older file
                                CronTriggeringPolicy:
                                  schedule: "0 0 0 * * ?"
                              # Delete file older than 30days
                              DefaultRolloverStrategy:
                                  Delete:
                                    basePath: ${sys:pulsar.log.dir}
                                    maxDepth: 2
                                    IfFileName:
                                      glob: "*/${sys:pulsar.log.file}*log.gz"
                                    IfLastModified:
                                      age: 30d
                          - ref: "${sys:pulsar.routing.appender.default}"
                            key: "${ctx:function}"
                  - ref: "${sys:pulsar.routing.appender.default}"
                    key: "${ctx:function}"
      
          Loggers:
      
            # Default root logger configuration
            Root:
              level: "${sys:pulsar.log.root.level}"
              additivity: true
              AppenderRef:
                - ref: "${sys:pulsar.log.appender}"
                  level: "${sys:pulsar.log.level}"
                - ref: Prometheus
                  level: info
      
            Logger:
              - name: org.apache.bookkeeper.bookie.BookieShell
                level: info
                additivity: false
                AppenderRef:
                  - ref: Console
      
              - name: verbose
                level: info
                additivity: false
                AppenderRef:
                  - ref: Console
      
            # Logger to inject filter script
        #     - name: org.apache.bookkeeper.mledger.impl.ManagedLedgerImpl
        #       level: debug
        #       additivity: false
        #       AppenderRef:
        #         ref: "${sys:pulsar.log.appender}"
        #         ScriptFilter:
        #           onMatch: ACCEPT
        #           onMisMatch: DENY
        #           ScriptRef:
        #             ref: filter.js
  apiObjects:
    clientService: {}
    headlessService:
      metadata:
        name: "release-name-sn-platform-zookeeper"
    statefulSet:
      metadata:
        name: "release-name-sn-platform-zookeeper"
      updatePolicy:
        - all
    configMap:
      metadata:
        name: "release-name-sn-platform-zookeeper"
    pdb:
      metadata:
        name: "release-name-sn-platform-zookeeper"
---
# Source: sn-platform/templates/vault/vault-clear-resource.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    # This is what defines this resource as a hook. Without this line, the
    # job is considered part of the release.
    helm.sh/hook: pre-delete
    helm.sh/hook-weight: "-5"
    helm.sh/hook-delete-policy: hook-succeeded
  name: "release-name-sn-platform-vault-clear-resource"
  namespace: snp
  labels:
    app: sn-platform
    chart: sn-platform-1.6.0
    release: release-name
    heritage: Helm
    cluster: release-name-sn-platform
spec:
  template:
    metadata:
      labels:
        app: sn-platform
        release: release-name
        cluster: release-name-sn-platform    
        app.nomura.com/cmdb-instance-id: vault-operator
        app.nomura.com/environment: vault-operator
        app.nomura.com/sdlc-component: vault-operator
      annotations:    
        prometheus.io/port: "9091"
    spec:
      serviceAccountName: release-name-sn-platform-vault-acct
      containers:
      - name: "release-name-sn-platform-vault-init"
        image: "streamnative/pulsar_vault_init:v1.0.5"
        imagePullPolicy: IfNotPresent
        command: ["sh", "-c"]
        args:
          - >
           kubectl delete secret release-name-sn-platform-vault-secret-env-injection --ignore-not-found=true -n snp && kubectl delete secret release-name-sn-platform-vault-console-admin-passwd --ignore-not-found=true -n snp;
           until [ $? -eq 0 ]; do
              echo "Clear vault resource not ready now, wait another 5s~";
              sleep 5;
              kubectl delete secret release-name-sn-platform-vault-secret-env-injection --ignore-not-found=true -n snp && kubectl delete secret release-name-sn-platform-vault-console-admin-passwd --ignore-not-found=true -n snp;
           done;
           echo "Clear vault resource is ready~";
           echo -ne "POST /quitquitquit HTTP/1.1\r\nHost: 127.0.0.1:15020\r\nUser-Agent: curl/7.68.0\r\nAccept: */*\r\n\r\n"|nc 127.0.0.1:15020 || true;
        env:
        - name: NAMESPACE
          value: snp
      restartPolicy: Never
