---
# Source: sn-platform-slim/templates/bookkeeper/bookkeeper-service-account.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pulsar-a-sn-platform-slim-bookie-acct
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: bookie
  annotations:
---
# Source: sn-platform-slim/templates/broker/broker-service-account.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pulsar-a-sn-platform-slim-broker-acct
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: broker
  annotations:
---
# Source: sn-platform-slim/templates/detector/pulsar-detector-service-account.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pulsar-a-sn-platform-slim-pulsar-detector-acct
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: pulsar-detector
  annotations:
---
# Source: sn-platform-slim/templates/prometheus/pulsar-operators-rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pulsar-a-sn-platform-slim-pulsar-operator
  namespace: k8s-01
---
# Source: sn-platform-slim/templates/proxy/proxy-service-account.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pulsar-a-sn-platform-slim-proxy-acct
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: proxy
  annotations:
---
# Source: sn-platform-slim/templates/streamnative-console/streamnative-console-service-account.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pulsar-a-sn-platform-slim-streamnative-console-acct
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: streamnative-console
  annotations:
---
# Source: sn-platform-slim/templates/toolset/toolset-serviceaccount.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pulsar-a-sn-platform-slim-toolset-acct
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: toolset
---
# Source: sn-platform-slim/templates/zookeeper/zookeeper-backup-serviceaccount.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pulsar-a-sn-platform-slim-backup-acct
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: backup
  annotations:
---
# Source: sn-platform-slim/templates/zookeeper/zookeeper-restore-serviceaccount.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pulsar-a-sn-platform-slim-restore-acct
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: restore
  annotations:
---
# Source: sn-platform-slim/templates/zookeeper/zookeeper-service-account.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ServiceAccount
metadata:
  name: pulsar-a-sn-platform-slim-zookeeper-acct
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: zookeeper
  annotations:
---
# Source: sn-platform-slim/templates/grafana/grafana-admin-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: Secret
metadata:
  name: "pulsar-a-sn-platform-slim-grafana-secret"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: grafana
type: Opaque
stringData:
  GRAFANA_ADMIN_PASSWORD: pulsar
  GRAFANA_ADMIN_USER: pulsar
---
# Source: sn-platform-slim/templates/broker/function-worker-configfile-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
## function config map
apiVersion: v1
kind: ConfigMap
metadata:
  name: "pulsar-a-sn-platform-slim-functions-worker-configfile"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: functions-worker
data:
  functions_worker.yml: |
    # Function package management
    workerPort: 8080
    numFunctionPackageReplicas: 3
    pulsarFunctionsCluster: pulsar-a-sn-platform-slim
    functionRuntimeFactoryConfigs:
      jobNamespace: k8s-01
      pulsarDockerImageName: "streamnative/sn-platform-slim:2.10.4.1"
      pulsarRootDir: /pulsar
      pulsarAdminUrl: http://pulsar-a-sn-platform-slim-proxy-headless.k8s-01.svc.cluster.local:8080
      pulsarServiceUrl: pulsar://pulsar-a-sn-platform-slim-broker.k8s-01.svc.cluster.local:6650
      changeConfigMap: "pulsar-a-sn-platform-slim-functions-worker-config"
      changeConfigMapNamespace: k8s-01
      submittingInsidePod: true
      installUserCodeDependencies: true
    # runtime customizer
    assignmentWriteMaxRetries: 60
    clusterCoordinationTopicName: coordinate
    connectorsDirectory: ./connectors
    downloadDirectory: download/pulsar_functions
    failureCheckFreqMs: 30000
    functionAssignmentTopicName: assignments
    functionMetadataTopicName: metadata
    functionRuntimeFactoryClassName: org.apache.pulsar.functions.runtime.kubernetes.KubernetesRuntimeFactory
    functionsDirectory: ./functions
    initialBrokerReconnectMaxRetries: 60
    instanceLivenessCheckFreqMs: 30000
    narExtractionDirectory: ""
    numHttpServerThreads: 8
    pulsarFunctionsNamespace: public/functions
    rescheduleTimeoutMs: 60000
    schedulerClassName: org.apache.pulsar.functions.worker.scheduler.RoundRobinScheduler
    topicCompactionFrequencySec: 1800
---
# Source: sn-platform-slim/templates/broker/function-worker-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
## function config map
apiVersion: v1
kind: ConfigMap
metadata:
  name: "pulsar-a-sn-platform-slim-functions-worker-config"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: functions-worker
data:
  pulsarDockerImageName: "streamnative/sn-platform-slim:2.10.4.1"
---
# Source: sn-platform-slim/templates/grafana/grafana-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ConfigMap
metadata:
  name: "pulsar-a-sn-platform-slim-grafana"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: grafana
data:
  grafana.ini: |
    [analytics]
    check_for_updates = true
    [auth.azuread]
    allow_sign_up = true
    allowed_domains = 
    allowed_groups = 
    auth_url = 
    client_id = 
    client_secret = 
    enabled = false
    name = Azure AD
    role_attribute_strict = true
    scopes = openid email profile
    token_url = 
    [grafana_com]
    url = https://grafana.com
    [log]
    mode = console
    [log.file]
    format = text
    level = info
    [paths]
    data = /var/lib/grafana/pulsar/data
    plugins = /var/lib/grafana/pulsar/plugins
    provisioning = /var/lib/grafana/pulsar_provisioning
    [security]
    admin_password = {{ GRAFANA_ADMIN_PASSWORD }}
    admin_user = {{ GRAFANA_ADMIN_USER }}
    [server]
    domain = {{ GRAFANA_DOMAIN }}
    root_url = {{ GRAFANA_ROOT_URL }}
    serve_from_sub_path = {{ GRAFANA_SERVE_FROM_SUB_PATH }}
---
# Source: sn-platform-slim/templates/prometheus/prometheus-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ConfigMap
metadata:
  name: "pulsar-a-sn-platform-slim-prometheus"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: prometheus
data:
  # Include prometheus configuration file, setup to monitor all the
  # Kubernetes pods with the "scrape=true" annotation.
  prometheus.yml: |
    global:
      scrape_interval: 15s
    scrape_configs:
    - job_name: 'prometheus'
      static_configs:
      - targets:
        - '127.0.0.1:9090'
      metrics_path: /metrics
    - job_name: 'kubernetes-pods'
      bearer_token_file: /pulsar/tokens/client/token
      kubernetes_sd_configs:
      - role: pod
      relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)
      - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
        action: replace
        regex: ([^:]+)(?::\d+)?;(\d+)
        replacement: $1:$2
        target_label: __address__
      - action: labelmap
        regex: __meta_kubernetes_pod_label_(.+)
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: kubernetes_namespace
      - source_labels: [__meta_kubernetes_pod_label_component]
        action: replace
        target_label: job
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: kubernetes_pod_name
      metric_relabel_configs:
    - job_name: 'kubernetes-nodes'
      scheme: https
      kubernetes_sd_configs:
        - role: node

      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

      relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
        - target_label: __address__
          replacement: kubernetes.default.svc:443
        - source_labels: [__meta_kubernetes_node_name]
          regex: (.+)
          target_label: __metrics_path__
          replacement: /api/v1/nodes/${1}/proxy/metrics
    - job_name: 'kubernetes-cadvisor'
      scheme: https
      kubernetes_sd_configs:
        - role: node

      tls_config:
        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

      relabel_configs:
        - action: labelmap
          regex: __meta_kubernetes_node_label_(.+)
        - target_label: __address__
          replacement: kubernetes.default.svc:443
        - source_labels: [__meta_kubernetes_node_name]
          regex: (.+)
          target_label: __metrics_path__
          replacement: /api/v1/nodes/${1}/proxy/metrics/cadvisor
  rules.yml: |
---
# Source: sn-platform-slim/templates/streamnative-console/streamnative-console-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ConfigMap
metadata:
  name: "pulsar-a-sn-platform-slim-streamnative-console-init"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: streamnative-console
data:
  init_instance.py: |-
    import requests
    import json
    import os
    host = os.getenv("STREAMNATIVE_CONSOLE_BACKEND_URL")
    loginPath = "/cloud-manager/login"
    username = os.getenv("VAULT_SUPER_USER_NAME")
    password = os.getenv("VAULT_SUPER_USER_PASSWORD")
    if not username or not password:
        username = os.getenv("SUPER_USER_NAME")
        password = os.getenv("SUPER_USER_PASSWORD")
    loginData = {
        "username": username,
        "password": password,
        "type":"pulsar-vault-userpass"
    }
    headers = {
        "Content-Type": "application/json"
    }
    loginResponse = requests.post(url = host + loginPath, data=json.dumps(loginData), headers=headers)
    token = loginResponse.headers['token']
    headers = {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
    }
  
    instanceData = {"name": os.getenv("INSTANCE_NAME"), "broker": os.getenv("WEB_SERVICE_URL")}
    serviceData = {}
    if (os.getenv("KOP_SERVICE_URL")):
        serviceData["kopServiceUrl"] = os.getenv("KOP_SERVICE_URL")
    if (os.getenv("FLINK_SERVICE_URL")):
        serviceData["flinkServiceUrl"] = os.getenv("FLINK_SERVICE_URL")
    instanceData["service"] = json.dumps(serviceData)
  
    instancePath = "/cloud-manager/v1/instances"
    instanceResponse = requests.post(url = host + instancePath, data = json.dumps(instanceData), headers=headers)
    if (instanceResponse.ok and 'Add environment success' in instanceResponse.text):
        print("Add environment success")
    else:
        print("Add environment failed " + instanceResponse.text)
        exit(-1)
---
# Source: sn-platform-slim/templates/toolset/toolset-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: ConfigMap
metadata:
  name: "pulsar-a-sn-platform-slim-toolset"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: toolset
data:
  BOOKIE_LOG_APPENDER: "RollingFile"
  zkServers: "pulsar-a-sn-platform-slim-zookeeper:2181"
  zkLedgersRootPath: "/ledgers"
  # enable bookkeeper http server
  httpServerEnabled: "true"
  httpServerPort: "8000"
  # config the stats provider
  statsProviderClass: org.apache.bookkeeper.stats.prometheus.PrometheusMetricsProvider
  # use hostname as the bookie id
  useHostNameAsBookieID: "true"
  # talk to broker
  webServiceUrl: "http://pulsar-a-sn-platform-slim-broker-headless:8080/"
  brokerServiceUrl: "pulsar://pulsar-a-sn-platform-slim-broker-headless:6650/"
  # Authentication Settings
  authParams: "file:///pulsar/tokens/client/token"
  authPlugin: "org.apache.pulsar.client.impl.auth.AuthenticationToken"
  PULSAR_MEM: |
    -Xms64M -Xmx128M -XX:MaxDirectMemorySize=128M
  # Include log configuration file, If you want to configure the log level and other configuration
  # items, you can modify the configmap, and eventually it will overwrite the log4j2.yaml file under conf
  log4j2.yaml: |
    #
    # Licensed to the Apache Software Foundation (ASF) under one
    # or more contributor license agreements.  See the NOTICE file
    # distributed with this work for additional information
    # regarding copyright ownership.  The ASF licenses this file
    # to you under the Apache License, Version 2.0 (the
    # "License"); you may not use this file except in compliance
    # with the License.  You may obtain a copy of the License at
    #
    #   http://www.apache.org/licenses/LICENSE-2.0
    #
    # Unless required by applicable law or agreed to in writing,
    # software distributed under the License is distributed on an
    # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    # KIND, either express or implied.  See the License for the
    # specific language governing permissions and limitations
    # under the License.
    #
  
  
    Configuration:
      status: INFO
      monitorInterval: 30
      name: pulsar
      packages: io.prometheus.client.log4j2
  
      Properties:
        Property:
          - name: "pulsar.log.dir"
            value: "logs"
          - name: "pulsar.log.file"
            value: "pulsar.log"
          - name: "pulsar.log.appender"
            value: "RoutingAppender"
          - name: "pulsar.log.root.level"
            value: "info"
          - name: "pulsar.log.level"
            value: "info"
          - name: "pulsar.routing.appender.default"
            value: "Console"
  
      # Example: logger-filter script
      Scripts:
        ScriptFile:
          name: filter.js
          language: JavaScript
          path: ./conf/log4j2-scripts/filter.js
          charset: UTF-8
  
      Appenders:
  
        # Console
        Console:
          name: Console
          target: SYSTEM_OUT
          PatternLayout:
            Pattern: "%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"
  
        # Rolling file appender configuration
        RollingFile:
          name: RollingFile
          fileName: "${sys:pulsar.log.dir}/${sys:pulsar.log.file}"
          filePattern: "${sys:pulsar.log.dir}/${sys:pulsar.log.file}-%d{MM-dd-yyyy}-%i.log.gz"
          immediateFlush: false
          PatternLayout:
            Pattern: "%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"
          Policies:
            TimeBasedTriggeringPolicy:
              interval: 1
              modulate: true
            SizeBasedTriggeringPolicy:
              size: 1 GB
          # Delete file older than 30days
          DefaultRolloverStrategy:
              Delete:
                basePath: ${sys:pulsar.log.dir}
                maxDepth: 2
                IfFileName:
                  glob: "*/${sys:pulsar.log.file}*log.gz"
                IfLastModified:
                  age: 30d
  
        Prometheus:
          name: Prometheus
  
        # Routing
        Routing:
          name: RoutingAppender
          Routes:
            pattern: "$${ctx:function}"
            Route:
              -
                Routing:
                  name: InstanceRoutingAppender
                  Routes:
                    pattern: "$${ctx:instance}"
                    Route:
                      -
                        RollingFile:
                          name: "Rolling-${ctx:function}"
                          fileName : "${sys:pulsar.log.dir}/functions/${ctx:function}/${ctx:functionname}-${ctx:instance}.log"
                          filePattern : "${sys:pulsar.log.dir}/functions/${sys:pulsar.log.file}-${ctx:instance}-%d{MM-dd-yyyy}-%i.log.gz"
                          PatternLayout:
                            Pattern: "%d{ABSOLUTE} %level{length=5} [%thread] [instance: %X{instance}] %logger{1} - %msg%n"
                          Policies:
                            TimeBasedTriggeringPolicy:
                              interval: 1
                              modulate: true
                            SizeBasedTriggeringPolicy:
                              size: "20MB"
                            # Trigger every day at midnight that also scan
                            # roll-over strategy that deletes older file
                            CronTriggeringPolicy:
                              schedule: "0 0 0 * * ?"
                          # Delete file older than 30days
                          DefaultRolloverStrategy:
                              Delete:
                                basePath: ${sys:pulsar.log.dir}
                                maxDepth: 2
                                IfFileName:
                                  glob: "*/${sys:pulsar.log.file}*log.gz"
                                IfLastModified:
                                  age: 30d
                      - ref: "${sys:pulsar.routing.appender.default}"
                        key: "${ctx:function}"
              - ref: "${sys:pulsar.routing.appender.default}"
                key: "${ctx:function}"
  
      Loggers:
  
        # Default root logger configuration
        Root:
          level: "${sys:pulsar.log.root.level}"
          additivity: true
          AppenderRef:
            - ref: "${sys:pulsar.log.appender}"
              level: "${sys:pulsar.log.level}"
            - ref: Prometheus
              level: info
  
        Logger:
          - name: org.apache.bookkeeper.bookie.BookieShell
            level: info
            additivity: false
            AppenderRef:
              - ref: Console
  
          - name: verbose
            level: info
            additivity: false
            AppenderRef:
              - ref: Console
  
        # Logger to inject filter script
    #     - name: org.apache.bookkeeper.mledger.impl.ManagedLedgerImpl
    #       level: debug
    #       additivity: false
    #       AppenderRef:
    #         ref: "${sys:pulsar.log.appender}"
    #         ScriptFilter:
    #           onMatch: ACCEPT
    #           onMisMatch: DENY
    #           ScriptRef:
    #             ref: filter.js
  # pulsarctl configs
  pulsarctl.config: |
    auth-info:
      default:
        locationoforigin: /root/.config/pulsar/config
        tls_allow_insecure_connection: false
        token: ""
        tokenFile: "/pulsar/tokens/client/token"
        issuer_endpoint: ""
        client_id: ""
        audience: ""
        key_file: ""
    contexts:
      default:
        admin-service-url: "http://pulsar-a-sn-platform-slim-broker:8080"
        bookie-service-url: "http://pulsar-a-sn-platform-slim-bookie:8000"
    current-context: default
---
# Source: sn-platform-slim/templates/zookeeper/gen-zk-conf.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

apiVersion: v1
kind: ConfigMap
metadata:
  name: "pulsar-a-sn-platform-slim-genzkconf-configmap"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
  annotations:
data:
  gen-zk-conf.sh: |
    #!/bin/bash
    
    # Apply env variables to config file and start the regular command
    
    CONF_FILE=$1
    IDX=$2
    PEER_TYPE=$3
    
    if [ $? != 0 ]; then
        echo "Error: Failed to apply changes to config file"
        exit 1
    fi
    
    DOMAIN=`hostname -d`

    if [ -n "${ZOOKEEPER_DOMAIN}" ]; then
        ZOOKEEPER_DOMAIN="${ZOOKEEPER_DOMAIN}.$(cut -d '.' -f 2- <<<${DOMAIN})"
    else
        ZOOKEEPER_DOMAIN=$DOMAIN
    fi
    
    # Generate list of servers and detect the current server ID,
    # based on the hostname
    ((IDX++))
    for SERVER in $(echo $ZOOKEEPER_SERVERS | tr "," "\n")
    do
        echo "server.$IDX=$SERVER.$ZOOKEEPER_DOMAIN:2888:3888:${PEER_TYPE};2181" >> $CONF_FILE
    
        if [ "$HOSTNAME" == "$SERVER" ]; then
            MY_ID=$IDX
            echo "Current server id $MY_ID"
        fi
    
    	((IDX++))
    done

    if [ -n "${OBSERVER_SERVER}" ]; then
        echo "server.$IDX=${OBSERVER_SERVER}.$DOMAIN:2181:2888:observer" >> $CONF_FILE
        MY_ID=$IDX
    fi

    # For ZooKeeper container we need to initialize the ZK id
    if [ ! -z "$MY_ID" ]; then
        # Get ZK data dir
        DATA_DIR=`grep '^dataDir=' $CONF_FILE | awk -F= '{print $2}'`
        if [ ! -e $DATA_DIR/myid ]; then
            echo "Creating $DATA_DIR/myid with id = $MY_ID"
            mkdir -p $DATA_DIR
            echo $MY_ID > $DATA_DIR/myid
        fi
    fi
---
# Source: sn-platform-slim/templates/grafana/grafana-pvc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "pulsar-a-sn-platform-slim-grafana-data"
  namespace: k8s-01
spec:
  resources:
    requests:
      storage: 10Gi
  accessModes: [ "ReadWriteOnce" ]
---
# Source: sn-platform-slim/templates/prometheus/prometheus-pvc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "pulsar-a-sn-platform-slim-prometheus-data"
  namespace: k8s-01
spec:
  resources:
    requests:
      storage: 10Gi
  accessModes: [ "ReadWriteOnce" ]
---
# Source: sn-platform-slim/templates/streamnative-console/streamnative-console-pvc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: "pulsar-a-sn-platform-slim-streamnative-console-data"
  namespace: k8s-01
spec:
  resources:
    requests:
      storage: 10Gi
  accessModes: [ "ReadWriteOnce" ]
---
# Source: sn-platform-slim/templates/bookkeeper/bookkeeper-cluster-role-binding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: "pulsar-a-sn-platform-slim-bookie-clusterrole"
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
rules:
- apiGroups: [""]
  resources:
  - persistentvolumeclaims
  - persistentvolumes
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources:
    - pods
  verbs:
    - list
    - get
---
# Source: sn-platform-slim/templates/broker/broker-cluster-role-binding.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: "pulsar-a-sn-platform-slim-broker-clusterrole"
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
rules:
- apiGroups: [""]
  resources:
  - configmap
  - configmaps
  verbs: ["get", "list", "watch"]
- apiGroups: ["", "extensions", "apps"]
  resources:
    - pods
    - services
    - deployments
    - secrets
    - statefulsets
  verbs:
    - list
    - watch
    - get
    - update
    - create
    - delete
    - patch
---
# Source: sn-platform-slim/templates/prometheus/pulsar-operators-rbac.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: "pulsar-a-sn-platform-slim-pulsar-operator"
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
rules:
- apiGroups: [""]
  resources:
  - nodes
  - nodes/proxy
  - services
  - endpoints
  - pods
  verbs: ["get", "list", "watch"]
- nonResourceURLs: ["/metrics"]
  verbs: ["get"]
- apiGroups: [""]
  resources:
    - namespaces
    - persistentvolumes
    - persistentvolumeclaims
  verbs:
    - list
    - watch
    - get
    - create
- apiGroups: ["", "extensions", "apps"]
  resources:
    - pods
    - deployments
    - ingresses
    - secrets
    - statefulsets
  verbs:
    - list
    - watch
    - get
    - update
    - create
    - delete
    - patch
- apiGroups: [""]
  resources:
    - replicasets
  verbs:
    - list
    - watch
    - get
- apiGroups: [""]
  resources:
    - events
  verbs:
    - list
    - watch
    - get
- apiGroups:
    - "rbac.authorization.k8s.io"
  resources:
    - clusterrolebindings
    - clusterroles
  verbs:
    - "*"
---
# Source: sn-platform-slim/templates/bookkeeper/bookkeeper-cluster-role-binding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: "pulsar-a-sn-platform-slim-bookie-clusterrolebinding"
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: "pulsar-a-sn-platform-slim-bookie-clusterrole"
subjects:
- kind: ServiceAccount
  name: pulsar-a-sn-platform-slim-bookie-acct
  namespace: k8s-01
---
# Source: sn-platform-slim/templates/broker/broker-cluster-role-binding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: "pulsar-a-sn-platform-slim-broker-clusterrolebinding"
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: "pulsar-a-sn-platform-slim-broker-clusterrole"
subjects:
- kind: ServiceAccount
  name: pulsar-a-sn-platform-slim-broker-acct
  namespace: k8s-01
---
# Source: sn-platform-slim/templates/prometheus/pulsar-operators-rbac.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: "pulsar-a-sn-platform-slim-pulsar-operator-cluster-role-binding"
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: "pulsar-a-sn-platform-slim-pulsar-operator"
subjects:
- kind: ServiceAccount
  name: pulsar-a-sn-platform-slim-pulsar-operator
  namespace: k8s-01
---
# Source: sn-platform-slim/templates/detector/pulsar-detector-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: Service
metadata:
  name: "pulsar-a-sn-platform-slim-pulsar-detector"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: pulsar-detector
spec:
  ports:
    - name: server
      port: 9000
      protocol: TCP
  selector:
    app: sn-platform-slim
    release: pulsar-a
    component: pulsar-detector
---
# Source: sn-platform-slim/templates/grafana/grafana-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: Service
metadata:
  name: pulsar-a-sn-platform-slim-grafana
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: grafana
  annotations:
spec:
  clusterIP: None
  ports:
    - name: server
      port: 3000
      protocol: TCP
  selector:
    app: sn-platform-slim
    release: pulsar-a
    component: grafana
---
# Source: sn-platform-slim/templates/prometheus/prometheus-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: Service
metadata:
  name: "pulsar-a-sn-platform-slim-prometheus"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: prometheus
  annotations:
    {}
spec:
  clusterIP: None
  ports:
    - name: server
      port: 9090
  selector:
    app: sn-platform-slim
    release: pulsar-a
    component: prometheus
---
# Source: sn-platform-slim/templates/streamnative-console/streamnative-console-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: Service
metadata:
  name: "pulsar-a-sn-platform-slim-streamnative-console"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: streamnative-console
  annotations:
    {}
spec:
  clusterIP: None
  ports:
    - name: frontend
      port: 9527
      protocol: TCP
      targetPort: 9527
    - name: backend
      port: 7750
      protocol: TCP
      targetPort: 7750
  selector:
    app: sn-platform-slim
    release: pulsar-a
    component: streamnative-console
---
# Source: sn-platform-slim/templates/toolset/toolset-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: v1
kind: Service
metadata:
  name: "pulsar-a-sn-platform-slim-toolset"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: toolset
spec:
  clusterIP: None
  selector:
    app: sn-platform-slim
    release: pulsar-a
    component: toolset
---
# Source: sn-platform-slim/templates/detector/pulsar-detector-deployment.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: apps/v1
kind: Deployment
metadata:
  name: "pulsar-a-sn-platform-slim-pulsar-detector"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: pulsar-detector
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sn-platform-slim
      release: pulsar-a
      component: pulsar-detector
  template:
    metadata:
      labels:
        app: sn-platform-slim
        release: pulsar-a
        cluster: pulsar-a-sn-platform-slim
        component: pulsar-detector
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9000"
        
    spec:
      serviceAccountName: pulsar-a-sn-platform-slim-pulsar-detector-acct
      terminationGracePeriodSeconds: 30
      initContainers:
      # This init container will wait for zookeeper to be ready before
      # deploying the bookies
      - name: wait-zookeeper-ready
        image: "streamnative/sn-platform-slim:2.10.4.1"
        imagePullPolicy: IfNotPresent
        command: ["sh", "-c"]
        args:
          - >-
            until bin/pulsar zookeeper-shell -server pulsar-a-sn-platform-slim-zookeeper:2181 get /admin/clusters/pulsar-a-sn-platform-slim; do
              sleep 3;
            done;
        resources:
          limits: {}
          requests:
            cpu: "0.1"
            memory: 256Mi
      # This init container will wait for at least one broker to be ready before
      # deploying the pulsar-detector
      - name: wait-broker-ready
        image: "streamnative/sn-platform-slim:2.10.4.1"
        imagePullPolicy: IfNotPresent
        command: ["sh", "-c"]
        args:
          - >-
            set -e;
            brokerServiceNumber="$(nslookup -timeout=10 pulsar-a-sn-platform-slim-broker | grep Name | wc -l)";
            until [ ${brokerServiceNumber} -ge 1 ]; do
              echo "pulsar cluster pulsar-a-sn-platform-slim isn't initialized yet ... check in 10 seconds ...";
              sleep 10;
              brokerServiceNumber="$(nslookup -timeout=10 pulsar-a-sn-platform-slim-broker | grep Name | wc -l)";
            done;
        resources:
          limits: {}
          requests:
            cpu: "0.1"
            memory: 256Mi
      containers:
      - name: "pulsar-a-sn-platform-slim-pulsar-detector"
        image: "streamnative/sn-platform-slim:2.10.4.1"
        imagePullPolicy: IfNotPresent
        command: ["sh", "-c"]
        args:
        - >
          bin/pulsar-detector -service-url pulsar://pulsar-a-sn-platform-slim-broker.k8s-01.svc.cluster.local:6650 -webservice-url http://pulsar-a-sn-platform-slim-broker.k8s-01.svc.cluster.local:8080 -auth-plugin token -auth-params "{\"token\":\"$brokerClientAuthenticationParameters\"}";
        ports:
        # prometheus needs to access /metrics endpoint
        - name: server
          containerPort: 9000
        env:
        - name: brokerClientAuthenticationParameters
          valueFrom:
              secretKeyRef:
                name: pulsar-a-token-admin
                key: TOKEN
---
# Source: sn-platform-slim/templates/grafana/grafana-statefulset.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: "pulsar-a-sn-platform-slim-grafana"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: grafana
spec:
  serviceName: "pulsar-a-sn-platform-slim-grafana"
  replicas: 1
  selector:
    matchLabels:
      app: sn-platform-slim
      release: pulsar-a
      component: grafana
  updateStrategy:
    type: RollingUpdate
  podManagementPolicy: OrderedReady
  template:
    metadata:
      labels:
        app: sn-platform-slim
        release: pulsar-a
        cluster: pulsar-a-sn-platform-slim
        component: grafana
      annotations:
        checksum/config: c231b47d2dd51b198220a48259f8a2aa85f413587323f3d1e98994bc4d3fa794
    spec:
      terminationGracePeriodSeconds: 0
      securityContext:
        fsGroup: 472
        runAsGroup: 472
        runAsNonRoot: true
        runAsUser: 472
      containers:
      - name: "pulsar-a-sn-platform-slim-grafana"
        image: "streamnative/apache-pulsar-grafana-dashboard-k8s:0.0.20"
        imagePullPolicy: IfNotPresent
        resources:
          requests:
            cpu: 0.1
            memory: 250Mi
        ports:
        - name: server
          containerPort: 3000
        env:
        # for supporting apachepulsar/pulsar-grafana
        - name: PROMETHEUS_URL
          value: http://pulsar-a-sn-platform-slim-prometheus:9090/
        # for supporting streamnative/apache-pulsar-grafana-dashboard
        - name: PULSAR_PROMETHEUS_URL
          value: http://pulsar-a-sn-platform-slim-prometheus:9090/
        - name: PULSAR_CLUSTER
          value: pulsar-a-sn-platform-slim
        - name: GRAFANA_ADMIN_USER
          valueFrom:
            secretKeyRef:
              name: "pulsar-a-sn-platform-slim-grafana-secret"
              key: GRAFANA_ADMIN_USER
        - name: GRAFANA_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: "pulsar-a-sn-platform-slim-grafana-secret"
              key: GRAFANA_ADMIN_PASSWORD
        - name: GRAFANA_CFG_FILE
          value: /pulsar/conf/grafana.ini
        - name: GF_PATHS_DATA
          value: /var/lib/grafana/pulsar/data
        - name: GF_PATHS_PLUGINS
          value: /var/lib/grafana/pulsar/plugin
        - name: GF_PATHS_PROVISIONING
          value: /var/lib/grafana/pulsar_provisioning
        - name: GRAFANA_DOMAIN
          value: admin.pulsar-a.test.pulsar.example.local
        - name: GRAFANA_ROOT_URL
          value: /grafana/
        - name: GRAFANA_SERVE_FROM_SUB_PATH
          value: "true"
        volumeMounts:
        - name: "cfg"
          mountPath: "/pulsar/conf/grafana.ini"
          subPath: grafana.ini
        - name: "pulsar-a-sn-platform-slim-grafana-data"
          mountPath: /var/lib/grafana/pulsar
      volumes:
      - name: "cfg"
        configMap:
          name: "pulsar-a-sn-platform-slim-grafana"
      - name: "pulsar-a-sn-platform-slim-grafana-data"
        persistentVolumeClaim:
          claimName: "pulsar-a-sn-platform-slim-grafana-data"
---
# Source: sn-platform-slim/templates/prometheus/prometheus-statefulset.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: "pulsar-a-sn-platform-slim-prometheus"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: prometheus
spec:
  serviceName: "pulsar-a-sn-platform-slim-prometheus"
  replicas: 1
  selector:
    matchLabels:
      app: sn-platform-slim
      release: pulsar-a
      component: prometheus
  updateStrategy:
    type: RollingUpdate
  podManagementPolicy: Parallel
  template:
    metadata:
      labels:
        app: sn-platform-slim
        release: pulsar-a
        cluster: pulsar-a-sn-platform-slim
        component: prometheus
      annotations:
    spec:
      serviceAccount: pulsar-a-sn-platform-slim-pulsar-operator
      terminationGracePeriodSeconds: 0
      securityContext:
        fsGroup: 65534
        runAsGroup: 65534
        runAsNonRoot: true
        runAsUser: 65534
      affinity:        
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: "app"
                      operator: In
                      values:
                        - "sn-platform-slim"
                    - key: "release"
                      operator: In
                      values:
                        - pulsar-a
                    - key: "component"
                      operator: In
                      values:
                        - prometheus
                topologyKey: "kubernetes.io/hostname"
              
            
        
      containers:
      - name: pulsar-a-sn-platform-slim-prometheus-configmap-reload
        image: "jimmidyson/configmap-reload:v0.8.0"
        imagePullPolicy: "IfNotPresent"
        args:
          - --volume-dir=/etc/config
          - --webhook-url=http://127.0.0.1:9090/-/reload
        resources:
          {}
        volumeMounts:
          - name: config-volume
            mountPath: /etc/config
            readOnly: true
      - name: "pulsar-a-sn-platform-slim-prometheus"
        image: "quay.io/prometheus/prometheus:v2.43.0"
        imagePullPolicy: IfNotPresent
        resources:
          requests:
            cpu: 0.1
            memory: 256Mi
        args:
          - --config.file=/etc/config/prometheus.yml
          - --storage.tsdb.retention.time=15d
          - --storage.tsdb.path=/prometheus
          - --web.console.libraries=/etc/prometheus/console_libraries
          - --web.console.templates=/etc/prometheus/consoles
          - --web.enable-lifecycle
  
          
          - --storage.tsdb.wal-compression
        ports:
        - name: server
          containerPort: 9090
        readinessProbe:
          httpGet:
            path: /-/ready
            port: 9090
          initialDelaySeconds: 30
          periodSeconds: 10
          failureThreshold: 10
        livenessProbe:
          httpGet:
            path: /-/healthy
            port: 9090
          initialDelaySeconds: 30
          periodSeconds: 10
          failureThreshold: 10
        volumeMounts:
        - name: config-volume
          mountPath: /etc/config
        - name: "pulsar-a-sn-platform-slim-prometheus-data"
          mountPath: /prometheus
        
        - mountPath: "/pulsar/tokens"
          name: client-token
          readOnly: true
      volumes:
      - name: config-volume
        configMap:
          name: "pulsar-a-sn-platform-slim-prometheus"
      - name: "pulsar-a-sn-platform-slim-prometheus-data"
        persistentVolumeClaim:
          claimName: "pulsar-a-sn-platform-slim-prometheus-data"
      
      - name: client-token
        secret:
          secretName: "pulsar-a-token-admin"
          items:
            - key: TOKEN
              path: client/token
---
# Source: sn-platform-slim/templates/streamnative-console/streamnative-console-statefulset.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: "pulsar-a-sn-platform-slim-streamnative-console"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: streamnative-console
spec:
  serviceName: "pulsar-a-sn-platform-slim-streamnative-console"
  replicas: 1
  selector:
    matchLabels:
      app: sn-platform-slim
      release: pulsar-a
      component: streamnative-console
  updateStrategy:
    type: RollingUpdate
  podManagementPolicy: Parallel
  template:
    metadata:
      labels:
        app: sn-platform-slim
        release: pulsar-a
        cluster: pulsar-a-sn-platform-slim
        component: streamnative-console
      annotations:
    spec:
      terminationGracePeriodSeconds: 0
      initContainers:
      # This init container will wait for broker to be ready before
      # deploying the pulsar manager
      - name: wait-broker-ready
        image: "streamnative/sn-platform-slim:2.10.4.1"
        imagePullPolicy: IfNotPresent
        command: ["sh", "-c"]
        args:
          - >
            set -e; while [ "$(curl -s -o /dev/null -w '%{http_code}' http://pulsar-a-sn-platform-slim-broker:8080/status.html)" -ne "200" ]; do echo "pulsar cluster isn't initialized yet..."; sleep 5; done;
            echo "broker cluster is ready";
        resources:
          limits: {}
          requests:
            cpu: 0.1
            memory: 250Mi
      containers:
        - name: "pulsar-a-sn-platform-slim-streamnative-console"
          image: "streamnative/private-cloud-console:v2.1.1"
          imagePullPolicy: IfNotPresent
          resources:
            limits: {}
            requests:
              cpu: 0.1
              memory: 250Mi
          readinessProbe:
            tcpSocket:
              port: 8850
            initialDelaySeconds: 10
            periodSeconds: 30
            failureThreshold: 10
          livenessProbe:
            tcpSocket:
              port: 8850
            initialDelaySeconds: 10
            periodSeconds: 30
            failureThreshold: 10
          env:
          - name: SPRING_CONFIGURATION_FILE
            value: /pulsar-manager/pulsar-manager/application.properties
          - name: DEFAULT_ORGANIZATION
            value: streamnative
          - name: DEFAULT_NAME
            value: 
          - name: INSTANCE_NAME
            value: pulsar
          - name: CONNECTOR_ENABLED
            value: "true"
          - name: WEB_SERVICE_URL
            value: http://pulsar-a-sn-platform-slim-broker.k8s-01.svc.cluster.local:8080
          - name: KOP_SERVICE_URL
            value: :9093
          - name: VAULT_ENABLED
            value: "false"
          - name: BACKEND_DEFAULT_SUPER_USER_ROLE
            value: admin
          volumeMounts:
          - name: streamnative-console-data
            mountPath: /data
        - name: "pulsar-a-sn-platform-slim-streamnative-console-gateway"
          image: "streamnative/private-cloud-console:v2.1.1"
          imagePullPolicy: IfNotPresent
          workingDir: "/pulsar-manager/gateway"
          command: ["/pulsar-manager/gateway/gateway-entrypoint.sh"]
          ports:
          - name: frontend
            containerPort: 9527
          - name: backend
            containerPort: 7750
      volumes:
      - name: streamnative-console-data
        persistentVolumeClaim:
          claimName: "pulsar-a-sn-platform-slim-streamnative-console-data"
      serviceAccountName: pulsar-a-sn-platform-slim-streamnative-console-acct
---
# Source: sn-platform-slim/templates/toolset/toolset-statefulset.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: "pulsar-a-sn-platform-slim-toolset"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: toolset
spec:
  serviceName: "pulsar-a-sn-platform-slim-toolset"
  replicas: 1
  updateStrategy:
    type: RollingUpdate
  podManagementPolicy: Parallel
  selector:
    matchLabels:
      app: sn-platform-slim
      release: pulsar-a
      component: toolset
  template:
    metadata:
      labels:
        app: sn-platform-slim
        release: pulsar-a
        cluster: pulsar-a-sn-platform-slim
        component: toolset
      annotations:
        checksum/config: 88e9bb76402f3a913239a21fd62ba12b47b225eb321f7023063dd53ba501b01e
    spec:
      terminationGracePeriodSeconds: 0
      initContainers:
      - name: busybox
        image: "busybox:1.35.0"
        imagePullPolicy: IfNotPresent
        resources:
          requests:
            cpu: 0.1
            memory: 256Mi
        command: ["sh", "-c"]
        args:
        - |
          mkdir binaries;
          busybox --install -s binaries;
          cp binaries/* /tmp/binaries;
          cp /bin/busybox /tmp/binaries;
        volumeMounts:
        - name: binaries
          mountPath: /tmp/binaries
      containers:
      - name: "pulsar"
        
        image: "streamnative/sn-platform-slim:2.10.4.1"
        imagePullPolicy: IfNotPresent
        resources:
          requests:
            cpu: 0.1
            memory: 256Mi
        command: ["sh", "-c"]
        args:
        - >
          bin/apply-config-from-env.py conf/client.conf;
          bin/apply-config-from-env.py conf/bookkeeper.conf;
          
          echo "Configuring pulsarctl context ...";
          mkdir -p /root/.config/pulsar;
          cp /pulsar/conf/pulsarctl.config /root/.config/pulsar/config;
          echo "Successfully configured pulsarctl context.";
          sleep 10000000000
        envFrom:
        - configMapRef:
            name: "pulsar-a-sn-platform-slim-toolset"
        env:
        volumeMounts:
        - name: binaries
          mountPath: /bin/busybox
          subPath: busybox
        - name: binaries
          mountPath: /bin/vi
          subPath: vi
        
        
        - mountPath: "/pulsar/tokens"
          name: client-token
          readOnly: true
        - name: "pulsar-a-sn-platform-slim-toolset-log4j2"
          mountPath: "/pulsar/conf/log4j2.yaml"
          subPath: log4j2.yaml
        - name: "pulsar-a-sn-platform-slim-toolset-pulsarctl"
          mountPath: "/pulsar/conf/pulsarctl.config"
          subPath: pulsarctl.config
        volumeMounts:
        
        
        - mountPath: "/pulsar/tokens"
          name: client-token
          readOnly: true
      volumes:
      - name: binaries
        emptyDir: {}
      
      
      - name: client-token
        secret:
          secretName: "pulsar-a-token-admin"
          items:
            - key: TOKEN
              path: client/token
      - name: "pulsar-a-sn-platform-slim-toolset-log4j2"
        configMap:
          name: "pulsar-a-sn-platform-slim-toolset"
      - name: "pulsar-a-sn-platform-slim-toolset-pulsarctl"
        configMap:
          name: "pulsar-a-sn-platform-slim-toolset"
      securityContext:
        runAsUser: 0
      serviceAccountName: pulsar-a-sn-platform-slim-toolset-acct
---
# Source: sn-platform-slim/templates/streamnative-console/streamnative-console-initialize.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: batch/v1
kind: Job
metadata:
  name: "pulsar-a-sn-platform-slim-streamnative-console-init"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: streamnative-console
spec:
  template:
    metadata:
      labels:
        app: sn-platform-slim
        release: pulsar-a
        cluster: pulsar-a-sn-platform-slim
    spec:
      initContainers:
        # This init container will wait for broker to be ready before
        # deploying the pulsar manager init job
        - name: wait-broker-ready
          image: "streamnative/sn-platform-slim:2.10.4.1"
          imagePullPolicy: IfNotPresent
          command: ["sh", "-c"]
          args:
            - >
              set -e; while [ "$(curl -s -o /dev/null -w '%{http_code}' http://pulsar-a-sn-platform-slim-broker:8080/status.html)" -ne "200" ]; do echo "pulsar cluster isn't initialized yet..."; sleep 5; done;
              echo "broker cluster is ready";
          resources:
            limits: {}
            requests:
              cpu: 0.1
              memory: 250Mi
      containers:
      - name: "pulsar-a-sn-platform-slim-streamnative-console-init"
        image: "streamnative/private-cloud-console:v2.1.1"
        imagePullPolicy: IfNotPresent
        env:
        - name: SPRING_CONFIGURATION_FILE
          value: /pulsar-manager/pulsar-manager/application.properties
        - name: DEFAULT_ORGANIZATION
          value: streamnative
        - name: INSTANCE_NAME
          value: pulsar
        - name: WEB_SERVICE_URL
          value: http://pulsar-a-sn-platform-slim-broker.k8s-01.svc.cluster.local:8080
        - name: KOP_SERVICE_URL
          value: pulsar-a-sn-platform-slim-broker.k8s-01.svc.cluster.local:9092
        - name: STREAMNATIVE_CONSOLE_BACKEND_URL
          value: http://pulsar-a-sn-platform-slim-streamnative-console:8850
        volumeMounts:
        - name: "pulsar-a-sn-platform-slim-streamnative-console-init"
          mountPath: "/root/init_instance/"
        command: ["sh", "-c"]
        args:
          - >
            python3 /root/init_instance/init_instance.py 2>/dev/null;
            until [ $? -eq 0 ]; do
              echo "streamnative console is not ready now! wait another 10s~";
              sleep 10;
              python3 /root/init_instance/init_instance.py 2>/dev/null;
            done;
            echo "StreamNative Console is ready to use~";
            curl -sf -XPOST http://127.0.0.1:15020/quitquitquit || true;
      restartPolicy: Never
      serviceAccountName: pulsar-a-sn-platform-slim-streamnative-console-acct
      volumes:
        - name: "pulsar-a-sn-platform-slim-streamnative-console-init"
          configMap:
            name: "pulsar-a-sn-platform-slim-streamnative-console-init"
---
# Source: sn-platform-slim/templates/control-center/control-center-ingress.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: "pulsar-a-sn-platform-slim-control-center-ingress"
  namespace: k8s-01
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
  annotations:
    ingress.kubernetes.io/ssl-redirect: "false"
    kubernetes.io/ingress.class: nginx
spec:
  rules:
    - http:
        paths:
          - path: /grafana
            pathType: ImplementationSpecific
            backend:
              service:
                name: "pulsar-a-sn-platform-slim-grafana"
                port:
                  number: 3000
          - path: /
            pathType: ImplementationSpecific
            backend:
              service:
                name: "pulsar-a-sn-platform-slim-streamnative-console"
                port: 
                  number: 9527
---
# Source: sn-platform-slim/templates/alert-manager/alertmanager-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/alert-manager/alertmanager-deployment.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/alert-manager/alertmanager-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/bookkeeper/bookkeeper-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/bookkeeper/bookkeeper-role-binding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/bookkeeper/bookkeeper-storageclass.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/broker/broker-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/broker/broker-configmap-functionmesh.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/broker/broker-role-binding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/broker/broker-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/control-center/control-center-gateway.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/control-center/control-center-virtualservice.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/control-center/ingress-controller-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/control-center/ingress-controller-deployment.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/control-center/ingress-controller-rbac.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/control-center/ingress-controller-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/detector/pulsar-detector-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/external-dns/external-dns-rbac.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/external-dns/external-dns.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/extra.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/function-worker/function-worker-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/function-worker/function-worker-cluster-role-binding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/function-worker/function-worker-role-binding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/function-worker/function-worker-service-account.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/function-worker/function-worker-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/function-worker/function-worker-statefulset.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/grafana/grafana-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/grafana/grafana-azuread-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/grafana/grafana-deployment.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/grafana/grafana-storageclass.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/istio/default-peerauthentication.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/namespace.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/node-exporter/node-exporter.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/openshift/scc-role.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/openshift/scc-rolebinding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/openshift/scc.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/prometheus/prometheus-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/prometheus/prometheus-storageclass.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/proxy/proxy-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/proxy/proxy-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/pulsar-coordinator/pulsar-coordinator.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/streamnative-console/streamnative-console-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/streamnative-console/streamnative-console-azure-oauth2-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/streamnative-console/streamnative-console-google-oauth2-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/streamnative-console/streamnative-console-okta-oauth2-secret.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/streamnative-console/streamnative-console-storageclass.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/tls/istio/tls-cert-internal-issuer.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/tls/istio/tls-cert-public-issuer.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/tls/istio/tls-certs.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/tls/keytool.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

# script to process key/cert to keystore and truststore
---
# Source: sn-platform-slim/templates/tls/tls-cert-internal-issuer.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/tls/tls-cert-public-issuer.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/tls/tls-certs-internal.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/tls/tls-certs-public.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/zookeeper/zookeeper-authorizationpolicy.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/zookeeper/zookeeper-backup-clusterrolebinding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/zookeeper/zookeeper-backup-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

# deploy zookeeper only when `zookeeper.customTools.backup.enable` is true
---
# Source: sn-platform-slim/templates/zookeeper/zookeeper-backup-rolebinding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/zookeeper/zookeeper-backup-service.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

# deploy zookeeper only when `zookeeper.customTools.backup.enable` is true
---
# Source: sn-platform-slim/templates/zookeeper/zookeeper-backup-statefulset.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

# deploy zookeeper only when `zookeeper.customTools.backup.enable` is true
---
# Source: sn-platform-slim/templates/zookeeper/zookeeper-restore-clusterrolebinding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/zookeeper/zookeeper-restore-configmap.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

# deploy zookeeper only when `zookeeper.customTools.restore.enable` is true
---
# Source: sn-platform-slim/templates/zookeeper/zookeeper-restore-rolebinding.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
---
# Source: sn-platform-slim/templates/zookeeper/zookeeper-storageclass.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

# deploy zookeeper only when `components.zookeeper` is true

# define the storage class for data directory
---
# Source: sn-platform-slim/templates/zookeeper/zookeeper-storageclass.yaml
# define the storage class for dataLog directory
---
# Source: sn-platform-slim/templates/bookkeeper/bookkeeper-cluster.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
# deploy BookKeeperCluster only when `components.bookkeeper and operator.enabled` is true
apiVersion: bookkeeper.streamnative.io/v1alpha1
kind: BookKeeperCluster
metadata:
  name: "pulsar-a-sn-platform-slim-bookie"
  namespace: k8s-01
  annotations:
    "cloud.streamnative.io/enable-config-prefix": "false"
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: bookie
spec:
  zkServers: "pulsar-a-sn-platform-slim-zookeeper:2181"
  replicas: 3
  image: "streamnative/sn-platform-slim:2.10.4.1"
  imagePullPolicy: IfNotPresent
  pod:
    serviceAccountName: pulsar-a-sn-platform-slim-bookie-acct
    labels:
      app: sn-platform-slim
      release: pulsar-a
      cluster: pulsar-a-sn-platform-slim
      component: bookie
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8000"
      
    affinity:      
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: "app"
                    operator: In
                    values:
                      - "sn-platform-slim"
                  - key: "release"
                    operator: In
                    values:
                      - pulsar-a
                  - key: "component"
                    operator: In
                    values:
                      - bookie
              topologyKey: "kubernetes.io/hostname"
            
          
      
    resources:
      requests:
        cpu: "0.2"
        memory: 512Mi
    securityContext:
      runAsNonRoot: true
    terminationGracePeriodSeconds: 30
    jvmOptions:
      memoryOptions:
      - |
        -Xms128m -Xmx256m -XX:MaxDirectMemorySize=256m
      gcOptions:
      - |
        -XX:+UseG1GC -XX:MaxGCPauseMillis=10 -XX:+ParallelRefProcEnabled -XX:+UnlockExperimentalVMOptions -XX:+AggressiveOpts -XX:+DoEscapeAnalysis -XX:ParallelGCThreads=4 -XX:ConcGCThreads=4 -XX:G1NewSizePercent=50 -XX:+DisableExplicitGC -XX:-ResizePLAB -XX:+ExitOnOutOfMemoryError -XX:+PerfDisableSharedMem -verbosegc
  storage:
    journal:
      numVolumes: 1
      numDirsPerVolume: 1
      volumeClaimTemplate:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 10Gi
        
    ledger:
      numVolumes: 1
      numDirsPerVolume: 1
      volumeClaimTemplate:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 50Gi
        
    reclaimPolicy: Delete
  config:
    custom:
      zkLedgersRootPath: "/ledgers"
      # enable bookkeeper http server
      httpServerEnabled: "true"
      httpServerPort: "8000"
      # config the stats provider
      statsProviderClass: org.apache.bookkeeper.stats.prometheus.PrometheusMetricsProvider
      # use hostname as the bookie id
      useHostNameAsBookieID: "true"
      # disable auto recovery on bookies since we will start AutoRecovery in separated pods
      autoRecoveryDaemonEnabled: "false"
      # Do not retain journal files as it increase the disk utilization
      journalMaxBackups: "0"
      
      log4j2.yaml: |
        #
        # Licensed to the Apache Software Foundation (ASF) under one
        # or more contributor license agreements.  See the NOTICE file
        # distributed with this work for additional information
        # regarding copyright ownership.  The ASF licenses this file
        # to you under the Apache License, Version 2.0 (the
        # "License"); you may not use this file except in compliance
        # with the License.  You may obtain a copy of the License at
        #
        #   http://www.apache.org/licenses/LICENSE-2.0
        #
        # Unless required by applicable law or agreed to in writing,
        # software distributed under the License is distributed on an
        # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        # KIND, either express or implied.  See the License for the
        # specific language governing permissions and limitations
        # under the License.
        #
      
      
        Configuration:
          status: INFO
          monitorInterval: 30
          name: pulsar
          packages: io.prometheus.client.log4j2
      
          Properties:
            Property:
              - name: "pulsar.log.dir"
                value: "logs"
              - name: "pulsar.log.file"
                value: "pulsar.log"
              - name: "pulsar.log.appender"
                value: "RoutingAppender"
              - name: "pulsar.log.root.level"
                value: "info"
              - name: "pulsar.log.level"
                value: "info"
              - name: "pulsar.routing.appender.default"
                value: "Console"
      
          # Example: logger-filter script
          Scripts:
            ScriptFile:
              name: filter.js
              language: JavaScript
              path: ./conf/log4j2-scripts/filter.js
              charset: UTF-8
      
          Appenders:
      
            # Console
            Console:
              name: Console
              target: SYSTEM_OUT
              PatternLayout:
                Pattern: "%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"
      
            # Rolling file appender configuration
            RollingFile:
              name: RollingFile
              fileName: "${sys:pulsar.log.dir}/${sys:pulsar.log.file}"
              filePattern: "${sys:pulsar.log.dir}/${sys:pulsar.log.file}-%d{MM-dd-yyyy}-%i.log.gz"
              immediateFlush: false
              PatternLayout:
                Pattern: "%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"
              Policies:
                TimeBasedTriggeringPolicy:
                  interval: 1
                  modulate: true
                SizeBasedTriggeringPolicy:
                  size: 1 GB
              # Delete file older than 30days
              DefaultRolloverStrategy:
                  Delete:
                    basePath: ${sys:pulsar.log.dir}
                    maxDepth: 2
                    IfFileName:
                      glob: "*/${sys:pulsar.log.file}*log.gz"
                    IfLastModified:
                      age: 30d
      
            Prometheus:
              name: Prometheus
      
            # Routing
            Routing:
              name: RoutingAppender
              Routes:
                pattern: "$${ctx:function}"
                Route:
                  -
                    Routing:
                      name: InstanceRoutingAppender
                      Routes:
                        pattern: "$${ctx:instance}"
                        Route:
                          -
                            RollingFile:
                              name: "Rolling-${ctx:function}"
                              fileName : "${sys:pulsar.log.dir}/functions/${ctx:function}/${ctx:functionname}-${ctx:instance}.log"
                              filePattern : "${sys:pulsar.log.dir}/functions/${sys:pulsar.log.file}-${ctx:instance}-%d{MM-dd-yyyy}-%i.log.gz"
                              PatternLayout:
                                Pattern: "%d{ABSOLUTE} %level{length=5} [%thread] [instance: %X{instance}] %logger{1} - %msg%n"
                              Policies:
                                TimeBasedTriggeringPolicy:
                                  interval: 1
                                  modulate: true
                                SizeBasedTriggeringPolicy:
                                  size: "20MB"
                                # Trigger every day at midnight that also scan
                                # roll-over strategy that deletes older file
                                CronTriggeringPolicy:
                                  schedule: "0 0 0 * * ?"
                              # Delete file older than 30days
                              DefaultRolloverStrategy:
                                  Delete:
                                    basePath: ${sys:pulsar.log.dir}
                                    maxDepth: 2
                                    IfFileName:
                                      glob: "*/${sys:pulsar.log.file}*log.gz"
                                    IfLastModified:
                                      age: 30d
                          - ref: "${sys:pulsar.routing.appender.default}"
                            key: "${ctx:function}"
                  - ref: "${sys:pulsar.routing.appender.default}"
                    key: "${ctx:function}"
      
          Loggers:
      
            # Default root logger configuration
            Root:
              level: "${sys:pulsar.log.root.level}"
              additivity: true
              AppenderRef:
                - ref: "${sys:pulsar.log.appender}"
                  level: "${sys:pulsar.log.level}"
                - ref: Prometheus
                  level: info
      
            Logger:
              - name: org.apache.bookkeeper.bookie.BookieShell
                level: info
                additivity: false
                AppenderRef:
                  - ref: Console
      
              - name: verbose
                level: info
                additivity: false
                AppenderRef:
                  - ref: Console
      
            # Logger to inject filter script
        #     - name: org.apache.bookkeeper.mledger.impl.ManagedLedgerImpl
        #       level: debug
        #       additivity: false
        #       AppenderRef:
        #         ref: "${sys:pulsar.log.appender}"
        #         ScriptFilter:
        #           onMatch: ACCEPT
        #           onMisMatch: DENY
        #           ScriptRef:
        #             ref: filter.js
  autoRecovery:
    replicas: 1
    pod:
      labels:
        app: sn-platform-slim
        release: pulsar-a
        cluster: pulsar-a-sn-platform-slim
        component: recovery
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
        
      securityContext:
        runAsNonRoot: true
      terminationGracePeriodSeconds: 30
      affinity:        
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: "app"
                      operator: In
                      values:
                        - "sn-platform-slim"
                    - key: "release"
                      operator: In
                      values:
                        - pulsar-a
                    - key: "component"
                      operator: In
                      values:
                        - recovery
                topologyKey: "kubernetes.io/hostname"
              
            
        
      resources:
        requests:
          cpu: "0.2"
          memory: 512Mi
      serviceAccountName: pulsar-a-sn-platform-slim-bookie-acct
      jvmOptions:
        memoryOptions:
        - -Xms128m -Xmx256m
    conf:
      zkServers: "pulsar-a-sn-platform-slim-zookeeper:2181"
      zkLedgersRootPath: "/ledgers"
      # enable bookkeeper http server
      httpServerEnabled: "true"
      httpServerPort: "8000"
      # config the stats provider
      statsProviderClass: org.apache.bookkeeper.stats.prometheus.PrometheusMetricsProvider
      # use hostname as the bookie id
      useHostNameAsBookieID: "true"
      log4j2.yaml: |
        #
        # Licensed to the Apache Software Foundation (ASF) under one
        # or more contributor license agreements.  See the NOTICE file
        # distributed with this work for additional information
        # regarding copyright ownership.  The ASF licenses this file
        # to you under the Apache License, Version 2.0 (the
        # "License"); you may not use this file except in compliance
        # with the License.  You may obtain a copy of the License at
        #
        #   http://www.apache.org/licenses/LICENSE-2.0
        #
        # Unless required by applicable law or agreed to in writing,
        # software distributed under the License is distributed on an
        # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        # KIND, either express or implied.  See the License for the
        # specific language governing permissions and limitations
        # under the License.
        #
      
      
        Configuration:
          status: INFO
          monitorInterval: 30
          name: pulsar
          packages: io.prometheus.client.log4j2
      
          Properties:
            Property:
              - name: "pulsar.log.dir"
                value: "logs"
              - name: "pulsar.log.file"
                value: "pulsar.log"
              - name: "pulsar.log.appender"
                value: "RoutingAppender"
              - name: "pulsar.log.root.level"
                value: "info"
              - name: "pulsar.log.level"
                value: "info"
              - name: "pulsar.routing.appender.default"
                value: "Console"
      
          # Example: logger-filter script
          Scripts:
            ScriptFile:
              name: filter.js
              language: JavaScript
              path: ./conf/log4j2-scripts/filter.js
              charset: UTF-8
      
          Appenders:
      
            # Console
            Console:
              name: Console
              target: SYSTEM_OUT
              PatternLayout:
                Pattern: "%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"
      
            # Rolling file appender configuration
            RollingFile:
              name: RollingFile
              fileName: "${sys:pulsar.log.dir}/${sys:pulsar.log.file}"
              filePattern: "${sys:pulsar.log.dir}/${sys:pulsar.log.file}-%d{MM-dd-yyyy}-%i.log.gz"
              immediateFlush: false
              PatternLayout:
                Pattern: "%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"
              Policies:
                TimeBasedTriggeringPolicy:
                  interval: 1
                  modulate: true
                SizeBasedTriggeringPolicy:
                  size: 1 GB
              # Delete file older than 30days
              DefaultRolloverStrategy:
                  Delete:
                    basePath: ${sys:pulsar.log.dir}
                    maxDepth: 2
                    IfFileName:
                      glob: "*/${sys:pulsar.log.file}*log.gz"
                    IfLastModified:
                      age: 30d
      
            Prometheus:
              name: Prometheus
      
            # Routing
            Routing:
              name: RoutingAppender
              Routes:
                pattern: "$${ctx:function}"
                Route:
                  -
                    Routing:
                      name: InstanceRoutingAppender
                      Routes:
                        pattern: "$${ctx:instance}"
                        Route:
                          -
                            RollingFile:
                              name: "Rolling-${ctx:function}"
                              fileName : "${sys:pulsar.log.dir}/functions/${ctx:function}/${ctx:functionname}-${ctx:instance}.log"
                              filePattern : "${sys:pulsar.log.dir}/functions/${sys:pulsar.log.file}-${ctx:instance}-%d{MM-dd-yyyy}-%i.log.gz"
                              PatternLayout:
                                Pattern: "%d{ABSOLUTE} %level{length=5} [%thread] [instance: %X{instance}] %logger{1} - %msg%n"
                              Policies:
                                TimeBasedTriggeringPolicy:
                                  interval: 1
                                  modulate: true
                                SizeBasedTriggeringPolicy:
                                  size: "20MB"
                                # Trigger every day at midnight that also scan
                                # roll-over strategy that deletes older file
                                CronTriggeringPolicy:
                                  schedule: "0 0 0 * * ?"
                              # Delete file older than 30days
                              DefaultRolloverStrategy:
                                  Delete:
                                    basePath: ${sys:pulsar.log.dir}
                                    maxDepth: 2
                                    IfFileName:
                                      glob: "*/${sys:pulsar.log.file}*log.gz"
                                    IfLastModified:
                                      age: 30d
                          - ref: "${sys:pulsar.routing.appender.default}"
                            key: "${ctx:function}"
                  - ref: "${sys:pulsar.routing.appender.default}"
                    key: "${ctx:function}"
      
          Loggers:
      
            # Default root logger configuration
            Root:
              level: "${sys:pulsar.log.root.level}"
              additivity: true
              AppenderRef:
                - ref: "${sys:pulsar.log.appender}"
                  level: "${sys:pulsar.log.level}"
                - ref: Prometheus
                  level: info
      
            Logger:
              - name: org.apache.bookkeeper.bookie.BookieShell
                level: info
                additivity: false
                AppenderRef:
                  - ref: Console
      
              - name: verbose
                level: info
                additivity: false
                AppenderRef:
                  - ref: Console
      
            # Logger to inject filter script
        #     - name: org.apache.bookkeeper.mledger.impl.ManagedLedgerImpl
        #       level: debug
        #       additivity: false
        #       AppenderRef:
        #         ref: "${sys:pulsar.log.appender}"
        #         ScriptFilter:
        #           onMatch: ACCEPT
        #           onMisMatch: DENY
        #           ScriptRef:
        #             ref: filter.js
  apiObjects:
    clientService: {}
    headlessService:
      metadata:
        name: "pulsar-a-sn-platform-slim-bookie"
    autoRecoveryHeadlessService:
      metadata:
        name: "pulsar-a-sn-platform-slim-recovery"
    bookieStatefulSet:
      metadata:
        name: "pulsar-a-sn-platform-slim-bookie"
      updatePolicy:
        - all
    autoRecoveryStatefulSet:
      metadata:
        name: "pulsar-a-sn-platform-slim-recovery"
      updatePolicy:
        - all
    configMap:
      metadata:
        name: "pulsar-a-sn-platform-slim-bookie"
    autoRecoveryConfigMap:
      metadata:
        name: "pulsar-a-sn-platform-slim-recovery"
    pdb:
      metadata:
        name: "pulsar-a-sn-platform-slim-bookie"
---
# Source: sn-platform-slim/templates/broker/broker-cluster.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
# deploy PulsarBroker only when `components.broker and operator.enabled` is true
apiVersion: pulsar.streamnative.io/v1alpha1
kind: PulsarBroker
metadata:
  # no need to add component to name here as operator will add
  name: "pulsar-a-sn-platform-slim"
  namespace: k8s-01
  annotations:
    "cloud.streamnative.io/enable-config-prefix": "false"
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: broker
spec:
  zkServers: "pulsar-a-sn-platform-slim-zookeeper:2181"
  replicas: 1
  image: "streamnative/sn-platform-slim:2.10.4.1"
  imagePullPolicy: IfNotPresent
  pod:
    serviceAccountName: pulsar-a-sn-platform-slim-broker-acct
    labels:
      app: sn-platform-slim
      release: pulsar-a
      cluster: pulsar-a-sn-platform-slim
      component: broker
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8080"
      prometheus.io/path: "/metrics/"
      
    secretRefs:
    - mountPath: /mnt/test
      secretName: pulsar-a-token-admin    
    - mountPath: /mnt/secrets
      secretName: pulsar-a-token-asymmetric-key
    affinity:      
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: "app"
                    operator: In
                    values:
                      - "sn-platform-slim"
                  - key: "release"
                    operator: In
                    values:
                      - pulsar-a
                  - key: "component"
                    operator: In
                    values:
                      - broker
              topologyKey: "kubernetes.io/hostname"
            
          
      
    vars:    
    - name: brokerClientAuthenticationParameters
      valueFrom:
          secretKeyRef:
            name: pulsar-a-token-admin
            key: TOKEN
    - name: tokenPublicKey
      value: "file:///mnt/secrets/PUBLICKEY"
    resources:
      limits: {}
      requests:
        cpu: "0.2"
        memory: 512Mi
    securityContext:
      runAsNonRoot: true
    terminationGracePeriodSeconds: 30
    jvmOptions:
      memoryOptions:
      - |
        -Xms128m -Xmx256m -XX:MaxDirectMemorySize=256m
      gcOptions:
      - |
        -XX:+UseG1GC -XX:MaxGCPauseMillis=10 -Dio.netty.leakDetectionLevel=disabled -Dio.netty.recycler.linkCapacity=1024 -XX:+ParallelRefProcEnabled -XX:+UnlockExperimentalVMOptions -XX:+AggressiveOpts -XX:+DoEscapeAnalysis -XX:ParallelGCThreads=4 -XX:ConcGCThreads=4 -XX:G1NewSizePercent=50 -XX:+DisableExplicitGC -XX:-ResizePLAB -XX:+ExitOnOutOfMemoryError -XX:+PerfDisableSharedMem
  config:
    usePodIPAsAdvertisedAddress: false
    protocolHandlers:
      kop:
        enabled: true
    custom:
      PULSAR_PREFIX_additionalServletDirectory: "./brokerAdditionalServlet"
      PULSAR_PREFIX_systemTopicEnabled: "true"
      PULSAR_PREFIX_topicLevelPoliciesEnabled: "true"
      managedLedgerDefaultAckQuorum: "2"
      managedLedgerDefaultEnsembleSize: "3"
      managedLedgerDefaultWriteQuorum: "3"
      authenticationEnabled: "true"
      authenticateOriginalAuthData: "true"
      authenticationProviders: "org.apache.pulsar.broker.authentication.AuthenticationProviderToken"      
      brokerClientAuthenticationPlugin: "org.apache.pulsar.client.impl.auth.AuthenticationToken"
      superUserRoles: "admin,proxy-admin,broker-admin,admin-approle,pulsar-manager-admin"      
      authorizationEnabled: "true"
      authorizationProvider: "org.apache.pulsar.broker.authorization.PulsarAuthorizationProvider"
      PULSAR_PREFIX_kafkaTransactionCoordinatorEnabled: "true"
      ## Offloading settings
  initJobPod:
    resources:
          limits: {}
          requests:
            cpu: "0.2"
            memory: 512Mi
---
# Source: sn-platform-slim/templates/proxy/proxy-cluster.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
# deploy PulsarProxy only when `components.proxy and operator.enabled` is true
apiVersion: pulsar.streamnative.io/v1alpha1
kind: PulsarProxy
metadata:
  # no need to append component name to pod name here as operator will add
  name: "pulsar-a-sn-platform-slim"
  namespace: k8s-01
  annotations:
    "cloud.streamnative.io/enable-config-prefix": "false"
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: proxy
spec:
  brokerAddress: pulsar-a-sn-platform-slim-broker
  replicas: 1
  image: "streamnative/sn-platform-slim:2.10.4.1"
  imagePullPolicy: IfNotPresent
  pod:
    serviceAccountName: pulsar-a-sn-platform-slim-proxy-acct
    labels:
      app: sn-platform-slim
      release: pulsar-a
      cluster: pulsar-a-sn-platform-slim
      component: proxy
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8080"
    secretRefs:    
    - mountPath: /mnt/secrets
      secretName: pulsar-a-token-asymmetric-key
    affinity:      
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: "app"
                    operator: In
                    values:
                      - "sn-platform-slim"
                  - key: "release"
                    operator: In
                    values:
                      - pulsar-a
                  - key: "component"
                    operator: In
                    values:
                      - proxy
              topologyKey: "kubernetes.io/hostname"
            
          
      
    vars:    
    - name: brokerClientAuthenticationParameters
      valueFrom:
          secretKeyRef:
            name: pulsar-a-token-admin
            key: TOKEN
    - name: tokenPublicKey
      value: "file:///mnt/secrets/PUBLICKEY"
    resources:
      requests:
        cpu: "0.2"
        memory: 128Mi
    securityContext:
      runAsNonRoot: true
    terminationGracePeriodSeconds: 30
    jvmOptions:
      memoryOptions:
      - |
        -Xms64m -Xmx64m -XX:MaxDirectMemorySize=64m
      gcOptions:
      - |
        -XX:+UseG1GC -XX:MaxGCPauseMillis=10 -Dio.netty.leakDetectionLevel=disabled -Dio.netty.recycler.linkCapacity=1024 -XX:+ParallelRefProcEnabled -XX:+UnlockExperimentalVMOptions -XX:+AggressiveOpts -XX:+DoEscapeAnalysis -XX:ParallelGCThreads=4 -XX:ConcGCThreads=4 -XX:G1NewSizePercent=50 -XX:+DisableExplicitGC -XX:-ResizePLAB -XX:+ExitOnOutOfMemoryError -XX:+PerfDisableSharedMem
  config:
    usePodIPAsAdvertisedAddress: false
    tls:
      enabled: false
    custom:
      authenticationEnabled: "true"
      authenticateOriginalAuthData: "true"
      forwardAuthorizationCredentials: "true"
      authenticationProviders: "org.apache.pulsar.broker.authentication.AuthenticationProviderToken"      
      brokerClientAuthenticationPlugin: "org.apache.pulsar.client.impl.auth.AuthenticationToken"
      superUserRoles: "admin,proxy-admin,admin-approle,pulsar-manager-admin"
  dnsNames:
    []
  issuerRef:
    name: ""
  
  apiObjects:
    externalService:
      {}
---
# Source: sn-platform-slim/templates/zookeeper/zookeeper-cluster.yaml
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#
# deploy zookeeper only when `components.zookeeper` is true
apiVersion: zookeeper.streamnative.io/v1alpha1
kind: ZooKeeperCluster
metadata:
  name: "pulsar-a-sn-platform-slim-zookeeper"
  namespace: k8s-01
  annotations:
    "cloud.streamnative.io/ignore-leader-check": "true"
    "cloud.streamnative.io/cluster-force-update": "true"
  labels:
    app: sn-platform-slim
    chart: sn-platform-slim-1.10.0
    release: pulsar-a
    heritage: Helm
    cluster: pulsar-a-sn-platform-slim
    component: zookeeper
spec:
  replicas: 3
  image: "streamnative/sn-platform-slim:2.10.4.1"
  pod:
    serviceAccountName: pulsar-a-sn-platform-slim-zookeeper-acct
    labels:
      app: sn-platform-slim
      release: pulsar-a
      cluster: pulsar-a-sn-platform-slim
      component: zookeeper
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8000"
      
    affinity:      
      podAntiAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                  - key: "app"
                    operator: In
                    values:
                      - "sn-platform-slim"
                  - key: "release"
                    operator: In
                    values:
                      - pulsar-a
                  - key: "component"
                    operator: In
                    values:
                      - zookeeper
              topologyKey: "kubernetes.io/hostname"
            
          
      
    resources:
      limits: {}
      requests:
        cpu: "0.1"
        memory: 256Mi
    securityContext:
      runAsNonRoot: true
    terminationGracePeriodSeconds: 30
    jvmOptions:
      memoryOptions:
      - |
        -Xms64m -Xmx128m
      gcOptions:
      - |
        -XX:+UseG1GC -XX:MaxGCPauseMillis=10 -Dcom.sun.management.jmxremote -Djute.maxbuffer=10485760 -XX:+ParallelRefProcEnabled -XX:+UnlockExperimentalVMOptions -XX:+AggressiveOpts -XX:+DoEscapeAnalysis -XX:+DisableExplicitGC -XX:+PerfDisableSharedMem -Dzookeeper.forceSync=no
  persistence:
    data:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: 50Gi
      
    dataLog:
      accessModes:
        - ReadWriteOnce
      resources:
        requests:
          storage: "0"
      
    reclaimPolicy: Delete
  config:
    serverCnxnFactory: org.apache.zookeeper.server.NettyServerCnxnFactory
    # copy from configmap
    custom:
      # enable zookeeper tls
      PULSAR_PREFIX_peerType: participant
      # Include log configuration file, If you want to configure the log level and other configuration
      # items, you can modify the configmap, and eventually it will overwrite the log4j2.yaml file under conf
      log4j2.yaml: |
        #
        # Licensed to the Apache Software Foundation (ASF) under one
        # or more contributor license agreements.  See the NOTICE file
        # distributed with this work for additional information
        # regarding copyright ownership.  The ASF licenses this file
        # to you under the Apache License, Version 2.0 (the
        # "License"); you may not use this file except in compliance
        # with the License.  You may obtain a copy of the License at
        #
        #   http://www.apache.org/licenses/LICENSE-2.0
        #
        # Unless required by applicable law or agreed to in writing,
        # software distributed under the License is distributed on an
        # "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
        # KIND, either express or implied.  See the License for the
        # specific language governing permissions and limitations
        # under the License.
        #
      
      
        Configuration:
          status: INFO
          monitorInterval: 30
          name: pulsar
          packages: io.prometheus.client.log4j2
      
          Properties:
            Property:
              - name: "pulsar.log.dir"
                value: "logs"
              - name: "pulsar.log.file"
                value: "pulsar.log"
              - name: "pulsar.log.appender"
                value: "RoutingAppender"
              - name: "pulsar.log.root.level"
                value: "info"
              - name: "pulsar.log.level"
                value: "info"
              - name: "pulsar.routing.appender.default"
                value: "Console"
      
          # Example: logger-filter script
          Scripts:
            ScriptFile:
              name: filter.js
              language: JavaScript
              path: ./conf/log4j2-scripts/filter.js
              charset: UTF-8
      
          Appenders:
      
            # Console
            Console:
              name: Console
              target: SYSTEM_OUT
              PatternLayout:
                Pattern: "%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"
      
            # Rolling file appender configuration
            RollingFile:
              name: RollingFile
              fileName: "${sys:pulsar.log.dir}/${sys:pulsar.log.file}"
              filePattern: "${sys:pulsar.log.dir}/${sys:pulsar.log.file}-%d{MM-dd-yyyy}-%i.log.gz"
              immediateFlush: false
              PatternLayout:
                Pattern: "%d{HH:mm:ss.SSS} [%t] %-5level %logger{36} - %msg%n"
              Policies:
                TimeBasedTriggeringPolicy:
                  interval: 1
                  modulate: true
                SizeBasedTriggeringPolicy:
                  size: 1 GB
              # Delete file older than 30days
              DefaultRolloverStrategy:
                  Delete:
                    basePath: ${sys:pulsar.log.dir}
                    maxDepth: 2
                    IfFileName:
                      glob: "*/${sys:pulsar.log.file}*log.gz"
                    IfLastModified:
                      age: 30d
      
            Prometheus:
              name: Prometheus
      
            # Routing
            Routing:
              name: RoutingAppender
              Routes:
                pattern: "$${ctx:function}"
                Route:
                  -
                    Routing:
                      name: InstanceRoutingAppender
                      Routes:
                        pattern: "$${ctx:instance}"
                        Route:
                          -
                            RollingFile:
                              name: "Rolling-${ctx:function}"
                              fileName : "${sys:pulsar.log.dir}/functions/${ctx:function}/${ctx:functionname}-${ctx:instance}.log"
                              filePattern : "${sys:pulsar.log.dir}/functions/${sys:pulsar.log.file}-${ctx:instance}-%d{MM-dd-yyyy}-%i.log.gz"
                              PatternLayout:
                                Pattern: "%d{ABSOLUTE} %level{length=5} [%thread] [instance: %X{instance}] %logger{1} - %msg%n"
                              Policies:
                                TimeBasedTriggeringPolicy:
                                  interval: 1
                                  modulate: true
                                SizeBasedTriggeringPolicy:
                                  size: "20MB"
                                # Trigger every day at midnight that also scan
                                # roll-over strategy that deletes older file
                                CronTriggeringPolicy:
                                  schedule: "0 0 0 * * ?"
                              # Delete file older than 30days
                              DefaultRolloverStrategy:
                                  Delete:
                                    basePath: ${sys:pulsar.log.dir}
                                    maxDepth: 2
                                    IfFileName:
                                      glob: "*/${sys:pulsar.log.file}*log.gz"
                                    IfLastModified:
                                      age: 30d
                          - ref: "${sys:pulsar.routing.appender.default}"
                            key: "${ctx:function}"
                  - ref: "${sys:pulsar.routing.appender.default}"
                    key: "${ctx:function}"
      
          Loggers:
      
            # Default root logger configuration
            Root:
              level: "${sys:pulsar.log.root.level}"
              additivity: true
              AppenderRef:
                - ref: "${sys:pulsar.log.appender}"
                  level: "${sys:pulsar.log.level}"
                - ref: Prometheus
                  level: info
      
            Logger:
              - name: org.apache.bookkeeper.bookie.BookieShell
                level: info
                additivity: false
                AppenderRef:
                  - ref: Console
      
              - name: verbose
                level: info
                additivity: false
                AppenderRef:
                  - ref: Console
      
            # Logger to inject filter script
        #     - name: org.apache.bookkeeper.mledger.impl.ManagedLedgerImpl
        #       level: debug
        #       additivity: false
        #       AppenderRef:
        #         ref: "${sys:pulsar.log.appender}"
        #         ScriptFilter:
        #           onMatch: ACCEPT
        #           onMisMatch: DENY
        #           ScriptRef:
        #             ref: filter.js
  apiObjects:
    clientService: {}
    headlessService:
      metadata:
        name: "pulsar-a-sn-platform-slim-zookeeper"
    statefulSet:
      metadata:
        name: "pulsar-a-sn-platform-slim-zookeeper"
      updatePolicy:
        - all
    configMap:
      metadata:
        name: "pulsar-a-sn-platform-slim-zookeeper"
    pdb:
      metadata:
        name: "pulsar-a-sn-platform-slim-zookeeper"
