#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

{{- if or .Values.components.pulsar_manager }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: "{{ template "pulsar.fullname" . }}-{{ .Values.pulsar_manager.component }}-configmap"
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "pulsar.standardLabels" . | nindent 4 }}
    component: {{ .Values.pulsar_manager.component }}
data:
  entrypoint.sh: |
    apk add --update openssl && rm -rf /var/cache/apk/*;
    mkdir conf;
  {{- include "pulsar.pulsar_manager.tls.settings" . | nindent 14 }}
    echo 'Starting PostGreSQL Server';
    addgroup pulsar;
    adduser --disabled-password --ingroup pulsar pulsar;
    mkdir -p /run/postgresql;
    chown -R pulsar:pulsar /run/postgresql/;
    chown -R pulsar:pulsar /data;
    chown pulsar:pulsar /pulsar-manager/init_db.sql;
    chmod 750 /data;
    su - pulsar -s /bin/sh /pulsar-manager/startup.sh;
    echo 'Starting Pulsar Manager Front end';
    nginx;
    echo 'Starting Pulsar Manager Back end';
    /pulsar-manager/pulsar-backend-entrypoint.sh;
  backend_entrypoint.sh: |
    /pulsar-manager/pulsar-manager/bin/pulsar-manager \
      --spring.datasource.initialization-mode=never \
      --spring.datasource.driver-class-name=org.postgresql.Driver \
      --spring.datasource.url=jdbc:postgresql://127.0.0.1:5432/pulsar_manager \
      --spring.datasource.username=pulsar \
      --spring.datasource.password=pulsar \
      --pagehelper.helperDialect=postgresql \
  {{- if .Values.auth.authentication.enabled }}
  {{- if eq .Values.auth.authentication.provider "jwt" }}
      --backend.jwt.token="$(cat /pulsar/tokens/broker/token)" \
  {{- if .Values.auth.authentication.jwt.usingSecretKey }}
      --jwt.broker.token.mode=SECRET \
      --jwt.broker.secret.key=file:///pulsar/keys/token/secret.key \
  {{- else }}
      --jwt.broker.token.mode=PRIVATE \
      --jwt.broker.public.key=file:///pulsar/keys/token/public.key \
      --jwt.broker.private.key=file:///pulsar/keys/token/private.key \
  {{- end }}
  {{- end }}
  {{- end }}
      --bookie.host="http://{{ template "pulsar.fullname" . }}-{{ .Values.bookkeeper.component }}:{{ .Values.bookkeeper.ports.http }}" \
      --bookie.enable=true \
  {{- if and .Values.tls.enabled .Values.tls.pulsar_manager.enabled }}
      --redirect.scheme=https \
  {{- else }}
      --redirect.scheme=http \
  {{- end}}
      --redirect.host=localhost \
      --redirect.port={{ .Values.pulsar_manager.ports.frontend }} \
      --default.environment.name={{ template "pulsar.fullname" . }} \
  {{- if and .Values.tls.enabled .Values.tls.broker.enabled }}
      --default.environment.service_url=https://{{ template "pulsar.fullname" . }}-{{ .Values.broker.component }}:{{ .Values.broker.ports.https }} \
      --tls.pulsar.admin.ca-certs=/pulsar/certs/ca/ca.crt \
  {{- else }}
      --default.environment.service_url=http://{{ template "pulsar.fullname" . }}-{{ .Values.broker.component }}:{{ .Values.broker.ports.http }} \
  {{- end}}
  {{- if and .Values.tls.enabled .Values.tls.broker.enabled }}
      --tls.enabled=true \
      --tls.keystore=/pulsar/pulsar_manager.keystore.jks \
      --tls.keystore.password="$(cat /pulsar-manager/conf/password)" \
      --tls.hostname.verifier=false \
  {{- else }}
      --tls.enabled=false \
  {{- end}}
      --pulsar.peek.message=true
{{- end }}
